/**
 * 案件情報(代理)CSV生成
 * CROSSNAVI仕様（223項目）に準拠
 */

import { generateCsv, formatTimeForCsv, calculateWorkingHours } from './utils';
import type { JobWithFacility } from '@/app/system-admin/csv-export/job-info/types';

/**
 * CROSSNAVI仕様の223項目ヘッダー
 * 主要項目のみ実データ、それ以外は空欄または固定値で出力
 */
const JOB_INFO_HEADERS = [
  // 1-10: 基本情報
  '取引先ID',              // 1. 必須 - 未対応（CROSSNAVI連携ID）
  '取引先番号',            // 2. 必須 - 未対応（TASTAS管理番号）
  '取引先案件番号',        // 3. 未対応
  '案件名称',              // 4. 必須 - Job.title
  '取引先事業所',          // 5. 必須 - Facility.facility_name
  '取引先担当窓口－担当者名', // 6. 必須 - contact_person
  '取引先担当窓口－所属',    // 7. 空欄
  '取引先担当窓口－TEL',     // 8. Facility.phone_number
  '取引先担当窓口－FAX',     // 9. 空欄
  '取引先担当窓口－E-Mail',  // 10. 空欄

  // 11-20: 取引先請求担当
  '取引先請求担当－担当者名', // 11. 法人代表者
  '取引先請求担当－所属',    // 12. 空欄
  '取引先請求担当－郵便番号', // 13. 法人郵便番号
  '取引先請求担当－住所',    // 14. 法人住所
  '取引先請求担当－TEL',     // 15. 法人電話
  '取引先請求担当－FAX',     // 16. 空欄
  '取引先請求担当－E-Mail',  // 17. 空欄
  '勤務先－名称',            // 18. 必須 - Facility.facility_name
  '勤務先－郵便番号',        // 19. 必須 - Facility.postal_code
  '勤務先－住所',            // 20. Facility.address_line

  // 21-30: 勤務先詳細・雇用情報
  '勤務先－建物',            // 21. 空欄
  '勤務先－最寄り駅',        // 22. 空欄
  '勤務先－TEL',             // 23. 必須 - Facility.phone_number
  '勤務先責任者－氏名',      // 24. 必須 - manager_name
  '勤務先責任者－TEL',       // 25. 空欄
  '勤務先責任者－携帯',      // 26. 空欄
  '勤務先責任者－E-Mail',    // 27. 空欄
  '雇用形態',                // 28. 必須 - 固定「2」（パート）
  '職種',                    // 29. 必須 - 職種コード（後日対応）
  '業務内容',                // 30. 必須 - Job.overview

  // 31-40: 勤怠・給与設定
  '受動喫煙防止措置',        // 31. Facility.smoking_measure
  '解雇の事由',              // 32. 空欄
  'Web勤怠',                 // 33. 必須 - 固定「0」
  '時刻丸め－出勤',          // 34. 必須 - 固定「1」
  '時刻丸め－退勤',          // 35. 必須 - 固定「1」
  '早出可否',                // 36. 必須 - 固定「0」
  '雇用期間',                // 37. 必須 - 固定「0」（日々雇用）
  '契約期間－開始日',        // 38. 空欄
  '契約期間－終了日',        // 39. 空欄
  '給与形態',                // 40. 必須 - 固定「0」（時給）

  // 41-50: 給与詳細
  '時給単価',                // 41. 必須 - Job.hourly_wage
  '日給単価',                // 42. 空欄
  '月給単価',                // 43. 空欄
  '交通費区分',              // 44. 必須 - 固定「1」（固定）
  '交通費－固定金額',        // 45. 必須 - Job.transportation_fee
  '交通費－上限金額',        // 46. 空欄
  '交通費－実費計算方法',    // 47. 空欄
  '労災保険区分',            // 48. 必須 - 固定「1」（あり）
  '社会保険区分',            // 49. 必須 - 固定「0」（なし）
  '雇用保険区分',            // 50. 必須 - 固定「0」（なし）

  // 51-60: 支払い・控除設定
  '支払方法',                // 51. 必須 - 固定「0」（銀行）
  '支払期間',                // 52. 必須 - 固定「0」（日払い）
  '日々課税手当1－名称',     // 53. 空欄
  '日々課税手当1－金額',     // 54. 0
  '日々課税手当2－名称',     // 55. 空欄
  '日々課税手当2－金額',     // 56. 0
  '日々課税手当3－名称',     // 57. 空欄
  '日々課税手当3－金額',     // 58. 0
  '日々課税手当4－名称',     // 59. 空欄
  '日々課税手当4－金額',     // 60. 0

  // 61-80: 手当（残り）
  '日々課税手当5－名称', '日々課税手当5－金額',   // 61-62
  '日々課税手当6－名称', '日々課税手当6－金額',   // 63-64
  '日々課税手当7－名称', '日々課税手当7－金額',   // 65-66
  '日々課税手当8－名称', '日々課税手当8－金額',   // 67-68
  '日々課税手当9－名称', '日々課税手当9－金額',   // 69-70
  '日々課税手当10－名称', '日々課税手当10－金額', // 71-72
  '日々非課税手当1－名称', '日々非課税手当1－金額', // 73-74
  '日々非課税手当2－名称', '日々非課税手当2－金額', // 75-76
  '日々非課税手当3－名称', '日々非課税手当3－金額', // 77-78
  '日々非課税手当4－名称', '日々非課税手当4－金額', // 79-80

  // 81-100: 非課税手当・期間手当
  '日々非課税手当5－名称', '日々非課税手当5－金額', // 81-82
  '日々非課税手当6－名称', '日々非課税手当6－金額', // 83-84
  '日々非課税手当7－名称', '日々非課税手当7－金額', // 85-86
  '日々非課税手当8－名称', '日々非課税手当8－金額', // 87-88
  '日々非課税手当9－名称', '日々非課税手当9－金額', // 89-90
  '日々非課税手当10－名称', '日々非課税手当10－金額', // 91-92
  '期間課税手当1－名称', '期間課税手当1－金額', // 93-94
  '期間課税手当2－名称', '期間課税手当2－金額', // 95-96
  '期間課税手当3－名称', '期間課税手当3－金額', // 97-98
  '期間課税手当4－名称', '期間課税手当4－金額', // 99-100

  // 101-120: 期間手当（残り）
  '期間課税手当5－名称', '期間課税手当5－金額',   // 101-102
  '期間課税手当6－名称', '期間課税手当6－金額',   // 103-104
  '期間課税手当7－名称', '期間課税手当7－金額',   // 105-106
  '期間課税手当8－名称', '期間課税手当8－金額',   // 107-108
  '期間課税手当9－名称', '期間課税手当9－金額',   // 109-110
  '期間課税手当10－名称', '期間課税手当10－金額', // 111-112
  '期間非課税手当1－名称', '期間非課税手当1－金額', // 113-114
  '期間非課税手当2－名称', '期間非課税手当2－金額', // 115-116
  '期間非課税手当3－名称', '期間非課税手当3－金額', // 117-118
  '期間非課税手当4－名称', '期間非課税手当4－金額', // 119-120

  // 121-140: 期間非課税手当（残り）・割増
  '期間非課税手当5－名称', '期間非課税手当5－金額',   // 121-122
  '期間非課税手当6－名称', '期間非課税手当6－金額',   // 123-124
  '期間非課税手当7－名称', '期間非課税手当7－金額',   // 125-126
  '期間非課税手当8－名称', '期間非課税手当8－金額',   // 127-128
  '期間非課税手当9－名称', '期間非課税手当9－金額',   // 129-130
  '期間非課税手当10－名称', '期間非課税手当10－金額', // 131-132
  '割増－所定外（時間外）', // 133. 空欄
  '割増－所定外（深夜）',   // 134. 空欄
  '割増－所定外（休日）',   // 135. 空欄
  '割増－45時間超',         // 136. 空欄
  '割増－60時間超',         // 137. 空欄
  '割増－法定休日',         // 138. 空欄
  '割増－法定外休日',       // 139. 空欄
  '割増－深夜',             // 140. 空欄

  // 141-160: 割増詳細・時給別
  '割増－深夜休日',           // 141. 空欄
  '割増－所定外深夜',         // 142. 空欄
  '割増－45時間超深夜',       // 143. 空欄
  '割増－60時間超深夜',       // 144. 空欄
  '時給別単価1－職種',        // 145. 空欄
  '時給別単価1－時給',        // 146. 空欄
  '時給別単価2－職種',        // 147. 空欄
  '時給別単価2－時給',        // 148. 空欄
  '時給別単価3－職種',        // 149. 空欄
  '時給別単価3－時給',        // 150. 空欄
  '時給別単価4－職種',        // 151. 空欄
  '時給別単価4－時給',        // 152. 空欄
  '時給別単価5－職種',        // 153. 空欄
  '時給別単価5－時給',        // 154. 空欄
  '時給別単価6－職種',        // 155. 空欄
  '時給別単価6－時給',        // 156. 空欄
  '時給別単価7－職種',        // 157. 空欄
  '時給別単価7－時給',        // 158. 空欄
  '時給別単価8－職種',        // 159. 空欄
  '時給別単価8－時給',        // 160. 空欄

  // 161-180: 時給別単価・控除
  '時給別単価9－職種',   // 161. 空欄
  '時給別単価9－時給',   // 162. 空欄
  '時給別単価10－職種',  // 163. 空欄
  '時給別単価10－時給',  // 164. 空欄
  '控除1－名称',         // 165. 空欄
  '控除1－金額',         // 166. 0
  '控除2－名称',         // 167. 空欄
  '控除2－金額',         // 168. 0
  '控除3－名称',         // 169. 空欄
  '控除3－金額',         // 170. 0
  '控除4－名称',         // 171. 空欄
  '控除4－金額',         // 172. 0
  '控除5－名称',         // 173. 空欄
  '控除5－金額',         // 174. 0
  '控除6－名称',         // 175. 空欄
  '控除6－金額',         // 176. 0
  '控除7－名称',         // 177. 空欄
  '控除7－金額',         // 178. 0
  '控除8－名称',         // 179. 空欄
  '控除8－金額',         // 180. 0

  // 181-200: 控除・請求関連
  '控除9－名称',         // 181. 空欄
  '控除9－金額',         // 182. 0
  '控除10－名称',        // 183. 空欄
  '控除10－金額',        // 184. 0
  '請求根拠区分',        // 185. 必須 - 固定「1」
  '請求－時給単価',      // 186. 空欄
  '請求－日給単価',      // 187. 空欄
  '請求－月給単価',      // 188. 空欄
  '紹介手数料形態',      // 189. 必須 - 固定「0」
  '紹介手数料－率',      // 190. 空欄
  '紹介手数料－金額',    // 191. 空欄
  '請求－交通費',        // 192. 空欄
  '請求－日々課税手当1－名称', '請求－日々課税手当1－金額', // 193-194
  '請求－日々課税手当2－名称', '請求－日々課税手当2－金額', // 195-196
  '請求－日々課税手当3－名称', '請求－日々課税手当3－金額', // 197-198
  '請求－日々課税手当4－名称', '請求－日々課税手当4－金額', // 199-200

  // 201-220: 請求手当・自社情報
  '請求－日々課税手当5－名称', '請求－日々課税手当5－金額',   // 201-202
  '請求－日々非課税手当1－名称', '請求－日々非課税手当1－金額', // 203-204
  '請求－日々非課税手当2－名称', '請求－日々非課税手当2－金額', // 205-206
  '請求－日々非課税手当3－名称', '請求－日々非課税手当3－金額', // 207-208
  '請求－日々非課税手当4－名称', '請求－日々非課税手当4－金額', // 209-210
  '請求－日々非課税手当5－名称', '請求－日々非課税手当5－金額', // 211-212
  '自社事業所',          // 213. 必須 - 固定「渋谷事業所」
  '自社担当窓口－担当者名', // 214. 必須 - 固定「大東 晃」
  '自社担当窓口－所属',    // 215. 空欄
  '自社担当窓口－TEL',     // 216. 空欄
  '自社担当窓口－FAX',     // 217. 空欄
  '自社担当窓口－E-Mail',  // 218. 空欄
  'プールスタッフ担当窓口－担当者名', // 219. 必須 - 固定「大東 晃」

  // 221-223: 手数料対象業務
  '求職受付手数料対象業務', // 220. 必須 - 固定「対象外」
  '求職者手数料対象業務',   // 221. 必須 - 固定「対象外」
  '備考',                   // 222. 空欄
  'メモ',                   // 223. 空欄
];

/**
 * 案件情報CSV生成
 * @param jobs JobWithFacility配列（Facility情報を含む）
 * @returns CSV文字列
 */
export function generateJobInfoCsv(jobs: JobWithFacility[]): string {
  const rows = jobs.map(job => {
    const f = job.facility;

    // 担当者名（姓 + 名）
    const contactPerson = [
      f.contact_person_last_name,
      f.contact_person_first_name,
    ].filter(Boolean).join(' ');

    // 勤務先責任者名（姓 + 名）
    const managerName = [
      f.manager_last_name,
      f.manager_first_name,
    ].filter(Boolean).join(' ');

    // 法人住所（都道府県 + 市区町村 + 番地）
    const corpAddress = [
      f.corp_prefecture,
      f.corp_city,
      f.corp_address_line,
    ].filter(Boolean).join(' ');

    // 勤務先住所（都道府県 + 市区町村 + 番地）
    const facilityAddress = [
      f.prefecture,
      f.city,
      f.address_line,
    ].filter(Boolean).join(' ');

    // 業務内容（配列を改行区切りで連結）
    const workContent = job.work_content?.join('\n') || job.overview || '';

    // break_timeを数値に変換（文字列の場合がある）
    const breakMinutes = typeof job.break_time === 'string'
      ? parseInt(job.break_time, 10) || 0
      : job.break_time || 0;

    // 実働時間計算
    const workingHours = calculateWorkingHours(
      formatTimeForCsv(job.start_time),
      formatTimeForCsv(job.end_time),
      breakMinutes
    );

    return [
      // 1-10: 基本情報
      '', // 1. 取引先ID（未対応）
      '', // 2. 取引先番号（未対応）
      '', // 3. 取引先案件番号（未対応）
      job.title, // 4. 案件名称
      f.facility_name, // 5. 取引先事業所
      contactPerson, // 6. 取引先担当窓口－担当者名
      '', // 7. 取引先担当窓口－所属
      f.phone_number || '', // 8. 取引先担当窓口－TEL
      '', // 9. 取引先担当窓口－FAX
      '', // 10. 取引先担当窓口－E-Mail

      // 11-20: 取引先請求担当
      '', // 11. 取引先請求担当－担当者名
      '', // 12. 取引先請求担当－所属
      f.corp_postal_code || '', // 13. 取引先請求担当－郵便番号
      corpAddress, // 14. 取引先請求担当－住所
      f.phone_number || '', // 15. 取引先請求担当－TEL
      '', // 16. 取引先請求担当－FAX
      '', // 17. 取引先請求担当－E-Mail
      f.facility_name, // 18. 勤務先－名称
      f.postal_code || '', // 19. 勤務先－郵便番号
      facilityAddress, // 20. 勤務先－住所

      // 21-30: 勤務先詳細・雇用情報
      '', // 21. 勤務先－建物
      '', // 22. 勤務先－最寄り駅
      f.phone_number || '', // 23. 勤務先－TEL
      managerName, // 24. 勤務先責任者－氏名
      '', // 25. 勤務先責任者－TEL
      '', // 26. 勤務先責任者－携帯
      '', // 27. 勤務先責任者－E-Mail
      '2', // 28. 雇用形態（固定: パート）
      '', // 29. 職種（後日対応）
      workContent, // 30. 業務内容

      // 31-40: 勤怠・給与設定
      f.smoking_measure || '', // 31. 受動喫煙防止措置
      '', // 32. 解雇の事由
      '0', // 33. Web勤怠（固定: 未使用）
      '1', // 34. 時刻丸め－出勤（固定: 1分単位）
      '1', // 35. 時刻丸め－退勤（固定: 1分単位）
      '0', // 36. 早出可否（固定: 不可）
      '0', // 37. 雇用期間（固定: 日々雇用）
      '', // 38. 契約期間－開始日
      '', // 39. 契約期間－終了日
      '0', // 40. 給与形態（固定: 時給）

      // 41-50: 給与詳細
      String(job.hourly_wage || 0), // 41. 時給単価
      '', // 42. 日給単価
      '', // 43. 月給単価
      '1', // 44. 交通費区分（固定: 固定）
      String(job.transportation_fee || 0), // 45. 交通費－固定金額
      '', // 46. 交通費－上限金額
      '', // 47. 交通費－実費計算方法
      '1', // 48. 労災保険区分（固定: あり）
      '0', // 49. 社会保険区分（固定: なし）
      '0', // 50. 雇用保険区分（固定: なし）

      // 51-60: 支払い・控除設定
      '0', // 51. 支払方法（固定: 銀行）
      '0', // 52. 支払期間（固定: 日払い）
      '', '0', // 53-54. 日々課税手当1
      '', '0', // 55-56. 日々課税手当2
      '', '0', // 57-58. 日々課税手当3
      '', '0', // 59-60. 日々課税手当4

      // 61-80: 手当（残り）
      '', '0', '', '0', '', '0', '', '0', '', '0', '', '0', // 61-72. 日々課税手当5-10
      '', '0', '', '0', '', '0', '', '0', // 73-80. 日々非課税手当1-4

      // 81-100: 非課税手当・期間手当
      '', '0', '', '0', '', '0', '', '0', '', '0', '', '0', // 81-92. 日々非課税手当5-10
      '', '0', '', '0', '', '0', '', '0', // 93-100. 期間課税手当1-4

      // 101-120: 期間手当（残り）
      '', '0', '', '0', '', '0', '', '0', '', '0', '', '0', // 101-112. 期間課税手当5-10
      '', '0', '', '0', '', '0', '', '0', // 113-120. 期間非課税手当1-4

      // 121-140: 期間非課税手当・割増
      '', '0', '', '0', '', '0', '', '0', '', '0', '', '0', // 121-132. 期間非課税手当5-10
      '', '', '', '', '', '', '', '', // 133-140. 割増

      // 141-160: 割増詳細・時給別
      '', '', '', '', // 141-144. 割増詳細
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', // 145-160. 時給別単価1-8

      // 161-180: 時給別単価・控除
      '', '', '', '', // 161-164. 時給別単価9-10
      '', '0', '', '0', '', '0', '', '0', '', '0', // 165-174. 控除1-5
      '', '0', '', '0', '', '0', // 175-180. 控除6-8

      // 181-200: 控除・請求関連
      '', '0', '', '0', // 181-184. 控除9-10
      '1', // 185. 請求根拠区分（固定: 1）
      '', '', '', // 186-188. 請求単価
      '0', // 189. 紹介手数料形態（固定: 0）
      '', '', '', // 190-192. 紹介手数料・請求交通費
      '', '0', '', '0', '', '0', '', '0', // 193-200. 請求手当1-4

      // 201-220: 請求手当・自社情報
      '', '0', // 201-202. 請求課税手当5
      '', '0', '', '0', '', '0', '', '0', '', '0', // 203-212. 請求非課税手当1-5
      '渋谷事業所', // 213. 自社事業所（固定）
      '大東 晃', // 214. 自社担当窓口－担当者名（固定）
      '', '', '', '', // 215-218. 自社担当窓口詳細
      '大東 晃', // 219. プールスタッフ担当窓口－担当者名（固定）

      // 220-223: 手数料対象業務
      '対象外', // 220. 求職受付手数料対象業務（固定）
      '対象外', // 221. 求職者手数料対象業務（固定）
      '', // 222. 備考
      '', // 223. メモ
    ];
  });

  return generateCsv(JOB_INFO_HEADERS, rows);
}

/**
 * ヘッダー配列を取得（テスト・検証用）
 */
export function getJobInfoHeaders(): string[] {
  return [...JOB_INFO_HEADERS];
}

/**
 * ヘッダー数を取得
 */
export function getJobInfoHeaderCount(): number {
  return JOB_INFO_HEADERS.length;
}
