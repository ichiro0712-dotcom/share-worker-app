# ワーカー新規登録フロー改装 設計書

## 概要

ワーカー新規登録フォームを改装し、登録時に必要な情報を増やしてプロフィール完成度を高める。
また、登録後のユーザー体験（PWAインストール促進・プロフィール未入力リマインド）を改善する。

---

## 1. 現状と新要件の差分

### 1.1 登録フォームのフィールド変更

| フィールド | 現状 | 新要件 | 変更内容 |
|-----------|------|--------|----------|
| メールアドレス | 登録時 | 登録時 | 変更なし |
| メールアドレス（確認） | 登録時 | 登録時 | 変更なし |
| パスワード | 登録時 | 登録時 | 変更なし |
| パスワード（確認） | 登録時 | 登録時 | 変更なし |
| 電話番号 | 登録時 | 登録時 | 変更なし |
| 利用規約同意 | 登録時 | 登録時 | 変更なし |
| プライバシーポリシー同意 | 登録時 | 登録時 | 変更なし |
| **氏名（姓・名）** | プロフィール編集 | **登録時に移動** | **追加** |
| **氏名カナ（セイ・メイ）** | プロフィール編集 | **登録時に移動** | **追加** |
| **生年月日** | プロフィール編集 | **登録時に移動** | **追加** |
| **住所（郵便番号〜番地・建物）** | プロフィール編集 | **登録時に移動** | **追加** |
| **保有資格（チェックボックス選択）** | プロフィール編集 | **登録時に移動（写真不要）** | **追加** |

### 1.2 メール認証後のリダイレクト先

| 項目 | 現状 | 新要件 |
|------|------|--------|
| 認証後リダイレクト先 | `/mypage/profile`（プロフィール編集） | **`/job-list`（求人検索TOP）** |

### 1.3 登録後の追加UX（新規）

| 機能 | 現状 | 新要件 |
|------|------|--------|
| PWAインストール促進 | なし | **モーダル + バナーで促進** |
| プロフィール未入力リマインド | 応募時にブロックのみ | **バッジ + バナーで事前通知** |

---

## 2. 登録フォーム設計

### 2.1 ステップ構成（セクション分割型）

フィールドが増えるため、2ステップに分割する。
各ステップは1ページに収まる程度の入力量に調整。

#### ステップ1: アカウント情報・基本情報

```
┌─────────────────────────────────────┐
│  新規ワーカー登録 (1/2)              │
│  ステップ1: アカウント・基本情報      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                     │
│  ── アカウント情報 ──                │
│  メールアドレス        [          ]  │
│  メールアドレス（確認） [          ]  │
│  電話番号              [          ]  │
│  パスワード            [          ]  │
│  パスワード（確認）     [          ]  │
│                                     │
│  ── 基本情報 ──                      │
│  姓 [        ]  名 [        ]       │
│  姓カナ [      ]  名カナ [      ]   │
│  生年月日 [            ]             │
│                                     │
│            [次へ]                    │
└─────────────────────────────────────┘
```

**ステップ1のフィールド:**
- メールアドレス + 確認
- 電話番号
- パスワード + 確認
- 氏名（姓・名）
- 氏名カナ（セイ・メイ） ※KatakanaInputコンポーネント使用
- 生年月日

#### ステップ2: 住所・資格・同意

```
┌─────────────────────────────────────┐
│  新規ワーカー登録 (2/2)              │
│  ステップ2: 住所・資格               │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                     │
│  ── 住所 ──                          │
│  (AddressSelectorコンポーネント)      │
│  郵便番号 → 都道府県 → 市区町村      │
│  → 番地 → 建物名                    │
│                                     │
│  ── 保有資格 ──                      │
│  ※証明書写真は後でプロフィールから    │
│  ☐ 看護師  ☐ 准看護師  ☐ ...       │
│  ☐ 介護福祉士  ☐ 初任者研修  ...    │
│  （QUALIFICATION_GROUPSと同じ形式）  │
│                                     │
│  ── 利用規約・プライバシーポリシー ── │
│  [利用規約を確認する]                │
│  ☐ 利用規約に同意します              │
│  [プライバシーポリシーを確認する]     │
│  ☐ プライバシーポリシーに同意します   │
│                                     │
│       [戻る]    [登録する]           │
└─────────────────────────────────────┘
```

**ステップ2のフィールド:**
- 住所（AddressSelectorコンポーネント使用 ※プロフィール編集と同一）
- 保有資格（QUALIFICATION_GROUPSチェックボックス ※証明書写真は不要）
- 利用規約同意（現状のモーダル表示をそのまま流用）
- プライバシーポリシー同意（同上）

### 2.2 ステップ間の状態管理

- 全フィールドを1つの`formData`ステートで管理（現状のプロフィール編集と同じパターン）
- `currentStep`ステートでステップを制御
- ステップ1→2移行時: ステップ1のバリデーションを実施（エラーがあれば遷移させない）
- ステップ2→1戻り: 入力内容は保持（state維持）
- ブラウザバック対応: `beforeunload`イベントで入力破棄の警告

### 2.3 ステップインジケーター

```
  ●━━━━━━━●
  1        2
アカウント  住所・資格
・基本情報
```

- 現在のステップを色付きで表示
- 完了したステップにはチェックマーク

---

## 3. API・バックエンド変更

### 3.1 登録API (`/api/auth/register`) の変更

現在の受け取りフィールド:
```typescript
{ email, password, phoneNumber, registrationLpId, registrationCampaignCode, registrationGenrePrefix }
```

新しい受け取りフィールド（追加分）:
```typescript
{
  // 既存
  email, password, phoneNumber,
  registrationLpId, registrationCampaignCode, registrationGenrePrefix,
  // 追加
  lastName: string,        // 姓
  firstName: string,       // 名
  lastNameKana: string,    // 姓カナ
  firstNameKana: string,   // 名カナ
  birthDate: string,       // 生年月日 (YYYY-MM-DD)
  postalCode: string,      // 郵便番号
  prefecture: string,      // 都道府県
  city: string,            // 市区町村
  addressLine: string,     // 番地
  building?: string,       // 建物名（任意）
  qualifications: string[] // 保有資格
}
```

### 3.2 DB保存の変更

`prisma.user.create` の `data` に以下を追加:
```typescript
{
  name: `${lastName} ${firstName}`,
  last_name_kana: lastNameKana,
  first_name_kana: firstNameKana,
  birth_date: new Date(birthDate + 'T00:00:00+09:00'), // JST基準
  postal_code: postalCode,
  prefecture: prefecture,
  city: city,
  address_line: addressLine,
  building: building || null,
  qualifications: qualifications,
}
```

### 3.3 メール認証後リダイレクト変更

**変更箇所:** `app/api/auth/verify/route.ts` (50行目)

```typescript
// 現状
autoLoginUrl.searchParams.set('redirect', '/mypage/profile');

// 変更後
autoLoginUrl.searchParams.set('redirect', '/job-list');
```

---

## 4. PWAインストール促進

### 4.1 動作フロー

```
メール認証完了 → 求人検索TOP → PWAインストールモーダル表示
                              ↓ 「あとで」を押した場合
                              上部バナーで継続リマインド
                              ↓ インストール検知 or 7日経過
                              バナー非表示
```

### 4.2 初回モーダル

**表示条件:**
- メール認証後の初回アクセス時
- スマートフォンからのアクセス時のみ（PC非表示）
- `localStorage`で表示済みフラグを管理

**モーダル内容:**
```
┌───────────────────────────────────┐
│  +タスタスをホーム画面に追加しよう   │
│                                   │
│  📱 ホーム画面に追加すると...       │
│  ・アプリのようにすぐ開ける        │
│  ・新着求人のお知らせが届く        │
│                                   │
│  [iOS向け手順]  or  [Android手順]  │
│  ステップ画像付き説明              │
│                                   │
│  [ホーム画面に追加]  [あとで]      │
└───────────────────────────────────┘
```

### 4.3 リマインドバナー

**表示条件:**
- モーダルで「あとで」を選択した場合
- PWA未インストール状態（`display-mode: standalone`で判定）
- 閉じても24時間後に再表示
- 7日後に自動非表示

**バナーデザイン:**
```
┌──────────────────────────────────────────┐
│ 📲 +タスタスをホーム画面に追加しよう [追加] [✕] │
└──────────────────────────────────────────┘
```
- 画面上部に固定表示（ヘッダー直下）
- 背景色: primary（indigo-500系）

### 4.4 実装ファイル

| ファイル | 新規/変更 | 内容 |
|---------|----------|------|
| `components/pwa/PWAInstallModal.tsx` | 新規 | 初回モーダル |
| `components/pwa/PWAInstallBanner.tsx` | 新規 | リマインドバナー |
| `components/layout/WorkerLayout.tsx` | 変更 | バナー組み込み |

---

## 5. プロフィール未入力リマインド

### 5.1 リマインド対象（応募に必要な未入力項目）

登録時に入力済みになるもの:
- 氏名、カナ、生年月日、住所、電話番号、資格（チェックのみ）

**応募時に追加で必要な項目（リマインド対象）:**
- 性別
- 国籍
- 緊急連絡先（氏名・電話番号）
- 現在の働き方
- 希望の働き方
- 銀行口座情報（銀行名、支店名、口座名義、口座番号）
- 通帳コピー
- 身分証明書
- 経験分野
- 資格証明書（「その他」以外）

### 5.2 通知バッジ

**表示場所:** マイページメニュー、ヘッダーのマイページアイコン

**表示内容:**
- 赤いバッジに未入力項目数を表示
- 例: マイページアイコン横に `5` と赤バッジ

### 5.3 未入力リマインドバナー

**表示条件:**
- ログイン済みのワーカー
- プロフィールに応募必須項目の未入力がある
- 求人検索TOP、求人詳細、マイページに表示

**バナーデザイン:**
```
┌──────────────────────────────────────────────────────┐
│ ⚠️ 応募に必要なプロフィールが埋まっていません        │
│    未入力: 銀行口座、身分証明書 など5項目              │
│    [プロフィールを入力する →]                          │
└──────────────────────────────────────────────────────┘
```
- PWAバナーと同じ位置（上部固定）
- PWAバナーが表示中は、その下に表示
- 背景色: amber-50（警告色）
- 閉じボタンなし（完成するまで常時表示）

### 5.4 求人詳細ページの応募ボタン周辺

**現状:** 応募ボタンを押してからブロック
**変更:** 応募ボタンの上に未入力警告を事前表示

```
┌──────────────────────────────────────┐
│ ⚠️ 応募するには以下の情報が必要です   │
│ ・銀行口座情報  ・身分証明書          │
│ ・緊急連絡先                         │
│ [プロフィールを入力する]              │
└──────────────────────────────────────┘
│        [応募する]（グレーアウト）      │
```

### 5.5 実装ファイル

| ファイル | 新規/変更 | 内容 |
|---------|----------|------|
| `components/profile/ProfileIncompleteBanner.tsx` | 新規 | リマインドバナー |
| `components/profile/ProfileBadge.tsx` | 新規 | 通知バッジ |
| `src/lib/actions/user-profile.ts` | 変更 | `getMissingProfileFields()` API追加 |
| `components/layout/WorkerLayout.tsx` | 変更 | バナー組み込み |
| 求人詳細ページ | 変更 | 応募ボタン周辺に警告表示 |

---

## 6. 変更ファイル一覧

### フロントエンド

| ファイル | 変更内容 |
|---------|---------|
| `app/register/worker/page.tsx` | **大幅改修**: 2ステップ化、フィールド追加 |
| `app/api/auth/verify/route.ts` | リダイレクト先を `/job-list` に変更 |
| `components/layout/WorkerLayout.tsx` | PWAバナー・プロフィールバナー組み込み |
| `components/pwa/PWAInstallModal.tsx` | **新規**: PWAインストールモーダル |
| `components/pwa/PWAInstallBanner.tsx` | **新規**: PWAインストールバナー |
| `components/profile/ProfileIncompleteBanner.tsx` | **新規**: プロフィール未入力バナー |
| `components/profile/ProfileBadge.tsx` | **新規**: プロフィール未入力バッジ |

### バックエンド

| ファイル | 変更内容 |
|---------|---------|
| `app/api/auth/register/route.ts` | 新フィールドの受け取り・保存 |
| `src/lib/actions/user-profile.ts` | `getMissingProfileFields()` 追加 |

### DBスキーマ

変更なし（既存のUserモデルで全フィールド対応済み）

---

## 7. プロフィール編集との整合性

### 7.1 登録時に入力 → プロフィールに反映

登録時に入力したデータは、プロフィール編集画面（`/mypage/profile`）に初期値として表示される。
プロフィール編集のフォーマット・UIコンポーネントは既存のものをそのまま再利用する。

### 7.2 再利用するコンポーネント

| コンポーネント | 用途 |
|--------------|------|
| `KatakanaInput` | カナ入力（ひらがな→カタカナ自動変換） |
| `PhoneNumberInput` | 電話番号入力（数字のみ） |
| `AddressSelector` | 住所入力（郵便番号→自動入力） |
| `QUALIFICATION_GROUPS` | 資格チェックボックス表示 |

---

## 8. バリデーションルール

### ステップ1（次へ進む時）

| フィールド | ルール |
|-----------|--------|
| メールアドレス | 必須、メール形式、確認一致 |
| 電話番号 | 必須、10〜11桁数字 |
| パスワード | 必須、8文字以上、確認一致 |
| 姓 | 必須 |
| 名 | 必須 |
| 姓カナ | 必須、カタカナのみ |
| 名カナ | 必須、カタカナのみ |
| 生年月日 | 必須 |

### ステップ2（登録時）

| フィールド | ルール |
|-----------|--------|
| 郵便番号 | 必須、7桁 |
| 都道府県 | 必須 |
| 市区町村 | 必須 |
| 番地 | 必須 |
| 建物名 | 任意 |
| 保有資格 | 必須（1つ以上選択） |
| 利用規約同意 | 必須 |
| プライバシーポリシー同意 | 必須 |

---

## 9. プロフィール編集の保存バリデーション緩和

### 9.1 現状の問題

`ProfileEditClient.tsx` の `handleSubmit` で **32項目以上を全て必須チェック**しており、
1つでも未入力があると保存ボタンが動かない。

例: 新規登録後に電話番号だけ変えたくても、銀行口座・身分証・資格証明書等が
未入力のため保存できない。

### 9.2 バリデーションの分離方針

| チェックタイミング | 厳しさ | 目的 |
|------------------|--------|------|
| **プロフィール保存時** | 緩い（フォーマットチェックのみ） | 部分的な入力でも保存できるようにする |
| **応募時** | 厳しい（全必須項目チェック） | `checkProfileComplete()` で既にブロック済み |

### 9.3 変更内容: `ProfileEditClient.tsx` handleSubmit

**変更前（全項目必須）:**
```typescript
if (!formData.lastName) errors.push('姓');
if (!formData.gender) errors.push('性別');
if (!formData.bankName) errors.push('銀行名');
if (!bankBookImage) errors.push('通帳コピー');
if (!idDocument) errors.push('身分証明書');
// ... 32項目すべて
```

**変更後（入力された項目のフォーマットチェックのみ）:**
```typescript
// 最低限のチェック: 氏名（姓 or 名どちらか入力されたら両方必須）
if ((formData.lastName || formData.firstName) && (!formData.lastName || !formData.firstName)) {
  errors.push('姓名は両方入力してください');
}

// カナのフォーマットチェック（入力されている場合のみ）
if (formData.lastNameKana && !isKatakanaOnly(formData.lastNameKana)) {
  errors.push('姓（カナ）はカタカナで入力してください');
}
if (formData.firstNameKana && !isKatakanaOnly(formData.firstNameKana)) {
  errors.push('名（カナ）はカタカナで入力してください');
}

// 口座名義のフォーマットチェック（入力されている場合のみ）
if (formData.accountName && !isKatakanaWithSpaceOnly(formData.accountName)) {
  errors.push('口座名義はカタカナで入力してください');
}

// 資格証明書: 必須チェックを削除（応募時にcheckProfileCompleteでチェック）
// 身分証明書: 必須チェックを削除（同上）
// 通帳コピー: 必須チェックを削除（同上）
// 銀行口座: 必須チェックを削除（同上）
// 経験分野: 必須チェックを削除（同上）
// 緊急連絡先: 必須チェックを削除（同上）
// 働き方: 必須チェックを削除（同上）
// 性別・国籍: 必須チェックを削除（同上）
```

### 9.4 UI変更: 必須マーク表記の変更

**変更前:** 全セクションに `*` マーク
**変更後:** `*` マークの意味を変更

```
変更前: * が付いている項目は必須です
変更後: * が付いている項目は、求人に応募する際に必要な情報です。
        プロフィールは少しずつ登録できます。
```

※この案内文は既にプロフィール編集画面の上部に存在するが（786-789行）、
バリデーションが全項目必須になっていたため機能していなかった。
今回の変更でこの案内文の通りの動作になる。

### 9.5 サーバーサイド

変更不要。`updateUserProfile()` は既に `name`, `email`, `phoneNumber` の3項目のみチェック。

### 9.6 影響範囲

| ファイル | 変更内容 |
|---------|---------|
| `app/mypage/profile/ProfileEditClient.tsx` | handleSubmitのバリデーション緩和 |

---

## 10. 実装の優先順位

1. **Phase 1**: 登録フォーム2ステップ化 + API変更 + メール認証リダイレクト変更 + プロフィール保存バリデーション緩和
2. **Phase 2**: PWAインストール促進（モーダル + バナー）
3. **Phase 3**: プロフィール未入力リマインド（バナー + バッジ + 求人詳細警告）
