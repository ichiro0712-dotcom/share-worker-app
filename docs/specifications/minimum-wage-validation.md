# 最低賃金バリデーション機能 - 要件定義書

**ステータス**: Phase 3 完了 / Phase 4 テスト待ち
**作成日**: 2026-02-05
**最終更新**: 2026-02-06

---

## 1. 機能概要

施設が求人を作成・編集する際、**都道府県ごとの最低賃金を下回る時給を設定できないようにする**機能。

### 1.1 背景・目的

- 法令遵守（最低賃金法）の担保
- 求人掲載時のコンプライアンスリスク軽減
- 施設管理者の入力ミス防止

---

## 2. 機能一覧

| No | 機能 | 対象ユーザー | 優先度 | 実装状況 |
|----|------|-------------|--------|---------|
| F-01 | 最低賃金マスタ管理（CSV一括更新） | システム管理者 | 高 | ✅ 完了 |
| F-02 | 最低賃金マスタ管理（個別編集） | システム管理者 | 中 | ✅ 完了 |
| F-03 | 適用開始日の設定 | システム管理者 | 高 | ✅ 完了 |
| F-04 | 履歴管理・バックアップ（DB） | システム管理者 | 高 | ✅ 完了 |
| F-05 | 履歴エクスポート（CSV） | システム管理者 | 中 | ✅ 完了 |
| F-06 | 求人作成時のリアルタイムバリデーション | 施設管理者 | 高 | ✅ 完了 |
| F-07 | 「最低賃金を適用」ボタン | 施設管理者 | 高 | ✅ 完了 |
| F-08 | 求人保存時のブロック | 施設管理者 | 高 | ✅ 完了 |
| F-09 | 予定登録（未来の賃金改定を事前予約） | システム管理者 | 高 | ✅ 完了 |
| F-10 | 予定取消 | システム管理者 | 中 | ✅ 完了 |
| F-11 | CSVテンプレートダウンロード | システム管理者 | 低 | ✅ 完了 |
| F-12 | CSVプレビュー（インポート前確認） | システム管理者 | 中 | ✅ 完了 |

---

## 3. 詳細仕様

### 3.1 最低賃金マスタ管理（システム管理者向け） ✅ 実装済み

#### 3.1.1 管理画面の場所

```
/system-admin/settings/minimum-wage
```

#### 3.1.2 CSVインポート仕様

**CSVフォーマット:**
```csv
都道府県,時給
北海道,1010
青森県,953
...
東京都,1163
...
沖縄県,952
```

**入力許容形式:**

| 項目 | 許容形式 | 備考 |
|------|---------|------|
| 都道府県 | `東京都` / `東京` | 省略形も許容、内部で正規化 |
| 時給 | `1163` / `1,163` / `"1,163"` | カンマあり/なし両方許容、引用符対応 |

**文字エンコーディング:**
- UTF-8、Shift-JIS（CP932）の自動判定に対応
- BOM付きUTF-8も対応

**バリデーション:**
- 部分更新を許可（47都道府県すべてを含む必要なし）
- 時給が正の整数であること
- 重複する都道府県は最後の行が優先（警告付き）
- ヘッダー行は自動検出してスキップ

**プレビュー機能:**
- ファイル選択時にパース結果をテーブルでプレビュー表示
- エラー行がある場合はエラー内容も表示
- プレビューでデータ0件の場合はインポートボタンが無効化

**テンプレートダウンロード:**
- 47都道府県名が入った空のCSVテンプレートをダウンロード可能

#### 3.1.3 適用開始日の設定と予定登録

**アーキテクチャ: Query-time Classification**
- DBに `status` カラムは持たない
- `effective_from` と現在日時の比較で active/scheduled を判定
- Cronジョブ不要、クエリ時に自動判定

**動作:**
- `適用開始日 > 現在日時` → **予定**として登録（現行データに影響なし）
- `適用開始日 ≤ 現在日時` → **即時更新**（現行データは履歴に自動バックアップ）
- 予定日到来時 → 次回クエリ時に自動昇格（`promoteScheduledWages()`）

**予定の制約:**
- 1都道府県につき予定は最大1件（新規登録時に既存予定を上書き）
- 予定の取消は未適用（`effective_from > now`）の場合のみ可能
- 予定取消はTOCTOU安全な1クエリで実装

**管理画面の表示:**

| 都道府県 | 現行時給 | 適用日 | 予定時給 | 予定開始日 | 操作 |
|----------|---------|--------|---------|-----------|------|
| 東京都 | ¥1,163 | 2025/10/01 | ¥1,200 `予定` | 2026/10/01 | [編集] [予定編集] [🗑] |
| 大阪府 | ¥1,114 | 2025/10/01 | - | - | [編集] [予定登録] |
| (未登録) | - | - | - | - | CSVで登録 |

- 予定がある行: 左ボーダー（青）で視覚的に区別
- 未登録の都道府県: 黄色背景で警告表示

**CSVインポートとの連携:**
- 適用開始日が未来 → 全件が予定として一括登録（青バナー表示）
- 適用開始日が過去/今日 → 全件が即時更新（黄バナー表示）
- 適用開始日が未入力 → 確認ダイアログ（「本日から即反映しますか？」）

#### 3.1.4 履歴管理

**DBへの自動バックアップ:**
- 新しいCSVをインポートすると、旧データは履歴テーブルに自動保存
- 保存される情報：都道府県、時給、適用開始日、適用終了日、アーカイブ日時
- 予定日到来時の自動昇格でも旧データが履歴に移動

**CSVエクスポート:**
- 現在の最低賃金をCSVでダウンロード可能（ステータス列付き: 適用中/予定）
- 履歴データもCSVでダウンロード可能

---

### 3.2 求人作成・編集時のバリデーション（施設管理者向け） ✅ 実装済み

#### 3.2.1 バリデーションの判定基準

```
施設の都道府県（facility.prefecture）に基づいて最低賃金を取得
↓
入力された時給 < 最低賃金 → エラー
```

**判定ロジック:**
- `getMinimumWageForPrefecture(prefecture)` で active な最低賃金のみ取得
- scheduled（予定）データはバリデーションに使用しない
- 施設に都道府県が未設定の場合、バリデーションはスキップ

> **注意（将来の変更可能性）:** 現状、求人フォームに勤務地の入力欄はなく、求人の住所は施設の住所が自動コピーされる（`facility.prefecture` = `job.prefecture`）。将来、求人ごとに異なる勤務地を設定する機能が追加された場合、判定基準を「求人の勤務地」に変更する必要がある。変更箇所: クライアント側（`JobForm.tsx` の useEffect）、サーバー側（`job-management.ts` の `createJobs`/`updateJob`）。

#### 3.2.2 UIの動作（時給入力フィールド）

**状態1: 入力前（初期状態）**
```
┌─────────────────────────────────────────────────────┐
│  時給 *                                              │
│  ┌─────────────────────────────────────────────────┐│
│  │                                            円  ││
│  └─────────────────────────────────────────────────┘│
│  ※ 東京都の最低賃金: 1,163円                        │
└─────────────────────────────────────────────────────┘
```
- 施設の都道府県に基づく最低賃金を**事前に表示**

**状態2: 最低賃金未満を入力してフォーカスアウト**
```
┌─────────────────────────────────────────────────────┐
│  時給 *                                              │
│  ┌─────────────────────────────────────────────────┐│
│  │ 1000                                       円  ││
│  └─────────────────────────────────────────────────┘│
│  ⚠️ 東京都の最低賃金（1,163円）を下回っています      │
│                                                     │
│  ┌──────────────────────┐                          │
│  │ 最低賃金を適用（1,163円）│ ← クリックで自動入力   │
│  └──────────────────────┘                          │
└─────────────────────────────────────────────────────┘
```
- 赤枠でエラー表示
- 「最低賃金を適用」ボタンを表示
- ボタンには具体的な金額を明記

**状態3: 「最低賃金を適用」ボタンをクリック**
```
┌─────────────────────────────────────────────────────┐
│  時給 *                                              │
│  ┌─────────────────────────────────────────────────┐│
│  │ 1163                                       円  ││
│  └─────────────────────────────────────────────────┘│
│  ※ 東京都の最低賃金: 1,163円                        │
└─────────────────────────────────────────────────────┘
```
- 時給フィールドに最低賃金を自動入力
- エラー表示が解消

#### 3.2.3 保存時のブロック

```
┌─────────────────────────────────────────────────────┐
│  ⛔ 求人を保存できません                             │
│                                                     │
│  以下の項目を修正してください：                       │
│  • 時給が東京都の最低賃金（1,163円）を下回っています  │
│                                                     │
│  ┌──────────────────────┐                          │
│  │ 最低賃金を適用（1,163円）│                        │
│  └──────────────────────┘                          │
└─────────────────────────────────────────────────────┘
```
- **完全ブロック**（例外なし）
- モーダルまたはトースト通知でエラーを表示
- 「最低賃金を適用」ボタンをここにも配置

---

## 4. データモデル ✅ 実装済み

```prisma
// 現在の最低賃金（同一都道府県に active + scheduled の最大2件）
model MinimumWage {
  id              Int       @id @default(autoincrement())
  prefecture      String                 // 都道府県（正規化済み: "東京都"形式）
  hourly_wage     Int       @map("hourly_wage")  // 時給（円）
  effective_from  DateTime  @map("effective_from") // 適用開始日
  created_at      DateTime  @default(now()) @map("created_at")
  updated_at      DateTime  @updatedAt @map("updated_at")
  updated_by_type String?   @map("updated_by_type") // 更新者種別
  updated_by_id   Int?      @map("updated_by_id")   // 更新者ID

  @@unique([prefecture, effective_from], name: "prefecture_effective_from")
  @@index([prefecture])
  @@map("minimum_wages")
}

// 最低賃金の履歴（バックアップ用）
model MinimumWageHistory {
  id              Int       @id @default(autoincrement())
  prefecture      String              // 都道府県
  hourly_wage     Int       @map("hourly_wage")  // 時給（円）
  effective_from  DateTime  @map("effective_from") // 適用開始日
  effective_to    DateTime? @map("effective_to")   // 適用終了日
  archived_at     DateTime  @default(now()) @map("archived_at")

  @@index([prefecture])
  @@map("minimum_wage_history")
}
```

**ポイント:**
- `prefecture` 単体のユニーク制約ではなく `(prefecture, effective_from)` 複合ユニーク
- これにより同一都道府県に active + scheduled の2レコードが共存可能
- `status` カラムは持たず、`effective_from` と現在日時の比較でクエリ時に判定

---

## 5. API設計 ✅ 実装済み

| エンドポイント | メソッド | 用途 | 認証 | 実装状況 |
|---------------|---------|------|------|---------|
| `/api/system-admin/minimum-wage` | GET | 最低賃金一覧取得（active+scheduled） | システム管理者 | ✅ |
| `/api/system-admin/minimum-wage` | POST | 最低賃金更新/予定登録（単体） | システム管理者 | ✅ |
| `/api/system-admin/minimum-wage` | DELETE | 予定取消 | システム管理者 | ✅ |
| `/api/system-admin/minimum-wage/import` | POST | CSVインポート | システム管理者 | ✅ |
| `/api/system-admin/minimum-wage/export` | GET | CSVエクスポート（ステータス付き） | システム管理者 | ✅ |
| `/api/system-admin/minimum-wage/history` | GET | 履歴一覧取得 | システム管理者 | ✅ |
| `/api/system-admin/minimum-wage/history/export` | GET | 履歴CSVエクスポート | システム管理者 | ✅ |
| `/api/minimum-wage/[prefecture]` | GET | 都道府県別最低賃金取得 | 施設管理者 | ❌ 未実装 |

### GET `/api/system-admin/minimum-wage` レスポンス

```json
{
  "prefectures": [
    {
      "prefecture": "北海道",
      "active": {
        "id": 1,
        "prefecture": "北海道",
        "hourlyWage": 1010,
        "effectiveFrom": "2025-10-01T00:00:00.000Z",
        "status": "active"
      },
      "scheduled": null
    },
    {
      "prefecture": "東京都",
      "active": {
        "id": 13,
        "prefecture": "東京都",
        "hourlyWage": 1163,
        "effectiveFrom": "2025-10-01T00:00:00.000Z",
        "status": "active"
      },
      "scheduled": {
        "id": 48,
        "prefecture": "東京都",
        "hourlyWage": 1200,
        "effectiveFrom": "2026-10-01T00:00:00.000Z",
        "status": "scheduled"
      }
    }
  ],
  "missingPrefectures": ["沖縄県"]
}
```

---

## 6. ファイル構成

| ファイル | 役割 |
|---------|------|
| `prisma/schema.prisma` | MinimumWage / MinimumWageHistory モデル |
| `prisma/migrations/20260206_add_scheduled_minimum_wage/migration.sql` | 複合ユニーク制約マイグレーション |
| `src/lib/actions/minimumWage.ts` | サーバーアクション（全ビジネスロジック） |
| `src/lib/prefecture-utils.ts` | CSV解析・都道府県正規化ユーティリティ |
| `app/api/system-admin/minimum-wage/route.ts` | API: GET/POST/DELETE |
| `app/api/system-admin/minimum-wage/import/route.ts` | API: CSVインポート |
| `app/api/system-admin/minimum-wage/export/route.ts` | API: CSVエクスポート |
| `app/api/system-admin/minimum-wage/history/route.ts` | API: 履歴取得 |
| `app/api/system-admin/minimum-wage/history/export/route.ts` | API: 履歴CSVエクスポート |
| `app/system-admin/settings/minimum-wage/page.tsx` | 管理画面UI |
| `components/admin/JobForm.tsx` | 求人フォーム（バリデーション未実装） |
| `src/lib/actions/job-management.ts` | 求人作成アクション（バリデーション未実装） |

---

## 7. クライアント確認事項

| No | 質問 | 選択肢 | 回答 |
|----|------|--------|------|
| Q1 | 求人の時給バリデーションは**施設の住所**と**求人の住所**のどちらを基準にしますか？ | A) 施設の住所 / B) 求人の住所 / C) 両方の高い方 | **実装: A**（※現状、求人フォームに勤務地の入力欄がなく、施設の住所が自動コピーされるため同一。将来、求人ごとに異なる勤務地を設定する機能が追加された場合は、判定基準の見直しが必要） |
| Q2 | 求人に住所が未設定の場合はどうしますか？ | A) バリデーションをスキップ / B) 施設の住所を使用 / C) エラーにする | **実装: A**（施設に都道府県が未設定の場合、バリデーションをスキップ） |
| Q3 | CSVは47都道府県すべて必須ですか？ | A) 47件すべて必須 / B) 部分更新も許可 | **実装: B** |
| Q4 | CSVのヘッダー行は必須ですか？ | A) 必須 / B) なしでも許容 | **実装: B** |
| Q5 | 未来の適用開始日を設定した場合、管理画面にはどう表示しますか？ | A) 現在値のみ表示 / B) 現在値と予定値を両方表示 | **実装: B** |
| Q6 | 過去の日付を適用開始日として設定できますか？ | A) 不可 / B) 可能（即時適用として扱う） | **実装: B** |
| Q7 | エラーメッセージの文言は問題ないですか？ | 「○○県の最低賃金（X,XXX円）を下回っています」 | **未回答** |
| Q8 | 初期データは弊社で投入しますか？ | A) 弊社で投入 / B) クライアント側で投入 | **未回答** |
| Q9 | 最低賃金変更時の通知は必要ですか？ | A) 不要 / B) システム管理者に通知 / C) 施設管理者にも通知 | **未回答** |

---

## 8. 実装スケジュール

| フェーズ | 内容 | 状況 |
|---------|------|------|
| Phase 1 | データモデル・API設計 | ✅ 完了 |
| Phase 2 | システム管理画面（CSV取込・履歴管理・予定登録） | ✅ 完了 |
| Phase 3 | 求人フォームのバリデーション実装 | ✅ 完了 |
| Phase 4 | テスト・動作確認 | ❌ 未実装 |

---

## 9. 変更履歴

| 日付 | 内容 | 担当 |
|------|------|------|
| 2026-02-05 | 初版作成 | - |
| 2026-02-06 | Phase 2実装完了: 予定登録機能、CSVプレビュー、テンプレートDL、Shift-JIS対応追加。データモデルを複合ユニーク制約に変更。API設計にDELETEエンドポイント追加。管理画面を6列テーブルに改修。 | Claude Code |
| 2026-02-06 | Phase 3実装完了: 求人フォームの最低賃金バリデーション（F-06/F-07/F-08）。判定基準は施設の都道府県（facility.prefecture）。Q1/Q2の回答を記録。将来の勤務地入力機能追加時の変更箇所を注記。 | Claude Code |
