# QRコード勤怠管理機能 - 要件定義

> **作成日**: 2026-01-15
> **最終更新**: 2026-01-15
> **ステータス**: 詳細仕様確定
> **ブランチ**: `feature/qr-attendance`
> **参照資料**: カイテクヘルプセンター仕様

---

## 1. 機能概要

ワーカーが施設に掲示されたQRコードをスキャンして出勤・退勤を記録するシステム。
打刻実績が定刻と異なる場合は「勤怠変更申請」を行い、施設側が承認する。

### 1.1 主要ユーザーと操作

| ユーザー | 主な操作 |
|---------|---------|
| **ワーカー** | QRコードスキャン/緊急時番号入力で出退勤、勤怠変更申請 |
| **施設管理者** | QRコード印刷、勤怠変更申請の承認/却下、利用明細確認 |
| **システム管理者** | 勤務実績管理、CSV出力、全体の勤怠データ管理 |

---

## 2. 現状の実装状況

### 2.1 実装済み

| コンポーネント | ファイル | 状態 |
|---------------|---------|------|
| DBスキーマ（Attendance） | `prisma/schema.prisma` | ✅ 基本完成（拡張必要） |
| QR印刷ページ（施設側） | `app/admin/attendance/page.tsx` | ⚠️ 改修必要 |
| QRスキャンページ（ワーカー側） | `app/attendance/page.tsx` | ⚠️ 大幅改修必要 |
| 出退勤記録API | `app/api/attendance/record/route.ts` | ⚠️ 改修必要 |
| 施設情報取得API | `app/api/admin/facility/route.ts` | ✅ 完成 |
| ライブラリ | `qrcode`, `html5-qrcode` | ✅ 導入済み |

### 2.2 未実装

| 項目 | 優先度 |
|------|--------|
| 勤怠変更申請（ワーカー側） | 高 |
| 勤怠承認（施設管理者側） | 高 |
| 緊急時出退勤番号 | 高 |
| 利用明細（施設管理者側） | 中 |
| 勤務実績管理（システム管理者側） | 中 |
| ワーカー向け勤怠履歴 | 低 |

---

## 3. 施設管理者向け機能

### 3.1 QRコード印刷ページ

**アクセス**: `/admin/attendance`

#### 3.1.1 表示内容

```
┌─────────────────────────────────────────────────┐
│  [+TASTASロゴ]                    [施設名]      │
├─────────────────────────────────────────────────┤
│                                                 │
│   ┌─────────────┐     出退勤方法（+TASTASアプリ）│
│   │             │     ① ログイン               │
│   │  QRコード   │     ② 仕事管理画面           │
│   │             │     ③ 出勤/退勤ボタン        │
│   └─────────────┘     ④ QRコード読取           │
│                                                 │
│   緊急時出退勤番号：XXXX                        │
│   □ 出退勤番号を印刷する                       │
│                                                 │
│   [QRコードと緊急時出退勤番号を再発行]          │
├─────────────────────────────────────────────────┤
│  下記の場合必ず勤怠変更申請が必要です           │
│  ┌──────────────────┬──────────────────┐        │
│  │ 遅刻・早退       │ QR読取：必要    │        │
│  │ 前残業・後残業   │ QR読取：必要    │        │
│  │ 読み取りエラー   │ QR読取：不要    │        │
│  │ 携帯が利用不可   │ QR読取：不要    │        │
│  │ 番号での出退勤   │ QR読取：不要    │        │
│  └──────────────────┴──────────────────┘        │
├─────────────────────────────────────────────────┤
│  +TASTASよりワーカーの皆様へ       [お問合せQR] │
│  本日はご勤務くださり...                        │
├─────────────────────────────────────────────────┤
│                  [印刷]                         │
└─────────────────────────────────────────────────┘
```

#### 3.1.2 機能

| 機能 | 説明 |
|------|------|
| QRコード表示 | 施設固有のQRコードを表示 |
| 緊急時番号表示 | 4桁の緊急時出退勤番号を表示 |
| 番号印刷トグル | 緊急時番号を印刷に含めるか選択 |
| 再発行ボタン | QRコードと緊急時番号を再発行 |
| 印刷ボタン | PDF形式で印刷 |

#### 3.1.3 QRコード仕様

- **形式**: 施設単位で固定（カイテク・タイミー同様）
- **データ**: `attendance:{facilityId}:{secretToken}`
- **再発行**: ボタンクリックで`secretToken`を更新

> **検討事項**: QRコード固定は虚偽申告リスクあり。ただし都度変更は施設負担大。
> **決定**: 施設単位で固定とし、必要に応じて再発行可能とする。

### 3.2 勤怠承認機能（タスクメニュー）

**アクセス**: `/admin/tasks/attendance`

#### 3.2.1 一覧画面

| 表示項目 | 説明 |
|---------|------|
| 詳細ボタン | 詳細画面へ遷移 |
| 案件ID | 求人に紐づく番号 |
| 応募ID | ワーカーの応募に紐づく番号 |
| 勤怠変更申請状況 | 空白（未承認）/ 承認済み / 却下済み / 再申請 |
| 申請日時 | ワーカーが申請を登録した日時 |

#### 3.2.2 詳細画面

**表示内容**:
- 定刻の出勤時間、退勤時間、休憩時間
- 実績の出勤時間、退勤時間、休憩時間
- 申請の出勤時間、退勤時間、休憩時間
- ワーカーの申請コメント

**操作**:
- 事業所管理者コメント欄（**入力必須**）
  - 承認時：一言コメント
  - 拒否時：拒否理由を記載
- 「承認する」ボタン
- 「拒否する」ボタン

#### 3.2.3 承認拒否フロー

```
ワーカー申請 → 施設が拒否 → ワーカーに通知
                          → 再申請ボタン表示
                          → 再申請後、ステータス「再申請」に
```

### 3.3 利用明細（帳票）

**アクセス**: 管理画面右上「帳票」→「利用明細」

#### 3.3.1 表示項目

| 項目 | 説明 |
|------|------|
| 案件ID | 求人ID |
| 応募ID | 応募ID |
| 日時 | 勤務日と予定時間 |
| 事業所 | 施設名 |
| ワーカー | ワーカー名 |
| 出勤時間 | 実績の出勤時刻 |
| 退勤時間 | 実績の退勤時刻 |
| 休憩時間 | 休憩時間（分） |
| 給与 | 計算された給与 |
| 交通費・手当 | 交通費等 |
| 手数料 | プラットフォーム手数料 |
| 超過 | 残業代等 |
| 合計 | 総支払額 |
| 振込状況 | 振込済 等 |

#### 3.3.2 機能

- CSVダウンロードボタン
- 年月フィルター

---

## 4. 勤怠実績の決定ロジック（重要）

### 4.1 打刻時間と実績時間の違い

| 項目 | 説明 |
|------|------|
| **打刻時間** | 実際にQRコードを読み取った/番号を入力した時刻。常に記録・保持する |
| **実績時間** | 給与計算の基準となる勤務時間。ロジックに基づいて決定される |

### 4.2 出勤実績の決定ロジック

```
出勤打刻時間 vs 定刻開始時間
├─ 打刻 ≤ 定刻 → 出勤実績 = 定刻開始時間（早く来ても定刻扱い）
└─ 打刻 > 定刻 → 遅刻扱い → 退勤時に勤怠変更申請が必須
```

| 出勤打刻 | 定刻開始 | 出勤実績 | 退勤時の処理 |
|---------|---------|---------|-------------|
| 08:50 | 09:00 | **09:00**（定刻） | 通常退勤可 |
| 09:00 | 09:00 | **09:00**（定刻） | 通常退勤可 |
| 09:05 | 09:00 | - | **勤怠変更申請必須** |

### 4.3 退勤実績の決定ロジック

#### 4.3.1 正常出勤の場合（出勤打刻 ≤ 定刻開始）

退勤時に2つのボタンが表示される：

```
┌─────────────────────────────────────┐
│  残業などを実施した場合             │
│  [退勤後、勤怠変更申請する]         │
│                                     │
│  定刻通りの勤務であった場合         │
│  [定刻で退勤する]                   │
└─────────────────────────────────────┘
```

| 選択 | 退勤実績 | 勤怠変更申請 |
|------|---------|-------------|
| 【定刻で退勤する】 | **定刻終了時間** | 不要（自動確定） |
| 【退勤後、勤怠変更申請する】 | **申請で入力した時間** | 必要（施設承認必要） |

#### 4.3.2 遅刻の場合（出勤打刻 > 定刻開始）

退勤時に「勤怠変更申請する」ボタンのみ表示：

```
┌─────────────────────────────────────┐
│  遅刻または早退が発生しています     │
│  退勤後、勤怠変更申請してください   │
│                                     │
│  [退勤後、勤怠変更申請する]         │
└─────────────────────────────────────┘
```

### 4.4 勤怠変更申請が必要なケース

| ケース | 定義 | 申請 |
|--------|------|------|
| 定刻どおり | 出勤打刻≤定刻開始 かつ 「定刻で退勤する」選択 | **不要** |
| 遅刻 | 出勤打刻 > 定刻開始 | **必須** |
| 早退 | 定刻終了時間より前に退勤したい | **必須** |
| 残業 | 定刻終了時間より後に退勤したい | **必須** |
| 緊急時番号使用 | QRではなく4桁番号で出退勤 | **必須** |

### 4.5 施設管理者による修正

- 定刻どおりで自動確定した勤怠も、施設管理画面から**修正可能**
- 認識の誤りや入力ミスに対応するため

---

## 5. ワーカー向け機能

### 5.1 出退勤リーダー

**アクセス**: 仕事管理画面 → 右上「出勤」/「退勤」ボタン

#### 5.1.1 出勤ボタン表示条件

- **勤務当日のみ**表示
- **勤務開始1時間前**からQRコード読み取り可能

#### 5.1.2 出勤フロー

```
仕事管理 → [出勤]ボタン → カメラ起動 → QRコード読取
                        → または緊急時番号入力
                        → 「仕事開始」ボタン
                        → 出勤処理完了
```

#### 5.1.3 退勤フロー（正常出勤の場合）

```
仕事管理 → [退勤]ボタン → 状況選択画面
                        → 【定刻で退勤する】または【退勤後、勤怠変更申請する】
                        → QRコード読取
                        → 退勤処理完了
```

#### 5.1.4 退勤フロー（遅刻の場合）

```
仕事管理 → [退勤]ボタン → 勤怠変更申請画面へ誘導（選択肢なし）
                        → QRコード読取
                        → 勤怠変更申請フォーム
```

**状況選択（正常出勤時）**:

| 状況 | 選択するボタン | QR読取 | 勤怠変更申請 |
|------|---------------|--------|-------------|
| 定刻どおり | 【定刻で退勤する】 | 必要 | 不要 |
| 残業した | 【退勤後、勤怠変更申請する】 | 必要 | **必要** |
| 早退したい | 【退勤後、勤怠変更申請する】 | 必要 | **必要** |

**遅刻時（選択肢なし）**:

| 状況 | 退勤処理 | 勤怠変更申請 |
|------|---------|-------------|
| 遅刻あり | QR読取後、申請画面へ | **必須** |

#### 4.1.4 出退勤リーダー画面

```
┌─────────────────────────────────────────┐
│              出退勤リーダー        [×] │
│                                         │
│  スキャンするにはQRコードをフレーム     │
│  内に合わせてください                   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  │       [カメラプレビュー]        │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  QRコードが読み取れない場合は事業       │
│  所担当者に4桁のコードを確認しては      │
│  下に入力してください                   │
│                                         │
│         ┌────────────────┐             │
│         │     0000       │             │
│         └────────────────┘             │
│                                         │
│         [  仕事開始/仕事終了  ]         │
└─────────────────────────────────────────┘
```

### 4.2 勤怠変更申請

#### 4.2.1 申請が必要なケース

| ケース | 定義 |
|--------|------|
| 遅刻 | お仕事開始時間から**1分以上**経過して出勤 |
| 早退 | お仕事終了時間より**前**に退勤 |
| 残業 | お仕事終了時間を**1分以上**超過して退勤 |
| 緊急時番号使用 | 4桁の番号を入力して出退勤 |
| その他 | 何らかの事情で勤怠にズレが発生 |

#### 4.2.2 申請フォーム

```
┌─────────────────────────────────────────┐
│  ＜           勤怠変更申請              │
├─────────────────────────────────────────┤
│  📅 01/15(水) ⏰ 09:00-18:00            │
│  訪問介護アイリス                       │
│  埼玉県春日部市                         │
│  ★短時間の〜★利用者様の〜             │
│                                         │
│  8,300円              [勤怠変更未申請]  │
├─────────────────────────────────────────┤
│  打刻時間        09:20 - 18:15          │
├─────────────────────────────────────────┤
│  勤務時間                               │
│  実際の勤務時間と休憩時間を入力         │
│                                         │
│  勤務時間 [必須]                        │
│  [ 09 ] : [ 00 ] から [ 18 ] : [ 00 ]  │
│                                         │
│  休憩時間 [必須]                        │
│  ○ 休憩時間あり  ● 休憩時間なし       │
│                                         │
│         [  差額を確認する  ]            │
└─────────────────────────────────────────┘
```

#### 4.2.3 差額確認画面

```
┌─────────────────────────────────────────┐
│         勤怠変更差額確認                │
├─────────────────────────────────────────┤
│  勤務時間    09:00-18:00                │
│  休憩時間    休憩無し                   │
├─────────────────────────────────────────┤
│  規定の給与      ¥7,500                 │
│  交通費          ¥  800                 │
│  規定額合計      ¥8,300                 │
├─────────────────────────────────────────┤
│  変更後の給与    ¥7,375                 │
│  交通費          ¥  800                 │
│  変更申請額合計  ¥8,175                 │
├─────────────────────────────────────────┤
│  差額            ¥ -125                 │
│                                         │
│  ※報酬額が5000円以上交通費除くの場合   │
│    源泉徴収所得税が控除されます         │
├─────────────────────────────────────────┤
│  コメント [必須]                        │
│  ┌─────────────────────────────────┐   │
│  │ バスに乗り遅れてしまい遅刻しま │   │
│  │ した。スタッフ様からのご依頼に │   │
│  │ て、15分残業しました。         │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ☑ 報酬の差額を確認しました            │
│                                         │
│         [  勤怠変更申請を提出する  ]    │
│         [    入力画面に戻る    ]        │
└─────────────────────────────────────────┘
```

#### 4.2.4 休憩時間のルール（法律上）

| 勤務時間 | 必要な休憩時間 |
|---------|--------------|
| 6時間以上〜8時間未満 | 45分以上 |
| 8時間以上 | 1時間以上 |

#### 4.2.5 申請ステータス

| ステータス | 説明 |
|-----------|------|
| 勤怠変更未申請 | 申請が必要だが未申請 |
| 勤怠変更申請中 | 施設が確認中 |
| 勤怠変更申請却下 | 施設が拒否、再申請可能 |
| 承認済み | 施設が承認、給与に反映 |

#### 4.2.6 再申請ルール

- **再申請回数**: **無制限**（何度でも再申請可能）
- 却下時は却下理由を確認し、修正して再申請

#### 4.2.7 通知方法

承認/却下時の通知は以下の**両方**で行う：
- **アプリ内通知**: お知らせ画面に表示
- **メール通知**: 登録メールアドレスへ送信

### 4.3 緊急時出退勤番号

#### 4.3.1 仕様

- **形式**: 4桁の数字
- **用途**: QRコードが読み取れない場合の代替手段
- **制限**: **5回連続**で誤入力すると入力欄が非表示になる
- **注意文**: 入力画面に「5回連続で誤入力すると入力欄が非表示になります」と注意文を表示
- **注意**: 番号使用時は**必ず**勤怠変更申請が必要

#### 4.3.2 フロー

```
QR読取失敗 → 4桁番号入力 → 仕事開始/終了
          → 勤怠変更申請画面へ誘導
          → 申請必須
```

### 4.4 未出勤アラート

**発動タイミング**: 勤務開始時間を**即時**過ぎた時点で発動

勤務開始時間を過ぎてもQR読み取りを行わない場合：

```
┌─────────────────────────────────────────┐
│  未出勤のお仕事があります！             │
│  早急に出勤処理を行ってください         │
│                                         │
│         [  出勤する  ]                  │
├─────────────────────────────────────────┤
│  緊急連絡先                             │
│  事業所名：カイクマDS                   │
│  事業所担当者名：介護好子               │
│  事業所緊急連絡先：〇〇〇               │
│  事業所住所：東京都大田区               │
│                                         │
│  [Google Map - 事業所様の地図]          │
│                                         │
│  キャンセルの場合                       │
│  運営事務局へお問い合わせください       │
│         [お問い合わせフォーム]          │
│                                         │
│  お仕事終了日から1週間ご連絡がない場合  │
│  一時的にアカウントが利用停止となります │
└─────────────────────────────────────────┘
```

---

## 5. システム管理者向け機能

### 5.1 勤務実績管理

**アクセス**: `/system-admin/attendance`

#### 5.1.1 フィルター

| フィルター | 種類 |
|-----------|------|
| 部分一致検索 | 求人名、施設名、ワーカー氏名、電話番号 |
| 勤務日 | カレンダー選択 |
| 勤務ステータス | 就労前 / 就労中 / 就労済 |
| 勤務実績ステータス | 未承認 / 承認済 / すべて（デフォルト：未承認） |

#### 5.1.2 表示項目

| 項目 | 説明 |
|------|------|
| 求人名 | リンクで求人ページへ |
| 施設名 | リンクで施設ページへ |
| ワーカー氏名 | リンクでワーカーページへ |
| 勤務日 | 勤務日 |
| 出退勤の打刻時間 | 実際の打刻時刻 |
| 勤務時間（定刻） | 求人票の予定時間 |
| 休憩時間（定刻） | 求人票の休憩時間 |
| 勤務時間（実績） | 承認された実績時間 |
| 休憩時間（実績） | 承認された休憩時間 |
| タグ | 遅刻 / 早退 / 残業 |
| ワーカーコメント | 勤怠変更申請時のコメント |
| 事業所責任者コメント | 勤怠承認時のコメント |

#### 5.1.3 CSV出力

- 画面右上にCSV出力ボタン
- **出力形式**: クロスナビのCSVインポート形式に合わせる

---

## 6. DBスキーマ拡張案

### 6.1 Attendanceモデル拡張

```prisma
model Attendance {
  id              Int       @id @default(autoincrement())
  user_id         Int       @map("user_id")
  facility_id     Int       @map("facility_id")
  application_id  Int?      @map("application_id")
  job_id          Int?      @map("job_id")

  // 打刻時間（実際にQR読み取り/番号入力した時刻）
  check_in_time   DateTime  @map("check_in_time")
  check_out_time  DateTime? @map("check_out_time")

  // 位置情報
  check_in_lat    Float?    @map("check_in_lat")
  check_in_lng    Float?    @map("check_in_lng")
  check_out_lat   Float?    @map("check_out_lat")
  check_out_lng   Float?    @map("check_out_lng")

  // 打刻方法
  check_in_method   String  @default("QR") @map("check_in_method")   // "QR" | "EMERGENCY_CODE"
  check_out_method  String? @map("check_out_method")  // "QR" | "EMERGENCY_CODE"

  // ステータス
  status          String    @default("CHECKED_IN") // "CHECKED_IN" | "CHECKED_OUT"

  created_at      DateTime  @default(now()) @map("created_at")
  updated_at      DateTime  @updatedAt @map("updated_at")

  // リレーション
  user            User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  facility        Facility    @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  application     Application? @relation(fields: [application_id], references: [id], onDelete: SetNull)
  job             Job?        @relation(fields: [job_id], references: [id], onDelete: SetNull)

  // 勤怠変更申請
  modificationRequest AttendanceModificationRequest?

  @@index([user_id, created_at])
  @@index([facility_id, created_at])
  @@index([application_id])
  @@map("attendances")
}
```

### 6.2 勤怠変更申請モデル（新規）

```prisma
model AttendanceModificationRequest {
  id              Int       @id @default(autoincrement())
  attendance_id   Int       @unique @map("attendance_id")

  // 申請内容
  requested_start_time  DateTime  @map("requested_start_time")
  requested_end_time    DateTime  @map("requested_end_time")
  requested_break_time  Int       @default(0) @map("requested_break_time") // 分単位
  worker_comment        String    @map("worker_comment")

  // 承認情報
  status          String    @default("PENDING") // "PENDING" | "APPROVED" | "REJECTED" | "RESUBMITTED"
  admin_comment   String?   @map("admin_comment")
  reviewed_by     Int?      @map("reviewed_by") // FacilityAdmin ID
  reviewed_at     DateTime? @map("reviewed_at")

  // 差額計算
  original_amount Int       @map("original_amount")  // 円
  requested_amount Int      @map("requested_amount") // 円

  created_at      DateTime  @default(now()) @map("created_at")
  updated_at      DateTime  @updatedAt @map("updated_at")

  attendance      Attendance @relation(fields: [attendance_id], references: [id], onDelete: Cascade)

  @@map("attendance_modification_requests")
}
```

### 6.3 施設の緊急時出退勤番号（Facilityモデル拡張）

```prisma
model Facility {
  // ... 既存フィールド ...

  // 勤怠関連
  emergency_attendance_code  String?  @map("emergency_attendance_code") // 4桁の緊急時出退勤番号
  qr_secret_token           String?  @map("qr_secret_token")           // QRコード検証用トークン
  qr_generated_at           DateTime? @map("qr_generated_at")          // QRコード生成日時

  // ... 既存リレーション ...
}
```

---

## 7. 画面一覧

### 7.1 ワーカー向け

| パス | 画面名 | 状態 | 優先度 |
|------|--------|------|--------|
| `/attendance` | 出退勤リーダー | ⚠️ 改修必要 | 高 |
| `/attendance/modify` | 勤怠変更申請 | ❌ 未実装 | 高 |
| `/mypage/applications` | 仕事管理（勤怠タブ追加） | ⚠️ 改修必要 | 高 |

### 7.2 施設管理者向け

| パス | 画面名 | 状態 | 優先度 |
|------|--------|------|--------|
| `/admin/attendance` | QR印刷 | ⚠️ 改修必要 | 高 |
| `/admin/tasks` | タスク一覧 | ❌ 未実装 | 高 |
| `/admin/tasks/attendance` | 勤怠承認 | ❌ 未実装 | 高 |
| `/admin/tasks/attendance/[id]` | 勤怠承認詳細 | ❌ 未実装 | 高 |
| `/admin/reports/usage` | 利用明細 | ❌ 未実装 | 中 |

### 7.3 システム管理者向け

| パス | 画面名 | 状態 | 優先度 |
|------|--------|------|--------|
| `/system-admin/attendance` | 勤務実績管理 | ❌ 未実装 | 中 |

---

## 8. 開発フェーズ

### フェーズ1: 基本機能（高優先度）

- [ ] 施設：QRコード再発行機能
- [ ] 施設：緊急時出退勤番号の発行・表示
- [ ] ワーカー：出退勤リーダー改修（緊急時番号対応）
- [ ] ワーカー：応募との自動紐付け
- [ ] ワーカー：退勤時の状況選択UI

### フェーズ2: 勤怠変更申請（高優先度）

- [ ] ワーカー：勤怠変更申請フォーム
- [ ] ワーカー：差額確認画面
- [ ] ワーカー：申請ステータス表示（仕事管理の勤怠タブ）
- [ ] ワーカー：未出勤アラート

### フェーズ3: 施設側承認機能（高優先度）

- [ ] 施設：タスクメニュー追加
- [ ] 施設：勤怠変更承認一覧
- [ ] 施設：勤怠変更承認詳細・承認/拒否
- [ ] ワーカー：承認拒否通知・再申請

### フェーズ4: 管理・出力機能（中優先度）

- [ ] 施設：利用明細画面
- [ ] 施設：CSV出力
- [ ] システム管理者：勤務実績管理画面
- [ ] システム管理者：CSV出力（クロスナビ形式）

### フェーズ5: 履歴・その他（低優先度）

- [ ] ワーカー：勤怠履歴画面
- [ ] 給与管理への反映（将来のVerUP）

---

## 9. 給与計算ロジック

### 9.1 計算の基本構造（3つのブロック）

給与は以下の3つのブロックに分けて計算し、最後に合算する。

| ブロック | 説明 | 倍率 |
|---------|------|------|
| ① ベース給与 | 実働時間すべてに対する基本給 | 1.0倍 |
| ② 残業手当 | 8時間超過分に対する割増 | +0.25倍 |
| ③ 深夜手当 | 22:00〜翌5:00の勤務に対する割増 | +0.25倍 |

### 9.2 倍率の適用パターン

| 時間帯 | 8時間以内 | 8時間超過 |
|--------|----------|----------|
| 通常時間帯（5:00〜22:00） | 1.0倍 | 1.25倍（残業） |
| 深夜時間帯（22:00〜翌5:00） | 1.25倍（深夜） | 1.5倍（深夜+残業） |

### 9.3 休憩時間の控除ルール（重要）

**休憩時間は最も時給が高い時間帯から優先的に控除する。**

控除優先順位:
1. 深夜残業時間（1.5倍）← 最優先で控除
2. 残業時間（1.25倍）または深夜時間（1.25倍）
3. 通常時間（1.0倍）

### 9.4 計算例

**条件**: 時給1,000円、勤務17:00〜翌9:00（拘束16時間）、休憩1時間

#### ステップ1: 時間帯の分類

| 時間帯 | 時間数 | 区分 |
|--------|--------|------|
| 17:00〜22:00 | 5時間 | 通常 |
| 22:00〜05:00 | 7時間 | 深夜 |
| 05:00〜09:00 | 4時間 | 通常 |
| **合計** | **16時間** | |

#### ステップ2: 休憩時間の控除

休憩1時間を最も時給が高い深夜残業時間から控除:
- 深夜時間: 7時間 → **6時間**（休憩1時間控除）
- 実働時間: 16時間 - 1時間 = **15時間**

#### ステップ3: 各ブロックの計算

```
① ベース給与
   実働15時間 × 1,000円 = 15,000円

② 残業手当（8時間超過分）
   15時間 - 8時間 = 7時間
   7時間 × 250円（1,000円 × 0.25） = 1,750円

③ 深夜手当（22:00〜05:00、休憩控除後）
   6時間 × 250円（1,000円 × 0.25） = 1,500円

合計: 15,000 + 1,750 + 1,500 = 18,250円
```

#### タイムライン詳細（休憩を深夜帯に取った場合）

| 時間帯 | 時間数 | 時給倍率 | 金額 |
|--------|--------|----------|------|
| 17:00〜22:00 | 5時間 | 1.0倍（通常） | 5,000円 |
| 22:00〜01:00 | 3時間 | 1.25倍（深夜のみ） | 3,750円 |
| 01:00〜05:00 | 3時間 | 1.5倍（深夜+残業） | 4,500円 |
| 05:00〜09:00 | 4時間 | 1.25倍（残業のみ） | 5,000円 |
| **合計** | **15時間** | | **18,250円** |

※ 8時間到達は01:00時点。それ以降が残業扱い。

### 9.5 計算ユーティリティ

**ファイル**: `src/lib/utils/salary-calculator.ts`

```typescript
interface SalaryCalculationInput {
  startTime: Date;      // 勤務開始時刻
  endTime: Date;        // 勤務終了時刻
  breakMinutes: number; // 休憩時間（分）
  hourlyRate: number;   // 時給
}

interface SalaryCalculationResult {
  basePay: number;         // ベース給与
  overtimePay: number;     // 残業手当
  nightPay: number;        // 深夜手当
  totalPay: number;        // 合計
  workedHours: number;     // 実働時間
  overtimeHours: number;   // 残業時間
  nightHours: number;      // 深夜時間（休憩控除後）
  breakdown: TimeBlock[];  // 時間帯別内訳
}
```

---

## 10. 注意事項・ビジネスルール

### 10.1 勤怠変更申請

- 申請が**承認されるまで**給与に反映されない
- 早期引出は申請中は不可
- 承認が翌月以降になった場合、承認された月の給与として反映

### 10.2 残業について

- **必ず事業所様と合意の上**で残業を行うこと
- ワーカーの判断で残業しても却下される可能性あり
- 残業依頼がない場合は速やかに退勤処理を行う

### 10.3 緊急時出退勤番号

- 番号使用時は**必ず**勤怠変更申請が必要
- **5回連続**で誤入力すると入力欄が非表示になる
- 入力画面に注意文を表示

### 10.4 未出勤アラート

- 勤務開始時間を**即時過ぎた時点**でアラート画面に切り替わる（QR未読み取りの場合）
- 出勤処理 or お問い合わせフォーム以外の操作が不可になる
- お仕事終了日から1週間ご連絡がない場合、一時的にアカウント利用停止

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-15 | 初版作成。現状の実装を整理。 |
| 2026-01-15 | PDF資料（TASTAS仕様書、カイテクヘルプ）を基に詳細仕様を追記。 |
| 2026-01-15 | 給与計算ロジック（セクション9）を追加。深夜・残業手当の計算方式を明記。 |
| 2026-01-15 | 未確定事項を確定：緊急時番号誤入力制限(5回)、未出勤アラート(即時)、再申請(無制限)、通知(アプリ内+メール)。 |
