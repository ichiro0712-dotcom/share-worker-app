# CSV出力機能 要件定義書

## 1. 概要

システム管理画面の左メニュー「勤怠管理」の下に「CSV出力」を追加し、CROSSNAVI連携用の各種データをCSV出力できる機能を実装する。

### 1.1 目的
- TASTASのデータをCROSSNAVI（給与計算・勤怠管理システム）にインポート可能な形式でエクスポートする
- 取引先情報、案件情報、シフト情報、スタッフ情報、勤怠情報の5種類のCSV出力に対応

### 1.2 メニュー構成
```
システム管理画面
├── ダッシュボード
├── ワーカー管理
├── 施設管理
├── 求人管理
├── 勤怠管理
├── CSV出力 ← 新規追加
│   ├── 取引先情報出力
│   ├── 案件情報(代理)出力
│   ├── 案件シフト表(代理)出力
│   ├── プールスタッフ情報出力
│   └── 勤怠情報出力
├── コンテンツ管理
└── ...
```

---

## 2. 共通仕様

### 2.1 CSVフォーマット
- 文字コード: UTF-8（BOM付き）
- 区切り文字: カンマ（,）
- 改行コード: CRLF
- ヘッダー行: 1行目に項目名を出力
- 囲み文字: ダブルクォート（"）※カンマや改行を含む場合

### 2.2 ファイル名規則
```
{機能名}_{出力日時}.csv
例: 取引先情報_20260125_143052.csv
```

### 2.3 未対応項目の扱い
- DBに存在しない項目: 空文字で出力
- 後日DB項目追加時に対応予定

### 2.4 CROSSNAVI連携に必要なマスタID
以下の項目はCROSSNAVI側のIDが必要（後日マスタ連携機能を実装予定）：
- **取引先ID**: CROSSNAVI上の取引先識別子
- **取引先番号**: TASTAS管理番号（システム管理画面から手動登録）
- **雇用契約No.**: CROSSNAVI上の契約識別子
- **職種コード**: CROSSNAVI職種マスタのコード

---

## 3. 取引先情報出力

### 3.1 画面仕様

#### 一覧表示
| 項目 | DB項目 | 備考 |
|------|--------|------|
| 登録日 | `Facility.created_at` | yyyy/mm/dd形式 |
| 法人番号 | `Facility.corporation_number` | |
| 法人名 | `Facility.corporation_name` | |
| 施設名 | `Facility.facility_name` | |

#### フィルター
- 登録日（日付範囲）
- 法人番号（部分一致）
- 法人名（部分一致）
- 施設名（部分一致）

### 3.2 CSV出力項目（28項目）

| No. | 項目 | 必須 | 型 | 最大 | DB項目/値 | 備考 |
|-----|------|:----:|------|------|-----------|------|
| 1 | 取引先番号 | 〇 | 文字 | 30 | **未定** | 後日DB追加 |
| 2 | 法人番号 | | 文字 | | `corporation_number` | |
| 3 | 法人名称 | 〇 | 文字 | | `corporation_name` | |
| 4 | 法人名称カナ | 〇 | 文字 | | **未定** | 後日DB追加 |
| 5 | 自社名称 | 〇 | 文字 | | `corporation_name` | 法人名称と同じ |
| 6 | 自社名称カナ | 〇 | 文字 | | **未定** | 法人名称カナと同じ |
| 7 | 郵便番号 | 〇 | 文字 | | `corp_postal_code` | 法人住所 |
| 8 | 都道府県 | 〇 | 文字 | | `corp_prefecture` | 法人住所 |
| 9 | 市区町村 | 〇 | 文字 | | `corp_city` | 法人住所 |
| 10 | 住所 | 〇 | 文字 | | `corp_address_line` | 法人住所 |
| 11 | 代表者名 | | 文字 | | `representative_last_name` + `representative_first_name` | 結合 |
| 12 | 代表電話番号 | 〇 | 文字 | | `phone_number` | 事業所電話と同じ |
| 13 | 代表FAX番号 | | 文字 | | **未定** | 後日DB追加 |
| 14 | URL | | 文字 | | **未定** | 後日DB追加 |
| 15 | 銀行コード | 〇 | 文字 | | **未定** | 後日DB追加 |
| 16 | 支店コード | 〇 | 文字 | | **未定** | 後日DB追加 |
| 17 | 口座番号 | 〇 | 文字 | | **未定** | 後日DB追加 |
| 18 | 口座名義人 | 〇 | 文字 | | **未定** | 後日DB追加 |
| 19 | 振込依頼人番号 | 〇 | 文字 | | **未定** | 後日DB追加 |
| 20 | 受動喫煙防止措置 | 〇 | 文字 | | `smoking_measure` | |
| 21 | 事業所番号 | 〇 | 文字 | | **未定** | 後日DB追加 |
| 22 | 事業所名称 | 〇 | 文字 | 60 | `facility_name` | |
| 23 | 郵便番号 | 〇 | 文字 | | `postal_code` | 事業所住所 |
| 24 | 都道府県／市区町村 | 〇 | 文字 | | `prefecture` + "／" + `city` | 「／」区切り |
| 25 | 住所 | 〇 | 文字 | | `address_line` | 事業所住所 |
| 26 | 電話番号 | 〇 | 文字 | | `phone_number` | 事業所 |
| 27 | 担当者氏 | 〇 | 文字 | | `contact_person_last_name` | |
| 28 | 担当者名 | 〇 | 文字 | | `contact_person_first_name` | |

---

## 4. 案件情報(代理)出力

### 4.1 画面仕様

#### 一覧表示
| 項目 | DB項目 | 備考 |
|------|--------|------|
| 登録日 | `Job.created_at` | |
| 取引先ID | **未定** | CROSSNAVI ID |
| 取引先番号 | **未定** | TASTAS管理番号 |
| 案件名称 | `Job.title` | |
| 施設名 | `Facility.facility_name` | |
| 法人名 | `Facility.corporation_name` | |

#### フィルター
- 登録日（日付範囲）
- 取引先ID（部分一致）
- 取引先番号（部分一致）
- 案件名称（部分一致）
- 施設名（部分一致）
- 法人名（部分一致）

### 4.2 CSV出力項目（223項目）

主要項目のみ記載。全項目はCROSSNAVI仕様書を参照。

| No. | 項目名 | 必須 | DB項目/固定値 | 備考 |
|-----|--------|:----:|--------------|------|
| 1 | 取引先ID | 〇 | **未定** | CROSSNAVI連携必須 |
| 2 | 取引先番号 | 〇 | **未定** | TASTAS管理番号 |
| 3 | 取引先案件番号 | | **未定** | |
| 4 | 案件名称 | 〇 | `Job.title` | |
| 5 | 取引先事業所 | 〇 | `Facility.facility_name` | |
| 6 | 取引先担当窓口－担当者名 | 〇 | `contact_person_last_name` + " " + `contact_person_first_name` | |
| 7-11 | 取引先請求担当 | 〇 | 法人情報を使用 | |
| 13 | 勤務先－名称 | 〇 | `Facility.facility_name` | |
| 14 | 勤務先－郵便番号 | 〇 | `Facility.postal_code` | |
| 15 | 勤務先－住所 | | `Facility.address_line` | |
| 18 | 勤務先－TEL | 〇 | `Facility.phone_number` | |
| 19 | 勤務先責任者－氏名 | 〇 | `manager_last_name` + " " + `manager_first_name` | |
| 23 | 雇用形態 | 〇 | **固定「2」** | パート |
| 24 | 職種 | 〇 | **要確認** | 職種マスタコード |
| 25 | 業務内容 | 〇 | `Job.overview` | 労働条件通知書に反映 |
| 28 | Web勤怠 | 〇 | **固定「0」** | 未使用 |
| 29-30 | 時刻丸め | 〇 | **固定「1」** | 1分単位 |
| 31 | 早出可否 | 〇 | **固定「0」** | 不可 |
| 32 | 雇用期間 | 〇 | **固定「0」** | 日々雇用 |
| 34 | 給与形態 | 〇 | **固定「0」** | 時給 |
| 35 | 時給単価 | 〇 | `Job.hourly_wage` | |
| 38 | 交通費区分 | 〇 | **固定「1」** | 固定 |
| 39 | 交通費－固定金額 | 〇 | `Job.transportation_fee` | |
| 42 | 労災保険区分 | 〇 | **固定「1」** | あり |
| 43 | 社会保険区分 | 〇 | **固定「0」** | なし |
| 44 | 雇用保険区分 | 〇 | **固定「0」** | なし |
| 45 | 支払方法 | 〇 | **固定「0」** | 銀行 |
| 46 | 支払期間 | 〇 | **固定「0」** | 日払い |
| 195 | 請求根拠区分 | 〇 | **固定「1」** | |
| 198 | 紹介手数料形態 | 〇 | **固定「0」** | |
| 218 | 自社事業所 | 〇 | **固定「渋谷事業所」** | 変更可能性あり |
| 219 | 自社担当窓口－担当者名 | 〇 | **固定「大東 晃」** | 変更可能性あり |
| 220 | プールスタッフ担当窓口－担当 | 〇 | **固定「大東 晃」** | 変更可能性あり |
| 221 | 求職受付手数料対象業務 | 〇 | **固定「対象外」** | |
| 222 | 求職者手数料対象業務 | 〇 | **固定「対象外」** | |

※ 52-171: 日々課税手当・非課税手当・期間手当は全て「0」
※ 172-191: 控除1-10は全て「0」

---

## 5. 案件シフト表(代理)出力

### 5.1 画面仕様

#### 一覧表示
| 項目 | DB項目 | 備考 |
|------|--------|------|
| 登録日 | `JobWorkDate.created_at` | |
| 取引先ID | **未定** | CROSSNAVI ID |
| 取引先番号 | **未定** | TASTAS管理番号 |
| 案件名称 | `Job.title` | |
| 勤務日 | `JobWorkDate.work_date` | |
| 施設名 | `Facility.facility_name` | |

#### フィルター
- 登録日（日付範囲）
- 勤務日（日付範囲）
- 取引先ID（部分一致）
- 取引先番号（部分一致）
- 案件名称（部分一致）
- 施設名（部分一致）

### 5.2 CSV出力項目（18項目）

| No. | 項目 | 必須 | 型 | DB項目/固定値 | 備考 |
|-----|------|:----:|------|--------------|------|
| 1 | 取引先ID | 〇 | 文字 | **未定** | CROSSNAVI連携 |
| 2 | 取引先番号 | 〇 | 文字 | **未定** | TASTAS管理番号 |
| 3 | シフト区分 | 〇 | 数字 | **固定「1」** | 1=通常 |
| 4 | 案件 No. | 〇 | 文字 | 空欄 | 取引先案件番号があれば省略可 |
| 5 | 取引先案件番号 | 〇 | 文字 | **未定** | |
| 6 | 勤務日 | 〇 | 日付 | `JobWorkDate.work_date` | yyyy/mm/dd |
| 7 | シフト名称 | 〇 | 文字 | `Job.title` | |
| 8 | 開始時刻 | 〇 | 時刻 | `Job.start_time` | hh:mm |
| 9 | 終了時刻 | 〇 | 時刻 | `Job.end_time` | hh:mm |
| 10 | 休憩（所定内） | 〇 | 分数 | `Job.break_time` | 分単位 |
| 11 | 休憩（所定外） | 〇 | 分数 | 0 | |
| 12 | 休憩（所定内深夜） | 〇 | 分数 | 0 | |
| 13 | 休憩（所定外深夜） | 〇 | 分数 | 0 | |
| 14 | 実働時間数 | 〇 | 時刻 | 計算値 | (終了-開始-休憩) hh:mm |
| 15 | 時間外有無 | 〇 | 文字 | 0 | 0=なし |
| 16 | 時間外単位 | 〇 | 時間 | 0:00 | |
| 17 | 時間外単位区分 | | 数字 | 0 | 0=なし |
| 18 | 必要人数 | 〇 | 数字 | `JobWorkDate.recruitment_count` | |

---

## 6. プールスタッフ情報出力

### 6.1 画面仕様

#### 一覧表示
| 項目 | DB項目 | 備考 |
|------|--------|------|
| 登録日 | `User.created_at` | |
| スタッフ番号 | `User.id` | TASTAS ID |
| 氏名 | `User.name` | |
| 電話番号 | `User.phone_number` | |
| メール | `User.email` | |

#### フィルター
- 登録日（日付範囲）
- スタッフ番号（部分一致）
- 氏名（部分一致）
- 電話番号（部分一致）
- メール（部分一致）

### 6.2 CSV出力項目（48項目）

| No. | 項目名 | 必須 | DB項目/固定値 | 備考 |
|-----|--------|:----:|--------------|------|
| 1 | 自社スタッフ番号 | 〇 | `User.id` | TASTAS ID |
| 2 | 事業所 | 〇 | **固定「渋谷事業所」** | |
| 3 | 登録日 | | `User.created_at` | yyyy/mm/dd |
| 4 | プールスタッフ氏名－姓 | 〇 | `User.name`から分割 | |
| 5 | プールスタッフ氏名－名 | 〇 | `User.name`から分割 | |
| 6 | プールスタッフ氏名カナ－セイ | | `User.last_name_kana` | |
| 7 | プールスタッフ氏名カナ－メイ | | `User.first_name_kana` | |
| 8 | 生年月日 | 〇 | `User.birth_date` | yyyy/mm/dd |
| 9 | 性別 | 〇 | `User.gender` | 0=男, 1=女 |
| 10 | 電話番号１ | 〇 | `User.phone_number` | |
| 11 | 電話番号１－連絡可否 | 〇 | **固定「1」** | 連絡可 |
| 12-13 | 電話番号２ | | 空欄 | |
| 14 | 連絡用E-Mail１ | 〇 | `User.email` | |
| 15 | 連絡用E-Mail１－連絡可否 | | 1 | |
| 16-17 | 連絡用E-Mail２ | | 空欄 | |
| 18 | 口座情報－銀行コード | 〇 | `BankAccount.bankCode` | |
| 19 | 口座情報－銀行支店コード | 〇 | `BankAccount.branchCode` | |
| 20 | 口座情報－口座種別 | 〇 | `BankAccount.accountType` | 0=普通, 1=当座 |
| 21 | 口座情報－口座番号 | 〇 | `BankAccount.accountNumber` | |
| 22 | 口座情報－口座名義 | 〇 | `BankAccount.accountHolderName` | |
| 23 | 配偶者有無 | 〇 | **固定「2」** | 不明 |
| 24 | 扶養対象者人数 | 〇 | **固定「0」** | |
| 25 | 現住所－郵便番号 | 〇 | `User.postal_code` | |
| 26 | 現住所－都道府県 | 〇 | `User.prefecture` | |
| 27 | 現住所－市区町村 | 〇 | `User.city` | |
| 28 | 現住所－住所 | 〇 | `User.address_line` | |
| 29 | 現住所－アパート・マンション | 〇 | `User.building` | |
| 30-32 | 現住所カナ・最寄り駅 | | 空欄 | |
| 33-37 | 連絡先住所 | 〇 | 現住所を引用 | |
| 38-41 | 連絡先住所カナ・TEL・FAX | | 空欄 | |
| 42-46 | 住民票住所 | 〇 | 現住所を引用 | |
| 47-48 | 住民票住所カナ | | 空欄 | |

---

## 7. 勤怠情報出力

### 7.1 画面仕様

#### 一覧表示
| 項目 | DB項目 | 備考 |
|------|--------|------|
| 勤務日 | `JobWorkDate.work_date` | |
| スタッフ名 | `User.name` | |
| 施設名 | `Facility.facility_name` | |
| 出勤時間 | `Attendance.check_in_time` | |
| 退勤時間 | `Attendance.check_out_time` | |
| ステータス | `Attendance.status` | |

#### フィルター
- 勤務日（日付範囲）
- スタッフ名（部分一致）
- 施設名（部分一致）
- ステータス（選択）

### 7.2 CSV出力項目（35項目）

| No. | 項目名 | 必須 | 型 | DB項目/固定値 | 備考 |
|-----|--------|:----:|------|--------------|------|
| 1 | 就業者ID | | 文字 | `User.id` | |
| 2 | 雇用契約No. | 〇 | 文字 | **未定** | 存在しないとエラー |
| 3 | 勤務日 | 〇 | 日付 | `JobWorkDate.work_date` | yyyy/mm/dd |
| 4 | 出勤区分 | | 数字 | 0 | 0=出勤 |
| 5 | シフト名称 | | 文字 | `Job.title` | |
| 6 | 所定開始時間 | | 時刻 | `Job.start_time` | hh:mm |
| 7 | 所定終了時間 | | 時刻 | `Job.end_time` | hh:mm |
| 8 | 所定時間数 | | 時間 | 計算値 | 終了-開始-休憩 |
| 9 | 所定休憩(所定内) | | 分数 | `Job.break_time` | 分単位 |
| 10-12 | 所定休憩(各種) | | 分数 | 0 | |
| 13 | 時間外有無 | | 数字 | 0 | 0=なし |
| 14 | 時間外単位区分 | | 数字 | 0 | 0=なし |
| 15 | 時間外単位 | | 時間 | 0:00 | |
| 16 | 開始時間 | | 時刻 | `Attendance.check_in_time` | 実績 |
| 17 | 終了時間 | | 時刻 | `Attendance.check_out_time` | 実績 |
| 18 | 総休憩時間 | | 分数 | `Attendance.actual_break_time` | |
| 19-22 | 休憩(各種) | | 分数 | 0 | |
| 23 | 実働時間数 | | 時間 | 計算値 | 実終了-実開始-休憩 |
| 24 | 所定内勤務時間 | | 時間 | 計算値 | |
| 25-27 | 所定外/深夜勤務時間 | | 時間 | 0:00 | |
| 28-31 | 45/60時間超え | | 時間 | 0:00 | |
| 32 | 休日出勤勤務時間 | | 時間 | 0:00 | |
| 33 | 遅刻時間 | | 時間 | 計算値 | 実開始-所定開始（正の場合） |
| 34 | 早退時間 | | 時間 | 計算値 | 所定終了-実終了（正の場合） |
| 35 | 交通費金額 | | 金額 | `Job.transportation_fee` | |

---

## 8. 実装計画

### Phase 1（今回実装）
1. **メニュー追加**: 「CSV出力」をサイドメニューに追加
2. **CSV出力トップ画面**: 5つの機能ボタンを配置
3. **取引先情報出力**: 完全実装（既存DB項目のみ、未対応項目は空欄）
4. **他4機能**: ボタン配置のみ、クリック時は「準備中」表示

### Phase 2（後日）
1. **DB拡張**: 不足項目をFacilityテーブルに追加
   - 取引先番号
   - 法人名称カナ
   - 銀行情報（銀行コード、支店コード、口座番号、口座名義人）
   - 振込依頼人番号
   - 事業所番号
   - 代表FAX番号
   - URL
2. **施設編集画面**: 追加項目の入力フォーム実装
3. **案件情報(代理)出力**: 実装
4. **案件シフト表(代理)出力**: 実装

### Phase 3（後日）
1. **プールスタッフ情報出力**: 実装
2. **勤怠情報出力**: 実装
3. **CROSSNAVI連携マスタ**: 取引先ID、雇用契約No.の管理機能

---

## 9. 技術仕様

### 9.1 ファイル構成
```
app/system-admin/csv-export/
├── page.tsx                    # CSV出力トップ画面
├── components/
│   ├── CsvExportMenu.tsx       # 機能選択メニュー
│   ├── FilterPanel.tsx         # 共通フィルターパネル
│   └── DataTable.tsx           # 共通データテーブル
├── client-info/
│   ├── page.tsx                # 取引先情報出力画面
│   └── components/
├── job-info/
│   ├── page.tsx                # 案件情報(代理)出力画面
│   └── components/
├── shift-info/
│   ├── page.tsx                # 案件シフト表(代理)出力画面
│   └── components/
├── staff-info/
│   ├── page.tsx                # プールスタッフ情報出力画面
│   └── components/
└── attendance-info/
    ├── page.tsx                # 勤怠情報出力画面
    └── components/
```

### 9.2 API構成
```
app/api/system-admin/csv-export/
├── client-info/
│   ├── route.ts                # 取引先一覧取得
│   └── download/route.ts       # CSV出力
├── job-info/
│   ├── route.ts
│   └── download/route.ts
├── shift-info/
│   ├── route.ts
│   └── download/route.ts
├── staff-info/
│   ├── route.ts
│   └── download/route.ts
└── attendance-info/
    ├── route.ts
    └── download/route.ts
```

### 9.3 CSV生成ユーティリティ
```typescript
// lib/csv-export/utils.ts
export function generateCsv(headers: string[], rows: string[][]): string;
export function downloadCsv(filename: string, content: string): void;
export function formatDate(date: Date): string; // yyyy/mm/dd
export function formatTime(time: string): string; // hh:mm
export function calculateWorkingHours(start: string, end: string, breakMinutes: number): string;
```

---

## 10. 注意事項

### 10.1 データ整合性
- CSV出力対象は、削除されていない（`deleted_at = null`）レコードのみ
- 仮登録状態（`is_pending = true`）の施設は除外

### 10.2 パフォーマンス
- 大量データ出力時はストリーミング処理を検討
- 一度に出力する最大件数を設定（例: 10,000件）

### 10.3 セキュリティ
- システム管理者のみアクセス可能
- 出力ログを記録（誰がいつ何を出力したか）

---

## 更新履歴

| 日付 | 版 | 内容 |
|------|-----|------|
| 2026-01-25 | 1.0 | 初版作成 |
