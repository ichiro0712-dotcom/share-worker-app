# 限定求人・オファー機能 実装レビューレポート

## 対象ドキュメント
`docs/feature-offer-limited-job.md`

## レビュアー
Strict Product Manager & System Responsible

## 概要
仕様書と現在の実装コード（`JobForm.tsx`, `job-management.ts`, `job-batch/route.ts` 等）を比較・精査しました。
全体として、仕様書の主要な要件（求人種別の拡張、オファー機能、バッチ処理）はおおむね実装されていますが、**ユーザー体験（UX）およびデータの整合性**の観点でいくつか改善すべき点が見受けられました。

---

## 検出された課題と改善提案

### 1. 「通常求人への自動切り替え」設定のUX不備 (High Priority)

**現状:**
`JobForm.tsx` において、「勤務開始日の [選択肢] 日前に通常求人に切り替え」のUIは実装されていますが、仕様書にある**日付に基づくデフォルト値の自動設定ロジック**が見当たりません。
ユーザーがいちいち手動で適切な日数を選択する必要があり、入力の手間が発生しています。

> **仕様書要件:**
> - 勤務開始日まで7日以上ある場合: デフォルト7日前
> - 勤務開始日まで7日未満〜3日以上: デフォルト3日前
> - 勤務開始日まで3日未満〜1日以上: デフォルト1日前
> - 勤務開始日まで1日未満: 切り替えなし

**提案:**
`JobForm.tsx` 内で `startTime` (勤務日) の変更を検知し、上記ロジックに基づいて `switchToNormalDaysBefore` のデフォルト値を動的にセットする処理を追加すべきです。

### 2. 「通常求人への自動切り替え」のバリデーション不足 (High Priority)

**現状:**
勤務開始日まで「あと2日」しかない求人に対して、「7日前に切り替え」を選択できてしまいます。
この状態で保存すると、作成直後（または翌日のバッチ実行時）に即座に通常求人に切り替わってしまい、「限定求人として公開したい」というユーザーの意図に反する挙動となります。

**提案:**
`JobForm.tsx` のバリデーションロジック（`handleSave`内）に以下のチェックを追加してください。
- `(勤務日 - 現在日時) < 切り替え設定日数` の場合、エラーまたは警告を表示する。
- または、選択肢自体を勤務日までの日数に応じてフィルタリングする（UI制御）。

### 3. アナリティクス集計仕様の確認不可 (Medium Priority)

**現状:**
仕様書には「子求人は親求人IDで集計（重複カウントしない）」とありますが、コードベース検索の結果、該当するアナリティクス集計ロジック（`analytics.ts` 等）が確認できませんでした。
もし実装漏れがある場合、ダッシュボードの数値が不正（二重計上など）になるリスクがあります。

**提案:**
アナリティクス機能の実装箇所を特定し、`parent_job_id` を考慮した集計クエリになっているかコードレベルで確認が必要です。未実装であれば、タスクに追加してください。

### 4. オファーテンプレート管理の重複管理 (Low Priority)

**現状:**
`app/admin/settings/offer-templates/page.tsx`（設定画面）と `JobForm.tsx` 内のモーダル（求人作成時の都度作成）で、同様の作成・更新ロジックが存在しています。
機能としては便利ですが、コードの重複があり、将来的な保守性に懸念があります。

**提案:**
急ぎの修正は不要ですが、将来的にはオファーテンプレート操作のロジックを共通フック（例: `useOfferTemplates`）に切り出し、両画面で再利用することを推奨します。

### 5. バッチ処理の「即時公開」挙動の確認 (Info)

**現状:**
バッチ処理（`job-batch/route.ts`）において、限定求人から切り出された子求人は `recruitment_start_day: 0`（即時公開）として作成されます。
これは仕様上の「切り替え」としては正しい挙動ですが、もし元の限定求人が「勤務日の○日前に公開」という設定を持っていた場合でも、切り替え発生時点で強制的に公開状態になります。
これが意図した仕様であるか、念のため再確認を推奨します（現状の実装で問題ない可能性が高いですが、Strict PMとして指摘しておきます）。

---

## 結論

機能自体は動作する状態ですが、**「通常求人への自動切り替え」周りのUIロジックとバリデーション**を追加することで、施設管理者の操作ミスを防ぎ、より堅牢なシステムになります。
上記の「High Priority」項目については、修正タスクとして積み上げることを推奨します。
