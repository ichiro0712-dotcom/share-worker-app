# PWAãƒ»ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ è¨­è¨ˆæ›¸

## æ¦‚è¦

+TASTAS ã‚¢ãƒ—ãƒªã‚’PWAï¼ˆProgressive Web Appï¼‰åŒ–ã—ã€Web Push APIã«ã‚ˆã‚‹ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’å®Ÿè£…ã™ã‚‹ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã«è¿‘ã„é€šçŸ¥ä½“é¨“ï¼ˆã‚¸ãƒ§ãƒ–ãƒãƒƒãƒæ™‚ã®é€šçŸ¥ãªã©ï¼‰ã‚’å®Ÿç¾ã™ã‚‹ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆPWAï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ React App   â”‚  â”‚ Service     â”‚  â”‚ iOS Add-to-Home        â”‚  â”‚
â”‚  â”‚ (Next.js)   â”‚  â”‚ Worker      â”‚  â”‚ Guide Component        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ã‚µãƒ¼ãƒãƒ¼ï¼ˆNext.js API Routesï¼‰            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ /api/push/      â”‚  â”‚ /api/push/      â”‚                       â”‚
â”‚  â”‚ subscribe       â”‚  â”‚ send            â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                    â”‚                                â”‚
â”‚           â–¼                    â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              web-push (VAPIDèªè¨¼)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆPostgreSQL/Prismaï¼‰             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ push_subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«                              â”‚   â”‚
â”‚  â”‚ - 1ãƒ¦ãƒ¼ã‚¶ãƒ¼è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ                               â”‚   â”‚
â”‚  â”‚ - endpoint, keys (p256dh, auth)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| é …ç›® | æŠ€è¡“ |
|------|------|
| PWAåŒ– | @ducanh2912/next-pwa |
| ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ | Web Push API + web-push |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | PostgreSQL + Prisma |
| èªè¨¼æ–¹å¼ | VAPID (Voluntary Application Server Identification) |

## iOSå¯¾å¿œã«ã¤ã„ã¦

### åˆ¶ç´„äº‹é …
- iOS Safariã§ã¯PWAã¨ã—ã¦ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ãªã„ã¨ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒä½¿ç”¨ã§ããªã„
- iOS 16.4ä»¥é™ã§Webãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹

### UXãƒ•ãƒ­ãƒ¼
1. iOSç«¯æœ« + ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰ã‚’æ¤œå‡º
2. ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
3. PWAï¼ˆstandaloneãƒ¢ãƒ¼ãƒ‰ï¼‰ã§èµ·å‹•ã—ãŸå ´åˆã®ã¿é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ iOS ãƒ–ãƒ©ã‚¦ã‚¶ã§é–²è¦§                        â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  ğŸ“± é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯               â”‚ â”‚
â”‚ â”‚  ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãã ã•ã„         â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚  1. å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆâ–¡â†‘ï¼‰ã‚’ã‚¿ãƒƒãƒ—         â”‚ â”‚
â”‚ â”‚  2.ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰èµ·å‹•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PWA (standalone) ãƒ¢ãƒ¼ãƒ‰                  â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  ğŸ”” é€šçŸ¥ã‚’è¨±å¯                       â”‚ â”‚
â”‚ â”‚  [è¨±å¯ã™ã‚‹] [å¾Œã§]                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### push_subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«

```prisma
model PushSubscription {
  id         Int       @id @default(autoincrement())
  user_id    Int?      @map("user_id")
  admin_id   Int?      @map("admin_id")        // æ–½è¨­ç®¡ç†è€…å‘ã‘
  user_type  String    @map("user_type")       // "worker" | "facility_admin"
  endpoint   String    @unique
  p256dh     String                            // Public Key
  auth       String                            // Auth Secret
  user_agent String?   @map("user_agent")      // ãƒ‡ãƒã‚¤ã‚¹è­˜åˆ¥ç”¨
  created_at DateTime  @default(now()) @map("created_at")
  updated_at DateTime  @updatedAt @map("updated_at")

  user       User?          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  admin      FacilityAdmin? @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}
```

## ç’°å¢ƒå¤‰æ•°

```env
# VAPID Keysï¼ˆweb-pushã§ç”Ÿæˆï¼‰
NEXT_PUBLIC_VAPID_PUBLIC_KEY=xxxxx
VAPID_PRIVATE_KEY=xxxxx
VAPID_SUBJECT=mailto:support@example.com
```

## APIè¨­è¨ˆ

### POST /api/push/subscribe
ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è³¼èª­ã‚’ç™»éŒ²

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```json
{
  "subscription": {
    "endpoint": "https://fcm.googleapis.com/fcm/send/...",
    "keys": {
      "p256dh": "...",
      "auth": "..."
    }
  },
  "userType": "worker" | "facility_admin"
}
```

### POST /api/push/unsubscribe
ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è³¼èª­ã‚’è§£é™¤

### POST /api/push/send
é€šçŸ¥ã‚’é€ä¿¡ï¼ˆå†…éƒ¨APIï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```json
{
  "userId": 1,
  "userType": "worker",
  "title": "æ–°ã—ã„æ±‚äººãŒã‚ã‚Šã¾ã™",
  "body": "ã‚ãªãŸã«ã´ã£ãŸã‚Šã®æ±‚äººãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ",
  "url": "/jobs/123"
}
```

## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆ

### æ³¨æ„äº‹é …
1. **HTTPSå¿…é ˆ**: Service Workerã¯HTTPSç’°å¢ƒã§ã®ã¿å‹•ä½œï¼ˆlocalhost ã¯ä¾‹å¤–ï¼‰
2. **é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®PWA**: `next.config.mjs` ã§ `disable: false` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§é–‹ç™ºç’°å¢ƒã§ã‚‚Service WorkerãŒå‹•ä½œ
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢**: Service Workeræ›´æ–°æ™‚ã¯é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã€ŒUpdate on reloadã€ã‚’æœ‰åŠ¹åŒ–æ¨å¥¨

### VAPIDã‚­ãƒ¼ç”Ÿæˆæ‰‹é †

```bash
# web-push CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npx web-push generate-vapid-keys

# å‡ºåŠ›ä¾‹:
# Public Key: BN...xxx
# Private Key: aB...xxx
```

ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ã‚’ `.env` ã«è¨­å®šã™ã‚‹ã€‚

## é€šçŸ¥ã‚·ãƒŠãƒªã‚ªï¼ˆå°†æ¥å®Ÿè£…ï¼‰

| ã‚·ãƒŠãƒªã‚ª | å¯¾è±¡ | å†…å®¹ |
|---------|------|------|
| å¿œå‹Ÿå—ä»˜ | æ–½è¨­ç®¡ç†è€… | ã€Œæ–°ã—ã„å¿œå‹ŸãŒã‚ã‚Šã¾ã—ãŸã€ |
| å¿œå‹Ÿçµæœ | ãƒ¯ãƒ¼ã‚«ãƒ¼ | ã€Œå¿œå‹ŸãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€ |
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | ä¸¡æ–¹ | ã€Œæ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™ã€ |
| å‹¤å‹™ãƒªãƒã‚¤ãƒ³ãƒ‰ | ãƒ¯ãƒ¼ã‚«ãƒ¼ | ã€Œæ˜æ—¥ã®å‹¤å‹™ãŒã‚ã‚Šã¾ã™ã€ |
| è©•ä¾¡ä¾é ¼ | ä¸¡æ–¹ | ã€Œè©•ä¾¡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€ |

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ manifest.json           # PWAãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ sw.js                   # Service Worker (next-pwaç”Ÿæˆ)
â”‚   â””â”€â”€ icons/                  # PWAã‚¢ã‚¤ã‚³ãƒ³
â”‚       â”œâ”€â”€ icon-192x192.png
â”‚       â””â”€â”€ icon-512x512.png
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ push/
â”‚           â”œâ”€â”€ subscribe/route.ts
â”‚           â”œâ”€â”€ unsubscribe/route.ts
â”‚           â””â”€â”€ send/route.ts
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ pwa/
â”‚   â”‚   â”œâ”€â”€ InstallPrompt.tsx    # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿ƒé€²
â”‚   â”‚   â”œâ”€â”€ IOSInstallGuide.tsx  # iOSãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ã‚¬ã‚¤ãƒ‰
â”‚   â”‚   â””â”€â”€ NotificationButton.tsx # é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³
â”‚   â””â”€â”€ ...
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ push-notification.ts     # ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”œâ”€â”€ next.config.mjs              # PWAè¨­å®šè¿½åŠ 
â””â”€â”€ prisma/
    â””â”€â”€ schema.prisma            # PushSubscriptionè¿½åŠ 
```
