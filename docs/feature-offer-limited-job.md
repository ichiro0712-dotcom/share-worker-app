# 機能仕様書: 限定求人・オファー機能

## 概要

求人の種類を拡張し、「限定求人」と「オファー」機能を追加する。

---

## 1. 求人TOPのUI変更（ワーカー向け）

### 現状
- タブ形式: 「全体」「限定」「指名」

### 変更後
- タブを廃止し、絞り込み・ソートと同じ行の一番左にドロップダウンリストを配置
- 選択肢: 「すべて」「限定求人」「オファー」

### UI配置イメージ
```
[すべて ▼] [絞り込み] [近い順 ▼]
```

### 表示ルール
- **「すべて」選択時**: 通常求人・説明会のみ表示（限定求人・オファーは表示されない）
- **「限定求人」選択時**: 自分が対象の限定求人のみ表示
- **「オファー」選択時**: 自分宛のオファーのみ表示

### 限定求人が通常に切り替わった場合
- **通常求人のみに表示**: 切り替え後は「すべて」リストにのみ表示
- 「限定求人」リストには表示されない（シンプルに通常求人として扱う）
- **「限定」バッジは消える**: 切り替え後は通常求人として表示（バッジなし）

### 0件時の表示
- 限定求人が0件の場合: 「限定求人(0)」と表示（タブ/ドロップダウンに件数を表示）
- オファーが0件の場合: 「オファー(0)」と表示

---

## 2. 求人種別の拡張

### 現状
- 「通常業務」「説明会」の2種類

### 変更後
- 4種類に拡張:
  1. **通常求人**
  2. **限定求人（勤務済みの方）**
  3. **限定求人（お気に入りのみ）**
  4. **説明会**

※「オファー」は別枠（特定ワーカー指名の求人）

### 各種別の動作

#### 通常求人
- 特別な処理なし
- 「すべて」リストに表示される
- 審査してマッチング: ON/OFF選択可能

#### 限定求人（勤務済みの方）
- **「勤務済み」の定義**: その施設で過去にマッチングし、評価まで完了（`completed_rated`）したワーカー
- 対象ワーカーのみ「限定求人」リストに表示される
- 「すべて」リストには表示されない
- **非対象ワーカーには一切表示されない**（グレーアウトではなく非表示）
- 審査してマッチング: 常にOFF（即マッチング）
- 勤務開始日の「X日前」に自動で通常求人に切り替わる
- **対象者0人の場合**: 作成不可（バリデーションエラー）

#### 限定求人（お気に入りのみ）
- 施設がお気に入り登録しているワーカーのみ「限定求人」リストに表示される
- 「すべて」リストには表示されない
- **非対象ワーカーには一切表示されない**（グレーアウトではなく非表示）
- 審査してマッチング: 常にOFF（即マッチング）
- 勤務開始日の「X日前」に自動で通常求人に切り替わる
- **対象者0人の場合**: 作成不可（バリデーションエラー）
- **公開中にお気に入り解除した場合**: 該当ワーカーには非表示になる

#### 説明会
- 「すべて」リストに表示される
- 求人TOP・求人詳細に「説明会」バッジを表示
  - 表示位置: 「未経験者歓迎」などのバッジと同じエリア
  - スタイル: 既存のバッジ（未経験者歓迎等）と統一
- 絞り込み検索に「説明会を除く」チェックボックスを追加
  - チェック時: 説明会求人を非表示
- 審査してマッチング: ON/OFF選択可能

---

## 3. 求人作成/編集画面のUI変更

### 現状
- 求人種別: ドロップダウンリストで選択
- 審査してマッチング: チェックボックス

### 変更後
- **ラジオボタン形式**に変更

### UIイメージ
```
求人種別
○ 通常求人  ○ 限定求人（勤務済みの方）  ○ 限定求人（お気に入りのみ）  ○ 説明会

[説明文エリア]
（選択した求人種別に応じて説明が変わる）

□ 審査してマッチング  ※応募後に審査・選考を行ってからマッチングを決定します
（※通常求人・説明会選択時のみ表示）

勤務開始日 [  ] 日前に通常求人に切り替え
（※限定求人選択時のみ表示）
```

### 求人種別ごとの説明文

| 種別 | 説明文 |
|------|--------|
| 通常求人 | すべてのワーカーが閲覧・応募できる求人です。 |
| 限定求人（勤務済みの方） | 過去にあなたの施設で勤務したワーカーのみが閲覧・応募できます。審査なしで即マッチングとなります。 |
| 限定求人（お気に入りのみ） | あなたがお気に入り登録しているワーカーのみが閲覧・応募できます。審査なしで即マッチングとなります。 |
| 説明会 | 施設の説明会として求人を作成します。「説明会」バッジが表示されます。 |

### 通常求人への自動切り替え
- 限定求人のみ表示されるオプション
- **デフォルト値の自動設定**:
  - 勤務開始日まで7日以上ある場合: デフォルト7日前
  - 勤務開始日まで7日未満〜3日以上: デフォルト3日前
  - 勤務開始日まで3日未満〜1日以上: デフォルト1日前
  - 勤務開始日まで1日未満: 切り替えなし（限定のまま）
- 切り替え後: 限定求人→通常求人に変更され、全ワーカーが閲覧可能になる
- **切り替え時の通知**: なし

### 求人種別の変更ルール
- **限定求人 ↔ 通常求人**: 変更可能
- **限定求人 ↔ オファー**: 変更不可
- **通常求人 ↔ オファー**: 変更不可
- **説明会 ↔ 通常求人**: 変更可能
- **説明会 ↔ 限定求人/オファー**: 変更不可

※オファーは特定ワーカー1名専用のため、他の種別との相互変更は許可しない

---

## 4. オファー機能

### 概要
特定のワーカー1名に対して専用の求人を作成する機能。

### オファー対象ワーカーの条件
- **勤務済み（レビュー完了）ワーカーのみ**がオファー対象
- 具体的には: その施設で過去にマッチングし、評価まで完了（`completed_rated`）したワーカー
- 審査中・審査落ち・キャンセルのワーカーにはオファーボタンが表示されない
- 「勤務済みの方」限定求人の対象条件と同じ

### オファーボタンの配置場所
1. `/admin/workers` - ワーカーリストのお気に入りハートマークの左（勤務済みワーカーのみ表示）
2. `/admin/workers/[id]` - ヘッダーの一番右端（勤務済みワーカーのみ表示）

### オファー求人作成画面

#### ベース
- `/admin/jobs/new` と共通コンポーネントを使用
- 新規求人作成の変更がオファー作成にも反映される

#### 差分
| 項目 | 通常の新規作成 | オファー作成 |
|------|--------------|------------|
| ヘッダー下の表示 | なし | 「{ワーカー名}さんへのオファー」 |
| 求人種別選択 | ラジオボタン4択 | 非表示（固定で「オファー」） |
| 審査してマッチング | あり（通常/説明会時） | なし（常に即マッチング） |
| メッセージ欄 | なし | あり（1000文字以内） |
| 通常求人切り替え | 限定求人時のみ | なし |
| **募集人数** | 設定可能 | **1名固定（変更不可）** |

### メッセージ欄の仕様
- 位置: その他フィールドの下
- 文字数制限: 1000文字以内
- テンプレート機能:
  - **オファー専用のテンプレート管理を新設**
  - 施設管理者がテンプレートを作成・編集・選択可能
  - 管理場所: `/admin/settings/offer-templates`（新規作成）
  - **永続化必須**: DBに保存し、ハードリロードしても消えないこと（レビューテンプレートと同様の仕組み）
  - **上限**: 20件まで
  - **削除**: レビューテンプレートと同じ挙動（デフォルト削除時は次のテンプレートがデフォルトになる）

### オファー作成時の動作
1. オファー求人がDBに保存される（募集人数は1名固定）
2. 該当ワーカーの求人TOP「オファー」リストに表示される
3. 施設からワーカーへメッセージが自動送信される
   - メッセージ内容: オファー作成時に入力したメッセージ
   - 送信元: 施設（通常のメッセージと同じ扱い）
   - 施設のメッセージ一覧にも表示される
   - 既存のメッセージ機能をそのまま使用

### オファーの有効期限
- **募集終了日で設定した日時が期限**
- 期限切れ後: **自動削除**（ワーカーの求人一覧・施設の求人管理から消える）
- **オファーは通常求人に切り替わらない**（特定ワーカー専用のため）

### オファーの削除
- **自動削除**: 募集終了日時を過ぎると自動削除（バッチ処理）
- **手動削除**: 施設管理者が求人管理画面から削除可能
- 削除後の通知: なし（期限切れは自然消滅扱い）

### オファー自動削除バッチ
- **実行タイミング**: 限定求人切り替えバッチと同じ（毎日0時JST）
- **処理内容**: `jobs`テーブルで`job_type = 'OFFER'`かつ`deadline < 現在時刻`のレコードを物理削除
- **エラーハンドリング**: 限定求人バッチと同様（リトライ3回、失敗時メール通知）
- **ログ**: 削除したオファー数をログ出力

### オファーへの応募
- **審査なしで即マッチング**
- ワーカーが「オファーを受ける」ボタンを押すと、自動的にマッチング成立
- 募集人数は1名固定なので、応募したら即埋まる

### オファーの辞退
- **明示的な辞退ボタンはなし**
- ワーカーは無視するか、通常のキャンセルフローで対応
- マッチング成立後は、通常のキャンセルと同じ（勤務前までに双方からキャンセル可能）

### オファーの重複
- **同一ワーカー×同一日程のオファーは不可**（バリデーションエラー）
- 同じワーカーに別日程のオファーは可能

### オファー求人の編集
- **オファー求人は編集不可**
- 理由: 特定ワーカー専用の求人のため、内容変更は混乱を招く
- 修正が必要な場合: オファーを削除して新規作成する

---

## 5. 施設管理者向け画面のUI変更

### 5.1 求人管理画面 (`/admin/jobs`)

#### 求人カードの変更
- ステータスアイコンの横に種別アイコンを追加:
  - 「限定」: 限定求人（勤務済みの方）
  - 「限定★」: 限定求人（お気に入りのみ）
  - 「オファ」: オファー

#### フィルタリングの変更
- 「すべて」をドロップダウンリストに変更
- 選択肢: 「すべて」「通常求人」「限定」「限定（お気に入り）」「オファー」
- 右側の「未公開」「停止中」等と組み合わせ可能
  - 例: 「限定」×「未公開」= 限定求人の未公開のみ表示
- **0件時の表示**: 「限定(0)」のように件数を表示

### 5.2 応募管理画面 (`/admin/applications`)

#### 「求人から」タブ
- 求人カードのステータスアイコンの横に種別アイコンを追加:
  - 「限定」「限定★」「オファ」
- 「すべて」をドロップダウンリストに変更
- 選択肢: 「すべて」「通常求人」「限定」「限定（お気に入り）」「オファー」
- 右側のステータスフィルタと組み合わせ可能

#### 「シフトから」タブ
- 求人バーの「介護」等のアイコンの**左**に種別アイコンを追加:
  - 「限定」「限定★」「オファ」
- 求人バークリック時のモーダル:
  - 「公開中」等のアイコンの**左**に種別アイコンを追加

---

## 6. 求人カード・求人詳細のUI変更（ワーカー向け）

### バッジ表示
「未経験者歓迎」などのバッジと同じエリアに、求人種別に応じたバッジを表示する。

| 種別 | バッジ | 表示条件 |
|------|--------|---------|
| 通常求人（審査あり） | 「審査あり」 | `requires_interview = true` の場合 |
| 限定求人（勤務済み） | 「限定」 | 対象ワーカーにのみ表示 |
| 限定求人（お気に入り） | 「限定★」 | 対象ワーカーにのみ表示 |
| オファー | 「オファー」 | 対象ワーカーにのみ表示 |
| 説明会 | 「説明会」 | 全ワーカーに表示 |

### 求人詳細ページ
- オファー求人の場合: 通常の求人詳細と同じレイアウト（バッジで区別）
- オファーメッセージ: メッセージ機能経由で確認（詳細ページには表示しない）

### 応募ボタンの文言

| 種別 | ボタン文言 |
|------|-----------|
| 通常求人（審査あり） | 「応募する」 |
| 通常求人（審査なし） | 「応募する」 |
| 限定求人 | 「応募する」 |
| オファー | **「オファーを受ける」** |

---

## 7. マイページ・応募履歴の表示（ワーカー向け）

### 応募履歴での表示
- 施設名の**前**に種別アイコンを追加:
  - 「限定」「限定★」「オファ」
- オファー経由のマッチングは一目で区別できる

---

## 8. 通知管理の追加

### 場所
`/system-admin/content/notifications`

### 追加項目

#### ワーカー向け通知
- 「施設からのオファー」を追加
- **既存の通知設定と同じUIで管理**（特別なUIは不要）
- 他の通知と同様の管理機能を提供
- **Push通知・メール通知**: システム管理画面で設定可能（既存の通知設定と同様）

#### 施設向け通知（新規追加）
- 「オファー受諾」を追加
- ワーカーがオファーを受諾した際に施設管理者へ通知
- Push通知・メール通知: システム管理画面で設定可能
- `notification_settings`テーブルに`FACILITY_OFFER_ACCEPTED`タイプを追加
- ワーカー向け通知と同じUI・管理方法を使用
- **初期値**: デフォルトON（通知する）

### 通知テンプレートの変数

オファー通知で使用できる変数:

| 変数 | 説明 |
|------|------|
| `{{worker_name}}` | ワーカー名 |
| `{{facility_name}}` | 施設名 |
| `{{job_title}}` | 求人タイトル |
| `{{work_date}}` | 勤務日 |
| `{{wage}}` | 時給 |

---

## 9. 自動切り替えバッチ処理

### 実行タイミング
- **実行頻度**: 1日1回
- **実行時刻**: 午前0時（JST）
- **タイムゾーン**: 日本標準時（JST / Asia/Tokyo）

### 処理内容
1. 限定求人（`LIMITED_WORKED`, `LIMITED_FAVORITE`）を取得
2. 各求人の勤務開始日と`switch_to_normal_days_before`を比較
3. 切り替え日を過ぎている場合、`job_type`を`NORMAL`に変更
4. `requires_interview`は`false`のまま維持（即マッチング継続）

### 複数日程求人の扱い
- **切り替え基準**: 最も早い勤務日を基準に判定
- **表示方法**: 切り替え時に該当日のみを切り出して子求人を作成
- **親子関係**: 子求人に`parent_job_id`カラムを追加し、親求人と紐付け
- **アナリティクス**: 子求人は親求人IDで集計（重複カウントしない）
- 例: 12/20, 12/25, 12/30の3日程で、12/17に切り替わる場合
  - 12/20の日程のみが切り出されて通常求人（子求人）として表示される
  - 他の日程（12/25, 12/30）は限定求人のまま
  - 子求人の`parent_job_id`には親求人のIDが入る

### 子求人作成時のカラム継承ルール

| カラム | 継承方法 |
|--------|----------|
| title, description, location, wage, hourly_wage, required_qualifications, notes, break_minutes, image_url | 親からそのままコピー |
| facility_id | 親と同じ |
| job_type | `NORMAL`に変更 |
| parent_job_id | 親求人のIDを設定 |
| visibility | `PUBLIC`に変更 |
| target_worker_id, offer_message | NULL |
| switch_to_normal_days_before | NULL |
| created_at | 新規作成日時 |
| JobWorkDate | 該当日のレコードのみコピー（deadline, visible_until含む） |

### エラーハンドリング
- **リトライ**: 失敗時は最大3回リトライ
- **リトライ間隔**: 5分、15分、30分（指数バックオフ）
- **失敗時の通知**: 3回失敗後、システム管理者にメール通知
- **手動切り替え**: システム管理画面から手動で切り替え可能なUIを提供
  - `/system-admin/jobs` に「手動切り替え」ボタンを追加
  - 切り替え対象の限定求人を一覧表示し、個別または一括で切り替え可能

### ログ・監査
- **実行ログ**: 切り替え処理の実行日時、対象求人ID、結果をDBに記録
- **監査証跡**: システム管理画面でログを確認可能（`/system-admin/logs`）
- **保持期間**: 90日間（推奨設定）

---

## 10. DB設計

### オファー状態管理について
- **WorkerStatus enumは変更なし**（オファー状態はJobStatusで管理）
- オファー作成時: Applicationは作成しない
- オファー受諾時: 各日程にApplicationを作成（status: SCHEDULED）
- オファー期限切れ: Job.statusをSTOPPEDに更新（履歴として残す）

### jobs テーブル変更
```sql
-- 求人種別の拡張
-- 既存: NORMAL, ORIENTATION
-- 追加: LIMITED_WORKED（勤務済み限定）, LIMITED_FAVORITE（お気に入り限定）, OFFER（オファー）

-- 限定求人の自動切り替え日数
ALTER TABLE jobs ADD COLUMN switch_to_normal_days_before INTEGER;  -- 勤務開始日の何日前に通常求人に切り替えるか

-- オファー関連カラム追加
ALTER TABLE jobs ADD COLUMN target_worker_id INTEGER REFERENCES users(id);  -- オファー対象ワーカー
ALTER TABLE jobs ADD COLUMN offer_message TEXT;  -- オファーメッセージ

-- 親子関係（複数日程の切り出し用）
ALTER TABLE jobs ADD COLUMN parent_job_id INTEGER REFERENCES jobs(id);  -- 親求人ID（切り出し元）
```

### MessageThread テーブル（新規）
```sql
-- Phase 1: 新モデル追加
CREATE TABLE message_threads (
  id SERIAL PRIMARY KEY,
  worker_id INTEGER NOT NULL REFERENCES users(id),
  facility_id INTEGER NOT NULL REFERENCES facilities(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(worker_id, facility_id)
);

-- Phase 2: messagesテーブルにthread_id追加（nullable）
ALTER TABLE messages ADD COLUMN thread_id INTEGER REFERENCES message_threads(id);
```

### オファーテンプレートテーブル（新規）
```sql
CREATE TABLE offer_templates (
  id SERIAL PRIMARY KEY,
  facility_id INTEGER NOT NULL REFERENCES facilities(id),
  title VARCHAR(100) NOT NULL,  -- テンプレート名
  content TEXT NOT NULL,  -- テンプレート本文
  is_default BOOLEAN DEFAULT FALSE,  -- デフォルトテンプレート
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 通知テンプレート
- `notification_settings` テーブルに「WORKER_OFFER_RECEIVED」タイプを追加
- `notification_settings` テーブルに「FACILITY_OFFER_ACCEPTED」タイプを追加
- `notification_settings` テーブルに「BATCH_JOB_SWITCH_FAILED」タイプを追加（SYSTEM_ADMIN向け）

---

## 11. CSVエクスポート・インポート

### エクスポート
- 求人のCSVエクスポートに新しい種別カラムを追加
- `job_type`: `NORMAL`, `ORIENTATION`, `LIMITED_WORKED`, `LIMITED_FAVORITE`, `OFFER`

### インポート
- 新しい種別でのインポートに対応
- **オファーのCSVインポートは非対応**（1名専用のため個別作成が必要）

---

## 12. アナリティクス・レポート

### システム管理画面のダッシュボード
- 新しい指標を追加（詳細は実装時に決定）:
  - 限定求人数
  - オファー数
  - オファー承諾率
  - 限定求人からの応募率

---

## 13. 影響範囲と対応内容

### 13.1 求人検索API
**ファイル**: `/app/api/jobs/route.ts`, `/src/lib/actions/job-worker.ts`

**対応内容**:
- `listType` パラメータ追加（`all` / `limited` / `offer`）
- `all` の場合: `job_type` が `NORMAL` または `ORIENTATION` のみ返す
- `limited` の場合: 対象ワーカーの限定求人のみ返す
- `offer` の場合: `target_worker_id` が一致するオファーのみ返す
- 非対象ワーカーには限定求人・オファーを返さない

### 13.2 応募ロジック
**ファイル**: `/src/lib/actions/application-worker.ts`

**対応内容**:
- 限定求人・オファーの場合: `requires_interview` を強制的に `false` として処理
- 即マッチング処理（既存ロジックを使用）
- 重複応募チェック（既存ロジックで対応済み）

### 13.3 求人カード（ワーカー向け）
**ファイル**: `/components/job/JobCard.tsx`

**対応内容**:
- 求人種別に応じたバッジ表示
- 「審査あり」バッジの追加（通常求人で `requires_interview = true` の場合）

### 13.4 求人詳細
**ファイル**: `/components/job/JobDetailClient.tsx`

**対応内容**:
- 求人種別に応じたバッジ表示
- オファーの場合: ボタン文言を「オファーを受ける」に変更

### 13.5 メッセージ機能
**ファイル**: `/src/lib/actions/notification.ts`

**対応内容**:
- 既存のメッセージ機能をそのまま使用
- 変更なし

### 13.6 通知設定
**ファイル**: `/app/system-admin/content/notifications/`

**対応内容**:
- 新しい通知タイプ「WORKER_OFFER_RECEIVED」を追加
- 既存UIで管理可能（特別なUI変更なし）

### 13.7 お気に入り機能
**ファイル**: `/src/lib/actions/review-admin.ts`

**対応内容**:
- **実装済み**: 施設→ワーカーのお気に入り機能は既存
- 変更不要

### 13.8 マッチング履歴
**ファイル**: `/src/lib/actions/review-admin.ts`

**対応内容**:
- 変更なし（既存のステータス遷移ロジックを使用）

### 13.9 求人管理画面（施設向け）
**ファイル**: `/app/admin/jobs/page.tsx`

**対応内容**:
- 種別アイコン追加
- フィルタリングUI変更

### 13.10 応募管理画面（施設向け）
**ファイル**: `/app/admin/applications/page.tsx`

**対応内容**:
- 種別アイコン追加
- フィルタリングUI変更
- シフトビューの求人バーにアイコン追加

---

## 14. 画面遷移フロー

### オファー作成フロー
```
施設管理者
  ↓
ワーカー一覧 or ワーカー詳細
  ↓
[オファー] ボタンクリック
  ↓
オファー作成画面（/admin/jobs/new?mode=offer&workerId=xxx）
  ↓
内容入力 → 作成
  ↓
・オファー求人保存（募集人数1名固定）
・メッセージ自動送信
・通知送信
```

### ワーカーのオファー確認フロー
```
ワーカー
  ↓
求人TOP
  ↓
[オファー] 選択（ドロップダウン）
  ↓
自分宛のオファー一覧表示
  ↓
求人詳細 → 「オファーを受ける」（即マッチング）
```

### 限定求人の確認フロー
```
ワーカー
  ↓
求人TOP
  ↓
[限定求人] 選択（ドロップダウン）
  ↓
自分が対象の限定求人一覧表示
  （評価完了済み施設 または お気に入り登録されている施設の求人）
  ↓
求人詳細 → 応募（即マッチング）
```

---

## 15. 実装優先順位（案）

### Phase 1: 基盤整備
1. DBスキーマ変更（求人種別拡張、カラム追加）
2. Prismaスキーマ更新
3. 施設→ワーカーのお気に入り機能の確認・実装

### Phase 2: 求人作成/編集UI
1. ラジオボタン形式への変更
2. 説明文の動的切り替え
3. 審査してマッチングの条件付き表示
4. 通常求人切り替え日数フィールド（デフォルト値自動設定）
5. オファー時の募集人数1名固定

### Phase 3: 限定求人機能
1. 限定求人（勤務済み）のフィルタリングロジック（評価完了済みで判定）
2. 限定求人（お気に入り）のフィルタリングロジック
3. ワーカー側の限定求人リスト表示
4. 自動切り替えバッチ処理（毎日0時JST）

### Phase 4: オファー機能
1. オファーボタン配置（ワーカー一覧/詳細）
2. オファー作成画面
3. オファーテンプレート管理（DB永続化）
4. オファー時の自動メッセージ送信
5. ワーカー側のオファーリスト表示
6. 「オファーを受ける」ボタン

### Phase 5: 施設管理画面
1. 求人管理の種別アイコン・フィルタ
2. 応募管理の種別アイコン・フィルタ
3. シフトビューの種別アイコン

### Phase 6: 付随機能
1. 「審査あり」「限定」「オファー」「説明会」バッジ表示
2. 絞り込み「説明会を除く」
3. 通知設定への追加
4. マイページの種別アイコン表示
5. CSVエクスポート・インポート対応
6. アナリティクス指標追加

---

## 確認事項の調査結果

### Q1. 施設→ワーカーのお気に入り機能の有無 ✅ 解決済み
**結果**: 実装済み

- **実装箇所**: `/src/lib/actions/review-admin.ts:592` の `toggleWorkerFavorite`関数
- **DBモデル**: `Bookmark`テーブルで `facility_id` + `target_user_id` + `type: 'FAVORITE'` で管理
- **UI**: `/admin/workers/page.tsx` と `/admin/workers/[id]/page.tsx` にハートアイコンで実装済み
- **追加実装不要**

### Q2. 求人種別変更時の矛盾チェック ✅ 解決済み

**決定事項**: オファーは他の種別と相互変更不可

| 変更パターン | 可否 |
|-------------|------|
| 限定求人 ↔ 通常求人 | ✅ 可能 |
| 説明会 ↔ 通常求人 | ✅ 可能 |
| 通常求人 ↔ オファー | ❌ 不可 |
| 限定求人 ↔ オファー | ❌ 不可 |
| 説明会 ↔ 限定求人/オファー | ❌ 不可 |

### Q3. Push通知・メール通知の初期設定 ✅ 解決済み

**決定事項**: 既存の「マッチング通知」と同じ初期設定
- Push通知: ON
- メール通知: ON
- チャット通知: ON

### Q4. 限定求人が通常に切り替わった後の表示 ✅ 解決済み

**決定事項**: 通常求人のみに表示
- 切り替え後は「すべて」リストにのみ表示される
- 「限定求人」リストには表示されない
- シンプルに通常求人として扱う

### Q5. 複数日程求人の切り替え ✅ 解決済み

**決定事項**: 該当日のみを切り出して子求人を作成
- 最も早い勤務日を切り替え基準とする
- 切り替え時は該当日（1日）のみを切り出して子求人（通常求人）として作成
- 子求人に`parent_job_id`を設定して親求人と紐付け
- アナリティクスでは親求人IDで集計（重複カウントしない）
- 他の日程は限定求人のまま維持

### Q6. オファー対象ワーカーの条件 ✅ 解決済み

**決定事項**: 勤務済み（レビュー完了）ワーカーのみ
- `completed_rated`ステータスのワーカーのみオファーボタンが表示される
- 審査中・審査落ち・キャンセルのワーカーにはオファーボタン非表示
- 「勤務済みの方」限定求人の対象条件と同じ

### Q7. オファー求人の編集可否 ✅ 解決済み

**決定事項**: 編集不可
- オファー求人は編集できない
- 修正が必要な場合は削除して新規作成する

### Q8. バッチ失敗時のリカバリ ✅ 解決済み

**決定事項**: リトライ + 手動切り替えUI
- 失敗時は最大3回リトライ（5分、15分、30分間隔）
- 3回失敗後、システム管理者にメール通知
- システム管理画面に手動切り替えUIを提供

### Q9. 既存求人のマイグレーション ✅ 解決済み

**決定事項**: 特別な移行不要
- 既存の求人はすべて通常求人（`NORMAL`）または説明会（`ORIENTATION`）
- 新しい求人種別（限定求人、オファー）はこの機能リリース後に作成されるもののみ
- DBスキーマ変更時に既存データへの影響なし

### Q10. 施設管理画面のフィルタ ✅ 解決済み

**決定事項**: 「通常求人」も選択肢に追加
- 選択肢: 「すべて」「通常求人」「限定」「限定（お気に入り）」「オファー」
- 0件時は「限定(0)」のように件数を表示

### Q11. オファー受諾時の施設通知 ✅ 解決済み

**決定事項**: 施設側にも通知設定を追加
- 「オファー受諾」通知をシステム管理画面で設定可能
- Push通知・メール通知に対応

### Q12. お気に入り解除時の影響 ✅ 解決済み

**決定事項**: 非表示になる
- 限定求人（お気に入り）公開中にお気に入りを解除すると、該当ワーカーには非表示になる
- 動的に対象者を判定するため、リアルタイムで反映

### Q13. 限定求人の募集人数制限 ✅ 解決済み

**決定事項**: 制限なし
- 対象者より多い募集人数でも許可
- 切り替え後に通常求人として全員に公開されるため問題なし

### Q14. オファーの重複制限 ✅ 解決済み

**決定事項**: 同一ワーカー×同一日程は不可
- バリデーションエラーで作成を拒否
- 同じワーカーに別日程のオファーは可能

### Q15. オファーの削除仕様 ✅ 解決済み

**決定事項**: 自動削除 + 手動削除
- 募集終了日時を過ぎると自動削除
- 施設管理者が求人管理画面から手動削除可能
- 削除後の通知なし

### Q16. 対象者0人の限定求人 ✅ 解決済み

**決定事項**: 作成不可
- お気に入り0人、勤務済み0人の状態で限定求人を作成しようとするとバリデーションエラー

### Q17. オファーテンプレートの上限・削除 ✅ 解決済み

**決定事項**: 20件まで、削除はレビューテンプレートと同じ
- 上限20件
- デフォルト削除時は次のテンプレートがデフォルトになる

### Q18. オファーのCSVインポート ✅ 解決済み

**決定事項**: 非対応
- オファーは1名専用のため、CSVインポートは対応しない

### Q19. オファー求人の求人一覧表示 ✅ 解決済み

**決定事項**: 表示される
- 施設の求人管理一覧にオファー求人も表示
- フィルタで「オファー」を選択して絞り込み可能

### Q20. バッチ処理のログ・監査 ✅ 解決済み

**決定事項**: 推奨設定で実装
- 実行ログをDBに記録（日時、対象求人ID、結果）
- システム管理画面でログ確認可能
- 保持期間90日

### Q21. オファーメッセージの送信先 ✅ 解決済み

**決定事項**: 既存のメッセージスレッドを使用
- オファー対象は「勤務済み（レビュー完了）ワーカー」のみ
- レビュー完了ワーカーは必ず過去のマッチング（application）が存在する
- そのapplicationに紐づくメッセージスレッドを使用してオファーメッセージを送信

### Q22. オファー自動削除バッチ ✅ 解決済み

**決定事項**: 限定求人切り替えバッチと同じタイミングで実行
- 実行時刻: 毎日0時（JST）
- 処理: 募集終了日時を過ぎたオファーを物理削除
- エラーハンドリング: リトライ3回、失敗時メール通知
- ログ: 削除したオファー数を記録

### Q23. 施設向け通知テンプレート ✅ 解決済み

**決定事項**: ワーカー向けと同じ仕組みで追加
- `notification_settings`テーブルに`FACILITY_OFFER_ACCEPTED`タイプを追加
- ワーカー向けと同じUI・管理方法を使用
- 初期値: デフォルトON（通知する）

### Q24. 限定求人の対象者判定 ✅ 解決済み

**決定事項**: 問題なし
- 「施設で働いたことのある人が見える」という仕様で正しい
- 勤務済み（レビュー完了）のワーカーが対象

### Q25. オファーボタン表示条件 ✅ 解決済み

**決定事項**: 1回でも勤務（レビュー完了まで）すれば表示
- 過去に1回でも`completed_rated`ステータスになったワーカー
- 回数制限なし

### Q26. 子求人のカラム継承ルール ✅ 解決済み

**決定事項**: 親求人のほぼ全カラムをコピー
- コピー: title, description, location, wage, hourly_wage, required_qualifications, notes, break_minutes, image_url, facility_id
- 変更: job_type→NORMAL, visibility→PUBLIC
- 設定: parent_job_id→親求人のID
- NULL: target_worker_id, offer_message, switch_to_normal_days_before
- JobWorkDate: 該当日のレコードのみコピー

### Q27. 限定→通常切り替え後のバッジ ✅ 解決済み

**決定事項**: バッジは消える
- 切り替え後は通常求人として扱われるため「限定」バッジは表示されない

### Q28. オファー作成時に使用するapplicationの特定方法 ✅ 解決済み

**決定事項**: メッセージスレッドの設計変更
- メッセージスレッド自体は「ワーカーID × 施設ID」で一意に決まるようにする
- メッセージの各発言に対して、その時の`application_id`をオプションで持たせる
- これにより、どの勤務に関する会話かが明確になる

### Q29. オファー受諾後のapplication作成 ✅ 解決済み

**決定事項**: オファー時に新規application作成

**オファー作成時の処理:**
1. 施設がワーカーにオファーを出す
2. この時点で`application`レコードを新規作成（ステータス: `OFFERING`）
3. この`application_id`をメッセージに紐付けて送信

**受諾（即マッチング）時の処理:**
1. 新しいapplicationは作成しない
2. 既存の（オファー時に作った）applicationレコードのステータスを`MATCHED`に更新

**理由**: 過去のマッチング用applicationを使い回すと、給与計算・評価・キャンセル処理が混ざる問題が発生

### Q30. 限定求人の募集終了日時 ✅ 解決済み

**決定事項**: 通常求人と同じ
- `JobWorkDate.deadline`で設定（通常求人と同じUI）

### Q31. オファー作成画面での日程選択 ✅ 解決済み

**決定事項**: 複数日程を設定可能
- 通常の求人作成と同様に複数日程を選択できる
- 受諾時は全日程がまとめてマッチング成立（部分受諾は不可）
- UI: 通常の求人作成と同じ日程選択UI

### Q32. 子求人の`requires_interview` ✅ 解決済み

**決定事項**: 常に`false`（即マッチング継続）
- 仕様書セクション9に記載済み「`requires_interview`は`false`のまま維持」と一貫

### Q33. 限定求人の公開タイミング ✅ 解決済み・実装完了

**決定事項**: 通常求人と同じ
- 募集開始日時（`visible_from`）で公開される

**実装詳細**:
- DBカラム: `JobWorkDate.visible_from` (DateTime, nullable)
- 計算ロジック:
  - 「公開時」（recruitmentStartDay=0）: `visible_from = null`（即公開）
  - 「勤務当日」（recruitmentStartDay=-1）: `visible_from = 勤務日 00:00:00`
  - 「勤務N日前」（recruitmentStartDay=-N-1）: `visible_from = 勤務日 - N日 + 指定時刻`
- フィルタリング: `visible_from IS NULL OR visible_from <= NOW()`

### Q34. オファーの公開ステータス ✅ 解決済み・実装完了

**決定事項**: 通常求人と同じ
- 募集開始日時（`visible_from`）で公開される
- ステータス: DRAFT/PUBLISHED/STOPPED/WORKING/COMPLETED

**実装詳細**:
- オファーも同じ`visible_from`ロジックを使用
- 作成時に`visible_from`が計算・保存される
- 求人一覧表示時に`visible_from`でフィルタリングされる

### Q35. 限定求人（勤務済み）の過去勤務の範囲 ✅ 解決済み

**決定事項**: 期間の制限なし
- 5年前に1回だけ勤務したワーカーも対象

### Q36. バッチ処理のタイムゾーン ✅ 解決済み

**決定事項**: 既存のcron処理と同じ方式
- 既存の`/api/cron/update-statuses`と同様の実装
- サーバー時刻（`new Date()`）を使用

### Q37. 子求人切り出し後の親求人の状態 ✅ 解決済み

**決定事項**: 親求人から該当日を削除
- 例: 12/20,21,22,23の親求人から20日を切り出し → 親求人は12/21,22,23となる
- 全日程を切り出した場合: 親求人を削除（問題があれば非表示フラグで対応）

---

## 調査結果

### ✅ 子求人の募集終了日時（調査完了）

**調査内容**: 現在の子求人（JobWorkDate）に募集終了日時が設定されているか

**結果**: **既に存在する** ✅

現在のDBスキーマ（`JobWorkDate`モデル）:
- `deadline`: 募集終了日時（DateTime） ✅
- `visible_until`: 表示期限（DateTime） ✅
- `work_date`: 勤務日
- `recruitment_count`: 募集人数

**結論**:
- 子求人（日程ごと）に既に`deadline`カラムが存在
- 切り出し時は既存の`deadline`をそのまま使用可能
- **追加対応不要**

---

### Q38. オファー状態の管理方法 ✅ 解決済み

**決定事項**: オファー状態はJobStatus enumで管理（WorkerStatusには追加しない）

**理由**:
- 複数日程オファーの場合、Applicationは受諾時に初めて作成される
- オファー提示中はApplicationが存在しないため、WorkerStatusで管理できない
- Jobのstatus（DRAFT/PUBLISHED）でオファーの有効性を管理

**オファーの状態管理**:
```
Job (type: OFFER)
├─ status: DRAFT      → オファー下書き
├─ status: PUBLISHED  → オファー提示中（ワーカー未応答）
├─ status: WORKING    → 受諾済み（マッチング成立）
├─ status: COMPLETED  → 全日程完了
├─ status: CANCELLED  → 施設がキャンセル
└─ status: STOPPED    → 期限切れ（自動バッチで更新）
```

**受諾時の処理**:
1. 各JobWorkDateに対してApplicationを作成（status: SCHEDULED）
2. Jobのstatusを`WORKING`に更新

**期限切れの処理**:
1. バッチでJob.statusを`STOPPED`に更新
2. Jobは削除しない（履歴として残す）

**アナリティクス**:
- オファー承諾率 = WORKING or COMPLETEDに遷移したオファー数 / 全オファー数
- オファー期限切れ率 = STOPPEDに遷移したオファー数 / 全オファー数

### Q39. オファー拒否・期限切れのハンドリング ✅ 解決済み

**決定事項**: 明示的な辞退ボタンなし、期限切れは自動処理、施設キャンセルは可能

```
オファー状態遷移（完全版）:
  OFFERING → 受諾 → SCHEDULED → ... → COMPLETED_RATED
           → ワーカー無視 → 期限切れ → OFFER_EXPIRED（自動バッチ）
           → 施設がキャンセル → CANCELLED（cancelled_by: FACILITY）
```

**UI/UX設計**:
- ワーカー側: 「オファーを受ける」ボタンのみ表示（辞退ボタンなし）
- 施設側: オファーのキャンセルは可能（通常のキャンセルフローで処理）
- 期限が近づいたらプッシュ通知で促す（72時間前、24時間前）
- 期限切れ後は「期限切れ」として履歴に残す（メッセージ履歴は維持）

**ワーカーがキャンセルしたい場合**:
- ワーカーは施設にメッセージで連絡
- 施設側でキャンセル処理を実行

**理由**:
- 辞退ボタンがないことで、施設側に「拒否された」という明確なネガティブ感情を与えない
- 「期限切れ＝やんわりお断り」という日本的な文化に合致
- 施設側はキャンセル可能なので、ワーカーからの依頼にも対応可能

### Q40. 複数日程オファーのApplication数 ✅ 解決済み

**決定事項**: オファーは複数日程を設定可能

**仕組み**:
- 1オファー = 1 Job（複数JobWorkDates）
- オファー作成時: Applicationは作成しない（OFFERINGは求人レベルで管理）
- 受諾時: 全日程がマッチング成立、各日程ごとにApplicationを生成

**受諾時の処理フロー**:
```
1. ワーカーが「オファーを受ける」をクリック
2. 各JobWorkDateに対してApplicationレコードを作成（status: SCHEDULED）
3. JobのstatusをWORKINGに更新
4. 施設に通知
```

**Application構造**:
```
Job (type: OFFER)
├─ JobWorkDate (12/20) → Application (user_id, status: SCHEDULED)
├─ JobWorkDate (12/25) → Application (user_id, status: SCHEDULED)
└─ JobWorkDate (12/30) → Application (user_id, status: SCHEDULED)
```

**理由**:
- 施設が複数日程をまとめてオファーできる方が業務効率が良い
- 受諾は「全日程」単位（部分受諾は不可）
- 既存のApplication構造と整合性を保つ

### Q41. MessageThreadの設計変更 ✅ 解決済み

**決定事項**: 段階的マイグレーション（破壊的変更なし）

**Phase 1: 新モデル追加（既存に影響なし）**
```sql
CREATE TABLE message_threads (
  id SERIAL PRIMARY KEY,
  worker_id INTEGER NOT NULL REFERENCES users(id),
  facility_id INTEGER NOT NULL REFERENCES facilities(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(worker_id, facility_id)
);
```

**Phase 2: Message に thread_id を追加（nullable）**
```sql
ALTER TABLE messages ADD COLUMN thread_id INTEGER REFERENCES message_threads(id);
-- 既存メッセージは thread_id = null のまま動作継続
```

**Phase 3: 新規メッセージは thread_id を使用**
- オファーメッセージ: thread_id で送信
- 既存メッセージ: application_id で動作継続

**Phase 4（将来）**: 既存データを移行し、application_id を nullable に

**理由**:
- 既存の動作を壊さずに新機能を追加
- 漸進的マイグレーションで本番リスクを最小化

### Q42. 対象者0人の限定求人チェックタイミング ✅ 解決済み

**決定事項**: 作成画面でリアルタイム表示、0人で作成不可

**UI Flow**:
1. 「限定求人（勤務済み）」選択
2. 画面に「対象者: N人」をリアルタイム表示
3. 0人の場合: 作成ボタン無効化 + 説明メッセージ表示
   - 「現在、勤務済みのワーカーがいません。通常求人で作成してください。」

**理由**:
- エラーメッセージよりも事前に情報提供する方がUXが良い
- リアルタイムフィードバックで操作ミスを防止

### Q43. 限定→通常切り替え時の継続中Application ✅ 解決済み

**決定事項**: Applicationステータスは変更なし

**理由**:
- 既にマッチング成立したワーカーには影響させない
- 切り替えは「公開範囲の拡大」であり、既存契約の変更ではない

### Q44. 子求人の`visible_from`継承 ✅ 解決済み

**決定事項**: 子求人は`visible_from = null`（即公開）

**理由**:
- 切り出し時点で既に公開すべき状態
- 過去日のvisible_fromを設定する意味がない

### Q45. オファー重複チェックのスコープ ✅ 解決済み

**決定事項**: `同一ワーカー × 同一勤務日 × 同一施設 × アクティブなオファー`でチェック

**チェック条件**:
- target_worker_id が同じ
- 勤務日（JobWorkDate.work_date）が重複
- 同一施設から
- オファーがアクティブ（JobのstatusがDRAFT/PUBLISHED）

**許可されるケース**:
- 同じワーカーに異なる日程でオファー → OK
- 過去に期限切れになったオファーと同じ日程 → OK（新規オファー可能）
- 施設がオファーをキャンセルした後 → OK（新規オファー可能）
- 施設がオファーを削除した後 → OK（新規オファー可能）

**再オファー可能になる条件**:
1. オファーが期限切れ（OFFER_EXPIRED）
2. 施設がオファーをキャンセル（CANCELLED）
3. 施設がオファーを削除（物理削除）
4. ワーカーが受諾してマッチング成立後、キャンセルされた場合

### Q46. オファーテンプレートのデフォルト作成 ✅ 解決済み

**決定事項**: 初回オファー作成時にモーダルでガイド

**UI Flow**:
```
初回オファー作成時:
  「オファーメッセージのテンプレートを保存しますか？」
  [保存する] [今回は保存しない]
```

**理由**:
- デフォルトテンプレートは汎用的すぎて使われないことが多い
- 自分で作った方が活用率が高い

### Q47. 説明会のカウント表示 ✅ 解決済み

**決定事項**: フィルター選択肢には件数を表示

```
ドロップダウン:
  すべて (15)
  通常求人 (10)
  限定 (3)
  オファー (2)
  説明会 (5)  ← 説明会も件数表示
```

**理由**: 一貫性のあるUI

### Q48. バッチ処理失敗時の通知先 ✅ 解決済み

**決定事項**: `notification_settings`に`SYSTEM_ADMIN`向け設定を追加

```
notification_key: BATCH_JOB_SWITCH_FAILED
target_type: SYSTEM_ADMIN
email_enabled: true
dashboard_enabled: true
```

**通知先**:
- システム管理者全員（role: super_admin）
- または専用の通知先メールアドレスをenv変数で設定（`BATCH_ERROR_NOTIFY_EMAIL`）

### Q49. 子求人の`recruitment_count` ✅ 解決済み

**決定事項**: 親求人から継承（同じ値をコピー）

**理由**:
- 切り出された日程の募集人数は親と同じ
- 切り出し後に施設が編集したい場合は手動で変更可能

### Q50. オファーの`deadline` vs `visible_until` ✅ 解決済み

**決定事項**: オファーは`deadline`のみ使用、`visible_until`はnull

**オファーの特性**:
- 特定ワーカー1人専用
- 「いつまで見えるか」ではなく「いつまでに応答すべきか」

**運用**:
- deadline = オファー有効期限（受諾期限）
- visible_until = null（期限切れ時にバッチで削除）
