generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int            @id @default(autoincrement())
  email                  String         @unique
  password_hash          String         @map("password_hash")
  name                   String
  birth_date             DateTime?      @map("birth_date")
  phone_number           String         @map("phone_number")
  profile_image          String?        @map("profile_image")
  qualifications         String[]
  created_at             DateTime       @default(now()) @map("created_at")
  updated_at             DateTime       @updatedAt @map("updated_at")
  last_name_kana         String?        @map("last_name_kana")
  first_name_kana        String?        @map("first_name_kana")
  gender                 String?
  nationality            String?
  postal_code            String?        @map("postal_code")
  prefecture             String?
  city                   String?
  address_line           String?        @map("address_line")
  building               String?
  /// ワーカー住所の緯度（距離検索用）
  lat                    Float?
  /// ワーカー住所の経度（距離検索用）
  lng                    Float?
  emergency_name         String?        @map("emergency_name")
  emergency_relation     String?        @map("emergency_relation")
  emergency_phone        String?        @map("emergency_phone")
  emergency_address      String?        @map("emergency_address")
  current_work_style     String?        @map("current_work_style")
  desired_work_style     String?        @map("desired_work_style")
  job_change_desire      String?        @map("job_change_desire")
  desired_work_days_week String?        @map("desired_work_days_week")
  desired_work_period    String?        @map("desired_work_period")
  desired_work_days      String[]       @default([]) @map("desired_work_days")
  desired_start_time     String?        @map("desired_start_time")
  desired_end_time       String?        @map("desired_end_time")
  experience_fields      Json?          @map("experience_fields")
  work_histories         String[]       @default([]) @map("work_histories")
  self_pr                String?        @map("self_pr")
  bank_name              String?        @map("bank_name")
  branch_name            String?        @map("branch_name")
  account_name           String?        @map("account_name")
  account_number         String?        @map("account_number")
  pension_number         String?        @map("pension_number")
  id_document            String?        @map("id_document")
  bank_book_image        String?        @map("bank_book_image")
  qualification_certificates Json?      @map("qualification_certificates")
  applications           Application[]
  bookmarkedBy           Bookmark[]     @relation("BookmarkedUsers")
  bookmarks              Bookmark[]     @relation("UserBookmarks")
  sentMessages           Message[]      @relation("UserSentMessages")
  receivedMessages       Message[]      @relation("UserReceivedMessages")
  notifications          Notification[]
  reviews                Review[]
  pushSubscriptions      PushSubscription[]
  is_suspended           Boolean        @default(false) @map("is_suspended")
  suspended_at           DateTime?      @map("suspended_at")
  /// 退会日時（nullなら退会していない）
  deleted_at             DateTime?      @map("deleted_at")
  /// 退会理由
  delete_reason          String?        @map("delete_reason")

  @@map("users")
}

model FacilityAdmin {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String   @map("password_hash")
  facility_id   Int      @map("facility_id")
  name          String
  phone_number  String?  @map("phone_number")
  role          String   @default("admin")
  is_primary    Boolean  @default(false) @map("is_primary")
  created_at    DateTime @default(now()) @map("created_at")
  updated_at    DateTime @updatedAt @map("updated_at")
  facility      Facility @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  pushSubscriptions  PushSubscription[]

  @@map("facility_admins")
}

model Facility {
  id               Int              @id @default(autoincrement())
  corporation_name String           @map("corporation_name")
  facility_name    String           @map("facility_name")
  facility_type    String           @map("facility_type")
  address          String?
  prefecture       String?
  city             String?
  address_line     String?   @map("address_line")
  lat              Float     @default(0)
  lng              Float     @default(0)
  phone_number     String?          @map("phone_number")
  description      String?
  images           String[]
  map_image        String?          @map("map_image")
  rating           Float            @default(0)
  review_count     Int              @default(0) @map("review_count")
  initial_message  String?          @map("initial_message")
  created_at       DateTime         @default(now()) @map("created_at")
  updated_at       DateTime         @updatedAt @map("updated_at")

  // ========== 以下を追加 ==========
  // システムテンプレート（初期値設定）
  systemTemplates  SystemTemplate[]

  // 法人情報
  representative_last_name   String?   @map("representative_last_name")
  representative_first_name  String?   @map("representative_first_name")
  address_detail             String?   @map("address_detail")
  email                      String?
  contact_person_last_name   String?   @map("contact_person_last_name")
  contact_person_first_name  String?   @map("contact_person_first_name")

  // 責任者情報
  manager_last_name          String?   @map("manager_last_name")
  manager_first_name         String?   @map("manager_first_name")
  manager_photo              String?   @map("manager_photo")
  manager_greeting           String?   @map("manager_greeting")

  // 担当者情報
  staff_same_as_manager      Boolean   @default(false) @map("staff_same_as_manager")
  staff_last_name            String?   @map("staff_last_name")
  staff_first_name           String?   @map("staff_first_name")
  staff_phone                String?   @map("staff_phone")
  emergency_contact          String?   @map("emergency_contact")
  staff_emails               String[]  @default([]) @map("staff_emails")

  // アクセス情報
  stations                   Json?     // [{ name: string, minutes: number }]
  access_description         String?   @map("access_description")
  transportation             String[]  @default([])
  parking                    String?
  transportation_note        String?   @map("transportation_note")

  // 服装情報
  dresscode_items            String[]  @default([]) @map("dresscode_items")
  dresscode_images           String[]  @default([]) @map("dresscode_images")

  // 喫煙情報
  smoking_measure            String?   @map("smoking_measure")
  work_in_smoking_area       String?   @map("work_in_smoking_area")

  // ========== 追加ここまで ==========
  bookmarks        Bookmark[]       @relation("FacilityOwners")
  bookmarkedBy     Bookmark[]       @relation("BookmarkedFacilities")
  admins           FacilityAdmin[]
  jobTemplates     JobTemplate[]
  jobs             Job[]
  sentMessages     Message[]        @relation("FacilitySentMessages")
  receivedMessages Message[]        @relation("FacilityReceivedMessages")
  reviewTemplates  ReviewTemplate[]
  reviews          Review[]
  /// 退会日時（nullなら退会していない）
  deleted_at       DateTime?        @map("deleted_at")
  /// 退会理由
  delete_reason    String?          @map("delete_reason")
  /// 仮登録状態（true: 未完了、false: 正式登録済み）
  is_pending       Boolean          @default(false) @map("is_pending")

  @@map("facilities")
}

model JobTemplate {
  id                 Int      @id @default(autoincrement())
  facility_id        Int      @map("facility_id")
  name               String
  title              String
  start_time         String   @map("start_time")
  end_time           String   @map("end_time")
  break_time         Int      @map("break_time")
  hourly_wage        Int      @map("hourly_wage")
  transportation_fee Int      @map("transportation_fee")
  recruitment_count  Int      @map("recruitment_count")
  qualifications     String[]
  work_content       String[] @map("work_content")
  description        String
  skills             String[]
  dresscode          String[]
  belongings         String[]
  images             String[]
  dresscode_images   String[] @map("dresscode_images")
  attachments        String[]
  notes              String?
  tags               String[]
  /// 解雇の事由（労働条件通知書用、nullの場合はデフォルト文言を使用）
  dismissal_reasons  String?  @map("dismissal_reasons")
  created_at         DateTime @default(now()) @map("created_at")
  updated_at         DateTime @updatedAt @map("updated_at")
  facility           Facility @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  jobs               Job[]

  @@map("job_templates")
}

model Job {
  id                      Int           @id @default(autoincrement())
  facility_id             Int           @map("facility_id")
  template_id             Int?          @map("template_id")
  status                  JobStatus     @default(DRAFT)
  title                   String
  start_time              String        @map("start_time")
  end_time                String        @map("end_time")
  break_time              String        @map("break_time")
  wage                    Int
  hourly_wage             Int           @map("hourly_wage")
  transportation_fee      Int           @map("transportation_fee")
  deadline_days_before    Int           @default(1) @map("deadline_days_before")
  tags                    String[]
  address                 String?
  prefecture              String?
  city                    String?
  address_line            String?       @map("address_line")
  access                  String
  recruitment_count       Int           @map("recruitment_count")
  overview                String
  work_content            String[]      @map("work_content")
  required_qualifications String[]      @map("required_qualifications")
  required_experience     String[]      @map("required_experience")
  dresscode               String[]
  dresscode_images        String[]      @map("dresscode_images")
  belongings              String[]
  attachments             String[]
  manager_name            String        @map("manager_name")
  manager_message         String?       @map("manager_message")
  manager_avatar          String?       @map("manager_avatar")
  images                  String[]
  /// 未経験者歓迎
  inexperienced_ok        Boolean       @default(false) @map("inexperienced_ok")
  /// ブランク歓迎
  blank_ok                Boolean       @default(false) @map("blank_ok")
  /// 髪型・髪色自由
  hair_style_free         Boolean       @default(false) @map("hair_style_free")
  /// ネイルOK
  nail_ok                 Boolean       @default(false) @map("nail_ok")
  /// 制服貸与
  uniform_provided        Boolean       @default(false) @map("uniform_provided")
  /// 車通勤OK
  allow_car               Boolean       @default(false) @map("allow_car")
  /// 食事補助
  meal_support            Boolean       @default(false) @map("meal_support")
  /// 週N回以上勤務（2, 3, 4など。nullの場合は条件なし）
  weekly_frequency        Int?          @map("weekly_frequency")
  /// 1ヶ月以上勤務できる人を募集
  monthly_commitment      Boolean       @default(false) @map("monthly_commitment")
  /// 面接してからマッチング（true: 応募後に施設が手動でマッチング決定、false: 即時マッチング）
  requires_interview      Boolean       @default(false) @map("requires_interview")
  created_at              DateTime      @default(now()) @map("created_at")
  updated_at              DateTime      @updatedAt @map("updated_at")
  bookmarks               Bookmark[]
  workDates               JobWorkDate[]
  facility                Facility      @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  template                JobTemplate?  @relation(fields: [template_id], references: [id])
  messages                Message[]
  reviews                 Review[]

  @@map("jobs")
}

model JobWorkDate {
  id                Int           @id @default(autoincrement())
  job_id            Int           @map("job_id")
  work_date         DateTime      @map("work_date")
  deadline          DateTime
  recruitment_count Int           @map("recruitment_count")
  applied_count     Int           @default(0) @map("applied_count")
  created_at        DateTime      @default(now()) @map("created_at")
  updated_at        DateTime      @updatedAt @map("updated_at")
  matched_count     Int           @default(0) @map("matched_count")
  applications      Application[]
  job               Job           @relation(fields: [job_id], references: [id], onDelete: Cascade)
  reviews           Review[]

  @@unique([job_id, work_date])
  @@map("job_work_dates")
}

model Application {
  id                     Int            @id @default(autoincrement())
  work_date_id           Int            @map("work_date_id")
  user_id                Int            @map("user_id")
  status                 WorkerStatus   @default(APPLIED)
  worker_review_status   ReviewStatus   @default(PENDING) @map("worker_review_status")
  facility_review_status ReviewStatus   @default(PENDING) @map("facility_review_status")
  message                String?
  /// キャンセル実行者（WORKER: ワーカー、FACILITY: 施設）
  cancelled_by           CancelledBy?   @map("cancelled_by")
  /// 施設キャンセル通知の既読日時（nullなら未読）
  cancel_notified_at     DateTime?      @map("cancel_notified_at")
  created_at             DateTime       @default(now()) @map("created_at")
  updated_at             DateTime       @updatedAt @map("updated_at")
  user                   User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  workDate               JobWorkDate    @relation(fields: [work_date_id], references: [id], onDelete: Cascade)
  messages               Message[]
  reviews                Review[]
  laborDocument          LaborDocument?

  @@unique([work_date_id, user_id])
  @@map("applications")
}

/// 労働条件通知書データ（マッチング時に生成）
model LaborDocument {
  id               Int         @id @default(autoincrement())
  application_id   Int         @unique @map("application_id")
  /// 労働条件通知書のデータをJSONで保存（PDF生成用）
  document_data    Json        @map("document_data")
  /// PDF生成済みフラグ
  pdf_generated    Boolean     @default(false) @map("pdf_generated")
  /// PDFファイルパス（生成済みの場合）
  pdf_path         String?     @map("pdf_path")
  /// チャット送信済みフラグ
  sent_to_chat     Boolean     @default(false) @map("sent_to_chat")
  /// チャット送信日時
  sent_at          DateTime?   @map("sent_at")
  created_at       DateTime    @default(now()) @map("created_at")
  updated_at       DateTime    @updatedAt @map("updated_at")
  application      Application @relation(fields: [application_id], references: [id], onDelete: Cascade)

  @@map("labor_documents")
}

/// 労働条件通知書ダウンロードトークン
model LaborDocumentDownloadToken {
  id                      Int      @id @default(autoincrement())
  token                   String   @unique
  /// リクエストした施設管理者のID
  facility_admin_id       Int      @map("facility_admin_id")
  /// 対象ワーカーのID
  worker_id               Int      @map("worker_id")
  /// 対象施設のID
  facility_id             Int      @map("facility_id")
  /// 対象期間（開始）
  start_date              DateTime @map("start_date")
  /// 対象期間（終了）
  end_date                DateTime @map("end_date")
  /// 資格証明書を含むか
  include_qualifications  Boolean  @default(false) @map("include_qualifications")
  /// 送信先メールアドレス
  email                   String
  /// 有効期限（72時間）
  expires_at              DateTime @map("expires_at")
  /// ダウンロード済みフラグ
  downloaded              Boolean  @default(false)
  /// ダウンロード日時
  downloaded_at           DateTime? @map("downloaded_at")
  /// ZIPファイルパス（生成済みの場合）
  zip_path                String?  @map("zip_path")
  /// 処理状態（PENDING: 処理中, COMPLETED: 完了, FAILED: 失敗）
  status                  String   @default("PENDING")
  /// エラーメッセージ（失敗時）
  error_message           String?  @map("error_message")
  created_at              DateTime @default(now()) @map("created_at")
  updated_at              DateTime @updatedAt @map("updated_at")

  @@map("labor_document_download_tokens")
}

model Review {
  id                   Int          @id @default(autoincrement())
  facility_id          Int          @map("facility_id")
  user_id              Int          @map("user_id")
  job_id               Int          @map("job_id")
  work_date_id         Int?         @map("work_date_id")
  application_id       Int?         @map("application_id")
  reviewer_type        ReviewerType @map("reviewer_type")
  rating               Int
  rating_attendance    Int?         @map("rating_attendance")
  rating_skill         Int?         @map("rating_skill")
  rating_execution     Int?         @map("rating_execution")
  rating_communication Int?         @map("rating_communication")
  rating_attitude      Int?         @map("rating_attitude")
  good_points          String?      @map("good_points")
  improvements         String?
  created_at           DateTime     @default(now()) @map("created_at")
  updated_at           DateTime     @updatedAt @map("updated_at")
  application          Application? @relation(fields: [application_id], references: [id], onDelete: Cascade)
  facility             Facility     @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  job                  Job          @relation(fields: [job_id], references: [id], onDelete: Cascade)
  user                 User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  workDate             JobWorkDate? @relation(fields: [work_date_id], references: [id], onDelete: Cascade)

  @@unique([job_id, user_id, reviewer_type])
  @@map("reviews")
}

model ReviewTemplate {
  id          Int      @id @default(autoincrement())
  facility_id Int      @map("facility_id")
  name        String
  content     String
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  facility    Facility @relation(fields: [facility_id], references: [id], onDelete: Cascade)

  @@map("review_templates")
}

model Bookmark {
  id                 Int          @id @default(autoincrement())
  type               BookmarkType
  created_at         DateTime     @default(now()) @map("created_at")
  user_id            Int?         @map("user_id")
  facility_id        Int?         @map("facility_id")
  target_job_id      Int?         @map("target_job_id")
  target_user_id     Int?         @map("target_user_id")
  target_facility_id Int?         @map("target_facility_id")
  facility           Facility?    @relation("FacilityOwners", fields: [facility_id], references: [id], onDelete: Cascade)
  targetFacility     Facility?    @relation("BookmarkedFacilities", fields: [target_facility_id], references: [id], onDelete: Cascade)
  targetJob          Job?         @relation(fields: [target_job_id], references: [id], onDelete: Cascade)
  targetUser         User?        @relation("BookmarkedUsers", fields: [target_user_id], references: [id], onDelete: Cascade)
  user               User?        @relation("UserBookmarks", fields: [user_id], references: [id], onDelete: Cascade)

  @@map("bookmarks")
}

model Message {
  id               Int         @id @default(autoincrement())
  from_user_id     Int?        @map("from_user_id")
  to_user_id       Int?        @map("to_user_id")
  from_facility_id Int?        @map("from_facility_id")
  to_facility_id   Int?        @map("to_facility_id")
  application_id   Int         @map("application_id")
  job_id           Int         @map("job_id")
  content          String
  read_at          DateTime?   @map("read_at")
  created_at       DateTime    @default(now()) @map("created_at")
  application      Application @relation(fields: [application_id], references: [id], onDelete: Cascade)
  fromFacility     Facility?   @relation("FacilitySentMessages", fields: [from_facility_id], references: [id], onDelete: Cascade)
  fromUser         User?       @relation("UserSentMessages", fields: [from_user_id], references: [id], onDelete: Cascade)
  job              Job         @relation(fields: [job_id], references: [id], onDelete: Cascade)
  toFacility       Facility?   @relation("FacilityReceivedMessages", fields: [to_facility_id], references: [id], onDelete: Cascade)
  toUser           User?       @relation("UserReceivedMessages", fields: [to_user_id], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Notification {
  id         Int              @id @default(autoincrement())
  user_id    Int              @map("user_id")
  type       NotificationType
  title      String
  message    String
  link       String?
  read       Boolean          @default(false)
  created_at DateTime         @default(now()) @map("created_at")
  user       User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum JobStatus {
  DRAFT
  PUBLISHED
  STOPPED
  WORKING
  COMPLETED
  CANCELLED

  @@map("job_status")
}

enum WorkerStatus {
  APPLIED
  SCHEDULED
  WORKING
  COMPLETED_PENDING
  COMPLETED_RATED
  CANCELLED

  @@map("worker_status")
}

enum ReviewStatus {
  PENDING
  COMPLETED

  @@map("review_status")
}

enum ReviewerType {
  WORKER
  FACILITY

  @@map("reviewer_type")
}

enum BookmarkType {
  FAVORITE
  WATCH_LATER

  @@map("bookmark_type")
}

enum NotificationType {
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  NEW_MESSAGE
  REVIEW_REQUEST
  SYSTEM
  APPLICATION_CANCELLED

  @@map("notification_type")
}

enum CancelledBy {
  WORKER
  FACILITY

  @@map("cancelled_by")
}

model SystemAdmin {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String
  name          String
  role          String   @default("admin") // "super_admin", "editor", etc.
  created_at    DateTime @default(now()) @map("created_at")
  updated_at    DateTime @updatedAt @map("updated_at")

  @@map("system_admins")
}

// ========== コンテンツ管理 ==========

/// FAQカテゴリ
model FaqCategory {
  id          Int      @id @default(autoincrement())
  target_type String   @map("target_type") // "WORKER" | "FACILITY"
  name        String
  sort_order  Int      @default(0) @map("sort_order")
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  faqs        Faq[]

  @@map("faq_categories")
}

/// FAQ項目
model Faq {
  id           Int         @id @default(autoincrement())
  category_id  Int         @map("category_id")
  question     String
  answer       String      @db.Text
  sort_order   Int         @default(0) @map("sort_order")
  is_published Boolean     @default(true) @map("is_published")
  created_at   DateTime    @default(now()) @map("created_at")
  updated_at   DateTime    @updatedAt @map("updated_at")
  category     FaqCategory @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@map("faqs")
}

/// ご利用ガイドPDF
model UserGuide {
  id          Int      @id @default(autoincrement())
  target_type String   @map("target_type") // "FACILITY"（施設向けのみ）
  file_path   String   @map("file_path")
  file_name   String   @map("file_name")
  file_size   Int      @map("file_size")
  uploaded_by Int      @map("uploaded_by") // SystemAdmin ID
  created_at  DateTime @default(now()) @map("created_at")

  @@map("user_guides")
}

/// 利用規約・プライバシーポリシー
model LegalDocument {
  id           Int       @id @default(autoincrement())
  doc_type     String    @map("doc_type") // "TERMS" | "PRIVACY"
  target_type  String    @map("target_type") // "WORKER" | "FACILITY"
  content      String    @db.Text
  version      Int       @default(1)
  is_current   Boolean   @default(true) @map("is_current")
  published_at DateTime? @map("published_at")
  created_by   Int       @map("created_by") // SystemAdmin ID
  created_at   DateTime  @default(now()) @map("created_at")
  updated_at   DateTime  @updatedAt @map("updated_at")

  @@index([doc_type, target_type, is_current])
  @@map("legal_documents")
}

model SystemLog {
  id          Int      @id @default(autoincrement())
  admin_id    Int      @map("admin_id")
  action      String   // e.g., "LOGIN", "UPDATE_USER", "DELETE_JOB"
  target_type String   @map("target_type")   // "User", "Facility", "Job"
  target_id   Int?     @map("target_id")
  details     Json?
  created_at  DateTime @default(now()) @map("created_at")
  ip_address  String?  @map("ip_address")

  @@map("system_logs")
}

model Announcement {
  id          Int      @id @default(autoincrement())
  title       String
  content     String   @db.Text
  category    String   // "NEWS", "MAINTENANCE", "EVENT", "IMPORTANT"
  target_type String   @map("target_type")   // "WORKER", "FACILITY", "BOTH"
  published   Boolean  @default(false)
  published_at DateTime? @map("published_at")
  scheduled_at DateTime? @map("scheduled_at") // 予約公開日時（この時間になったら自動公開）
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // フィルター条件（JSON形式で保存）
  // ワーカー向け: { regionIds: [], ageRanges: [], genders: [], qualifications: [], selectAll: true/false }
  // 施設向け: { regionIds: [], facilityTypes: [], selectAll: true/false }
  filter_conditions Json? @map("filter_conditions")

  // リレーション
  recipients AnnouncementRecipient[]

  @@map("announcements")
}

/// お知らせ配信先（配信時にフィルター条件を満たすユーザー/施設を記録）
model AnnouncementRecipient {
  id              Int      @id @default(autoincrement())
  announcement_id Int      @map("announcement_id")
  recipient_type  String   @map("recipient_type") // "WORKER" | "FACILITY"
  recipient_id    Int      @map("recipient_id")   // User.id or Facility.id
  is_read         Boolean  @default(false) @map("is_read")
  read_at         DateTime? @map("read_at")
  created_at      DateTime @default(now()) @map("created_at")

  announcement Announcement @relation(fields: [announcement_id], references: [id], onDelete: Cascade)

  @@unique([announcement_id, recipient_type, recipient_id])
  @@index([recipient_type, recipient_id])
  @@map("announcement_recipients")
}

// ========== アナリティクス関連 ==========

/// 分析用地域マスタ
model AnalyticsRegion {
  id               Int      @id @default(autoincrement())
  name             String   // 表示名（例: "関東エリア"）
  prefecture_cities Json    @default("{}") @map("prefecture_cities") // { "東京都": [], "神奈川県": ["横浜市", "川崎市"] }
  created_at       DateTime @default(now()) @map("created_at")
  updated_at       DateTime @updatedAt @map("updated_at")

  @@map("analytics_regions")
}

/// 集計データキャッシュ（日次バッチ処理用）
model AnalyticsDailyCache {
  id          Int      @id @default(autoincrement())
  date        DateTime // 集計対象日
  metric_type String   @map("metric_type") // "worker", "facility", "matching"
  filter_key  String   @default("all") @map("filter_key") // フィルター条件のキー（"all", "age_20", "region_1" 等）
  data        Json     // 集計データ
  created_at  DateTime @default(now()) @map("created_at")

  @@unique([date, metric_type, filter_key])
  @@index([date, metric_type])
  @@map("analytics_daily_cache")
}

/// 登録離脱トラッキング（将来用）
model RegistrationTracking {
  id           Int       @id @default(autoincrement())
  session_id   String    @unique @map("session_id")
  user_type    String    @map("user_type") // "worker", "facility"
  started_at   DateTime  @map("started_at")
  completed_at DateTime? @map("completed_at")
  last_step    String?   @map("last_step") // 最後に完了したステップ
  created_at   DateTime  @default(now()) @map("created_at")

  @@map("registration_tracking")
}

/// 労働条件通知書テンプレート設定
// 労働条件通知書テンプレート設定
model LaborDocumentTemplate {
  id         Int      @id @default(autoincrement())
  
  // テンプレート本文（変数は {{変数名}} 形式で埋め込み）
  template_content String @db.Text @map("template_content")
  
  // スタイル設定
  accent_color    String  @default("#3B82F6") @map("accent_color")
  
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@map("labor_document_templates")
}

/// システムテンプレート管理（初期値・定型文）
model SystemTemplate {
  id          Int      @id @default(autoincrement())
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.VarChar(255)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // 施設とのリレーション（オプション：特定の施設に関連する場合など、現仕様では不要だが将来的な拡張のため）
  facility_id Int?     @map("facility_id")
  facility    Facility? @relation(fields: [facility_id], references: [id])

  @@map("system_templates")
}

// 仕事詳細フォーマット
model JobDescriptionFormat {
  id          Int      @id @default(autoincrement())
  label       String   // 例: "介護：日勤"
  content     String   @db.Text // テンプレート本文
  sort_order  Int      @default(0) // 表示順
  is_active   Boolean  @default(true) // 有効/無効
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("job_description_formats")
}

model PushSubscription {
  id         Int       @id @default(autoincrement())
  user_id    Int?      @map("user_id")
  admin_id   Int?      @map("admin_id")
  user_type  String    @map("user_type")  // "worker" | "facility_admin"
  endpoint   String    @unique
  p256dh     String
  auth       String
  user_agent String?   @map("user_agent")
  created_at DateTime  @default(now()) @map("created_at")
  updated_at DateTime  @updatedAt @map("updated_at")

  user       User?          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  admin      FacilityAdmin? @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}

// ========== 通知管理システム ==========

/// 通知設定（ON/OFF・テンプレート）
model NotificationSetting {
  id               Int      @id @default(autoincrement())
  notification_key String   @unique @map("notification_key")
  name             String
  description      String?
  target_type      String   @map("target_type") // "WORKER" | "FACILITY" | "SYSTEM_ADMIN"

  // チャンネル別ON/OFF
  chat_enabled     Boolean  @default(true) @map("chat_enabled")
  email_enabled    Boolean  @default(true) @map("email_enabled")
  push_enabled     Boolean  @default(true) @map("push_enabled")

  // チャット通知テンプレート
  chat_message     String?  @db.Text @map("chat_message")

  // メールテンプレート
  email_subject    String?  @map("email_subject")
  email_body       String?  @db.Text @map("email_body")

  // プッシュ通知テンプレート
  push_title       String?  @map("push_title")
  push_body        String?  @map("push_body")

  // アラート閾値設定（システム管理者向けアラート用）
  // JSON形式で閾値条件を保存
  // 例: {"avg_rating_threshold": 2.5, "consecutive_low_rating_count": 3, "low_rating_threshold": 2}
  // 例: {"cancel_rate_threshold": 30, "consecutive_cancel_count": 3}
  alert_thresholds Json?    @map("alert_thresholds")

  created_at       DateTime @default(now()) @map("created_at")
  updated_at       DateTime @updatedAt @map("updated_at")

  @@map("notification_settings")
}

/// 通知送信ログ（メールボックス確認用）
model NotificationLog {
  id                  Int      @id @default(autoincrement())
  notification_key    String   @map("notification_key")
  channel             String   // "CHAT" | "EMAIL" | "PUSH"
  target_type         String   @map("target_type") // "WORKER" | "FACILITY" | "SYSTEM_ADMIN"

  // 宛先
  recipient_id        Int      @map("recipient_id")
  recipient_name      String?  @map("recipient_name")
  recipient_email     String?  @map("recipient_email")

  // メール用
  from_address        String?  @map("from_address")
  to_addresses        String[] @default([]) @map("to_addresses")
  subject             String?
  body                String?  @db.Text

  // チャット用
  chat_application_id Int?     @map("chat_application_id")
  chat_message        String?  @db.Text @map("chat_message")

  // プッシュ用
  push_title          String?  @map("push_title")
  push_body           String?  @map("push_body")
  push_url            String?  @map("push_url")

  status              String   @default("SENT") // "SENT" | "FAILED"
  error_message       String?  @map("error_message")
  created_at          DateTime @default(now()) @map("created_at")

  @@index([target_type, created_at])
  @@index([notification_key])
  @@map("notification_logs")
}
