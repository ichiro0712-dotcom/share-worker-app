// Prisma Schema for S WORKS
// シェアワーカーアプリ - 看護師・介護士向け求人マッチングサービス
// 最終更新: 2025-11-27

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ワーカー（求職者）
// ========================================

model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  password_hash  String    @map("password_hash")
  name           String
  birth_date     DateTime? @map("birth_date")
  phone_number   String    @map("phone_number")
  profile_image  String?   @map("profile_image")
  qualifications String[]  // 資格情報（配列）
  created_at     DateTime  @default(now()) @map("created_at")
  updated_at     DateTime  @updatedAt @map("updated_at")

  // リレーション
  applications     Application[]
  reviews          Review[]
  bookmarks        Bookmark[]       @relation("UserBookmarks")
  bookmarkedBy     Bookmark[]       @relation("BookmarkedUsers")
  sentMessages     Message[]        @relation("UserSentMessages")
  receivedMessages Message[]        @relation("UserReceivedMessages")
  notifications    Notification[]

  @@map("users")
}

// ========================================
// 施設管理者
// ========================================

model FacilityAdmin {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  password_hash String   @map("password_hash")
  facility_id  Int      @map("facility_id")
  name         String
  phone_number String?  @map("phone_number")
  role         String   @default("admin")
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")

  // リレーション
  facility Facility @relation(fields: [facility_id], references: [id], onDelete: Cascade)

  @@map("facility_admins")
}

// ========================================
// 施設
// ========================================

model Facility {
  id               Int      @id @default(autoincrement())
  corporation_name String   @map("corporation_name") // 法人名
  facility_name    String   @map("facility_name")    // 施設名
  facility_type    String   @map("facility_type")    // 施設種別
  address          String
  lat              Float                              // 緯度
  lng              Float                              // 経度
  phone_number     String   @map("phone_number")
  description      String?  @db.Text
  images           String[] // 画像URL配列
  rating           Float    @default(0)               // 平均評価
  review_count     Int      @default(0) @map("review_count")

  // 初回メッセージ設定（マッチング時に自動送信）
  initial_message  String?  @db.Text @map("initial_message")

  created_at       DateTime @default(now()) @map("created_at")
  updated_at       DateTime @updatedAt @map("updated_at")

  // リレーション
  admins             FacilityAdmin[]
  jobs               Job[]
  jobTemplates       JobTemplate[]
  reviews            Review[]
  bookmarks          Bookmark[]       @relation("FacilityOwners")
  bookmarkedBy       Bookmark[]       @relation("BookmarkedFacilities")
  sentMessages       Message[]        @relation("FacilitySentMessages")
  receivedMessages   Message[]        @relation("FacilityReceivedMessages")

  @@map("facilities")
}

// ========================================
// 求人テンプレート（施設に紐づく）
// ========================================

model JobTemplate {
  id                 Int      @id @default(autoincrement())
  facility_id        Int      @map("facility_id")
  name               String   // テンプレート名
  title              String   // 求人タイトル
  start_time         String   @map("start_time")  // HH:MM
  end_time           String   @map("end_time")    // HH:MM
  break_time         Int      @map("break_time")  // 休憩時間（分）
  hourly_wage        Int      @map("hourly_wage") // 時給
  transportation_fee Int      @map("transportation_fee")
  recruitment_count  Int      @map("recruitment_count") // 募集人数
  qualifications     String[] // 必要資格（配列）
  work_content       String[] @map("work_content")      // 仕事内容（チェックボックス選択）
  description        String   @db.Text                  // 仕事内容（テキスト説明）
  skills             String[] // スキル・経験（5件まで）
  dresscode          String[] // 服装・身だしなみ（5件まで）
  belongings         String[] // 持ち物・その他（5件まで）
  images             String[] // デフォルト画像（求人作成時にコピーされる）
  dresscode_images   String[] @map("dresscode_images")  // 服装サンプル画像
  attachments        String[] // 添付ファイルURL
  notes              String?  @db.Text                  // 備考
  tags               String[]
  created_at         DateTime @default(now()) @map("created_at")
  updated_at         DateTime @updatedAt @map("updated_at")

  // リレーション
  facility Facility @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  jobs     Job[]

  @@map("job_templates")
}

// ========================================
// 求人
// ========================================

model Job {
  id                      Int       @id @default(autoincrement())
  facility_id             Int       @map("facility_id")
  template_id             Int?      @map("template_id")       // 使用したテンプレートID（任意）
  status                  JobStatus @default(DRAFT)           // 求人ステータス
  title                   String
  start_time              String    @map("start_time")        // HH:MM
  end_time                String    @map("end_time")          // HH:MM
  break_time              String    @map("break_time")        // 例: "12:00-13:00"
  wage                    Int                                 // 日給
  hourly_wage             Int       @map("hourly_wage")       // 時給
  transportation_fee      Int       @map("transportation_fee")
  deadline_days_before    Int       @default(1) @map("deadline_days_before") // 締切日（勤務日の何日前）
  tags                    String[]
  address                 String
  access                  String                              // アクセス方法
  recruitment_count       Int       @map("recruitment_count") // 募集人数（デフォルト値）
  overview                String    @db.Text                  // 仕事概要
  work_content            String[]  @map("work_content")      // 仕事内容（配列）
  required_qualifications String[]  @map("required_qualifications") // 必要資格
  required_experience     String[]  @map("required_experience")     // 必要経験
  dresscode               String[]                            // 服装
  dresscode_images        String[]  @map("dresscode_images")  // 服装サンプル画像
  belongings              String[]                            // 持ち物
  attachments             String[]                            // 添付ファイルURL
  manager_name            String    @map("manager_name")      // 責任者名
  manager_message         String?   @db.Text @map("manager_message") // 責任者メッセージ
  manager_avatar          String?   @map("manager_avatar")    // 責任者アバター
  images                  String[]                            // 施設画像

  // ========================================
  // 移動手段（通勤方法）
  // ========================================
  /// 車通勤可
  allow_car               Boolean   @default(false) @map("allow_car")
  /// バイク通勤可
  allow_bike              Boolean   @default(false) @map("allow_bike")
  /// 自転車通勤可
  allow_bicycle           Boolean   @default(false) @map("allow_bicycle")
  /// 公共交通機関（電車・バス・徒歩）可
  allow_public_transit    Boolean   @default(false) @map("allow_public_transit")
  /// 敷地内駐車場あり
  has_parking             Boolean   @default(false) @map("has_parking")

  // ========================================
  // こだわり条件
  // ========================================
  /// 入浴介助なし
  no_bathing_assist       Boolean   @default(false) @map("no_bathing_assist")
  /// 送迎ドライバーあり
  has_driver              Boolean   @default(false) @map("has_driver")
  /// 髪型・髪色自由
  hair_style_free         Boolean   @default(false) @map("hair_style_free")
  /// ネイルOK
  nail_ok                 Boolean   @default(false) @map("nail_ok")
  /// 制服貸与
  uniform_provided        Boolean   @default(false) @map("uniform_provided")
  /// 介護業務未経験歓迎
  inexperienced_ok        Boolean   @default(false) @map("inexperienced_ok")
  /// SWORK初心者歓迎
  beginner_ok             Boolean   @default(false) @map("beginner_ok")
  /// 施設オープン5年以内
  facility_within_5years  Boolean   @default(false) @map("facility_within_5years")

  // ========================================
  // 募集条件
  // ========================================
  /// 週N回以上勤務（2, 3, 4など。nullの場合は条件なし）
  weekly_frequency        Int?      @map("weekly_frequency")
  /// 1ヶ月以上勤務できる人を募集
  monthly_commitment      Boolean   @default(false) @map("monthly_commitment")

  created_at              DateTime  @default(now()) @map("created_at")
  updated_at              DateTime  @updatedAt @map("updated_at")

  // リレーション
  facility     Facility       @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  template     JobTemplate?   @relation(fields: [template_id], references: [id], onDelete: SetNull)
  workDates    JobWorkDate[]  // 複数の勤務日
  bookmarks    Bookmark[]
  messages     Message[]

  @@map("jobs")
}

// ========================================
// 求人の勤務日（Job と 1:N の関係）
// ========================================

model JobWorkDate {
  id                Int      @id @default(autoincrement())
  job_id            Int      @map("job_id")
  work_date         DateTime @map("work_date")         // 勤務日
  deadline          DateTime                            // 応募締切
  recruitment_count Int      @map("recruitment_count") // この日の募集人数
  applied_count     Int      @default(0) @map("applied_count") // この日の応募済み人数
  created_at        DateTime @default(now()) @map("created_at")
  updated_at        DateTime @updatedAt @map("updated_at")

  // リレーション
  job          Job           @relation(fields: [job_id], references: [id], onDelete: Cascade)
  applications Application[]
  reviews      Review[]

  @@unique([job_id, work_date])
  @@map("job_work_dates")
}

// 求人ステータスのEnum
enum JobStatus {
  DRAFT      // 下書き
  PUBLISHED  // 公開中
  STOPPED    // 停止中
  WORKING    // 勤務中
  COMPLETED  // 完了
  CANCELLED  // キャンセル

  @@map("job_status")
}

// ========================================
// 応募・マッチング
// ========================================

model Application {
  id                     Int          @id @default(autoincrement())
  work_date_id           Int          @map("work_date_id")  // JobWorkDateへの参照
  user_id                Int          @map("user_id")
  status                 WorkerStatus @default(APPLIED)
  worker_review_status   ReviewStatus @default(PENDING) @map("worker_review_status")   // ワーカー→施設の評価状態
  facility_review_status ReviewStatus @default(PENDING) @map("facility_review_status") // 施設→ワーカーの評価状態
  message                String?      @db.Text                                         // 応募時のメッセージ
  created_at             DateTime     @default(now()) @map("created_at")
  updated_at             DateTime     @updatedAt @map("updated_at")

  // リレーション
  workDate JobWorkDate @relation(fields: [work_date_id], references: [id], onDelete: Cascade)
  user     User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  reviews  Review[]
  messages Message[]

  @@unique([work_date_id, user_id]) // 同じ勤務日に同じユーザーは1回のみ応募可能
  @@map("applications")
}

// ワーカーステータスのEnum
enum WorkerStatus {
  APPLIED           // 応募（施設承認待ち）
  SCHEDULED         // 勤務予定（施設が承認済み）
  WORKING           // 勤務中
  COMPLETED_PENDING // 完了・評価待ち
  COMPLETED_RATED   // 評価完了
  CANCELLED         // キャンセル

  @@map("worker_status")
}

// 評価ステータスのEnum
enum ReviewStatus {
  PENDING   // 評価待ち
  COMPLETED // 評価完了

  @@map("review_status")
}

// ========================================
// レビュー（双方向評価システム）
// ========================================

model Review {
  id              Int          @id @default(autoincrement())
  facility_id     Int          @map("facility_id")
  user_id         Int          @map("user_id")
  work_date_id    Int          @map("work_date_id")  // JobWorkDateへの参照
  application_id  Int          @map("application_id")
  reviewer_type   ReviewerType @map("reviewer_type") // 誰が評価したか
  rating          Int                                // 1-5
  good_points     String?      @db.Text @map("good_points")
  improvements    String?      @db.Text
  created_at      DateTime     @default(now()) @map("created_at")
  updated_at      DateTime     @updatedAt @map("updated_at")

  // リレーション
  facility    Facility    @relation(fields: [facility_id], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  workDate    JobWorkDate @relation(fields: [work_date_id], references: [id], onDelete: Cascade)
  application Application @relation(fields: [application_id], references: [id], onDelete: Cascade)

  @@map("reviews")
}

// レビュアータイプのEnum
enum ReviewerType {
  WORKER   // ワーカーが施設を評価
  FACILITY // 施設がワーカーを評価

  @@map("reviewer_type")
}

// ========================================
// ブックマーク（お気に入り・あとで見る）
// ========================================

model Bookmark {
  id             Int          @id @default(autoincrement())
  type           BookmarkType // FAVORITE または WATCH_LATER
  created_at     DateTime     @default(now()) @map("created_at")

  // 誰が保存したか（どちらか片方が入る）
  user_id        Int?         @map("user_id")      // ワーカーID
  facility_id    Int?         @map("facility_id")  // 施設ID

  // 何を保存したか（いずれか1つが入る）
  target_job_id      Int?         @map("target_job_id")      // 保存対象：求人ID
  target_user_id     Int?         @map("target_user_id")     // 保存対象：ワーカーID
  target_facility_id Int?         @map("target_facility_id") // 保存対象：施設ID

  // リレーション
  user           User?     @relation("UserBookmarks", fields: [user_id], references: [id], onDelete: Cascade)
  facility       Facility? @relation("FacilityOwners", fields: [facility_id], references: [id], onDelete: Cascade)
  targetJob      Job?      @relation(fields: [target_job_id], references: [id], onDelete: Cascade)
  targetUser     User?     @relation("BookmarkedUsers", fields: [target_user_id], references: [id], onDelete: Cascade)
  targetFacility Facility? @relation("BookmarkedFacilities", fields: [target_facility_id], references: [id], onDelete: Cascade)

  @@map("bookmarks")
}

// ブックマークタイプのEnum
enum BookmarkType {
  FAVORITE    // お気に入り
  WATCH_LATER // あとで見る

  @@map("bookmark_type")
}

// ========================================
// メッセージ
// ========================================

model Message {
  id               Int       @id @default(autoincrement())
  from_user_id     Int?      @map("from_user_id")
  to_user_id       Int?      @map("to_user_id")
  from_facility_id Int?      @map("from_facility_id")
  to_facility_id   Int?      @map("to_facility_id")
  application_id   Int       @map("application_id") // どのマッチングに関するメッセージか
  job_id           Int       @map("job_id")         // どの求人に関するメッセージか
  content          String    @db.Text
  read_at          DateTime? @map("read_at")
  created_at       DateTime  @default(now()) @map("created_at")

  // リレーション
  fromUser     User?        @relation("UserSentMessages", fields: [from_user_id], references: [id], onDelete: Cascade)
  toUser       User?        @relation("UserReceivedMessages", fields: [to_user_id], references: [id], onDelete: Cascade)
  fromFacility Facility?    @relation("FacilitySentMessages", fields: [from_facility_id], references: [id], onDelete: Cascade)
  toFacility   Facility?    @relation("FacilityReceivedMessages", fields: [to_facility_id], references: [id], onDelete: Cascade)
  application  Application  @relation(fields: [application_id], references: [id], onDelete: Cascade)
  job          Job          @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@map("messages")
}

// ========================================
// 通知
// ========================================

model Notification {
  id         Int              @id @default(autoincrement())
  user_id    Int              @map("user_id")
  type       NotificationType
  title      String
  message    String           @db.Text
  link       String?
  read       Boolean          @default(false)
  created_at DateTime         @default(now()) @map("created_at")

  // リレーション
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// 通知タイプのEnum
enum NotificationType {
  APPLICATION_APPROVED  // 応募が承認された
  APPLICATION_REJECTED  // 応募が却下された
  NEW_MESSAGE           // 新しいメッセージ
  REVIEW_REQUEST        // レビュー依頼
  SYSTEM                // システム通知

  @@map("notification_type")
}
